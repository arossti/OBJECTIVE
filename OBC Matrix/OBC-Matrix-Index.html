<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2024 OBC Matrix Framework | Part 3</title>
    <meta
      name="description"
      content="Calculate Total Energy Use Intensity & Thermal Energy Demand Intensity for buildings"
    />

    <!-- CSS Resources -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Direct style override for select elements -->
    <style>
      select,
      option,
      .form-select,
      select.form-select {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif !important;
        /* Force sans-serif as fallback */
        font-family: sans-serif !important;
      }

      /* Notes Column Toggle Styles */
      .notes-column {
        transition: opacity 0.3s ease, width 0.3s ease;
      }

      /* Hide notes column when body has notes-hidden class */
      body.notes-hidden .notes-column {
        display: none;
      }

      /* Notes toggle button active state */
      #notes-toggle-btn.active {
        background-color: rgba(255,255,255,0.2);
      }

      /* Hide the separate notes panel - we're using column toggle instead */
      #global-notes-panel {
        display: none !important;
      }
    </style>

    <link href="OBC-styles.css" rel="stylesheet" />



    <!-- Core Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.4/dagre-d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

    <!-- Core Logic & Managers FIRST -->
    <!-- <script src="4011-AppendixE.js"></script> -->
    <!-- <script src="4011-StateManager.js"></script> -->
    <!-- <script src="4011-ReferenceValues.js"></script> -->
    <!-- <script src="4011-ReferenceManager.js"></script> -->
    <!-- <script src="4011-ReferenceToggle.js"></script> -->
    <script src="OBC-FieldManager.js"></script>
    <!-- FieldManager depends on StateManager -->
    <!-- <script src="4011-SectionIntegrator.js"></script> -->
    <!-- Integrator might depend on managers -->
    <!-- <script src="4011-Calculator.js"></script> -->
    <!-- Calculator logic -->
    <!-- <script src="4011-ComponentBridge.js"></script> -->
    <script src="OBC-ExcelMapper.js"></script>
    <script src="OBC-FileHandler.js"></script>
    <!-- <script src="4011-Dependency.js"></script> -->

    <!-- Initialize everything AFTER core scripts are loaded -->
    <script src="4011-init.js"></script>

    <!-- Section modules LAST (they depend on core managers/utils) -->
    <script src="sections/4011-Section01.js"></script>
    <script src="sections/4011-Section02.js"></script>
    <script src="sections/4011-Section03.js"></script>
    <!-- <script src="sections/4011-Section04.js"></script> -->
    <!-- <script src="sections/4011-Section05.js"></script> -->
    <!-- <script src="sections/4011-Section06.js"></script> -->
    <!-- <script src="sections/4011-Section07.js"></script> -->
    <!-- <script src="sections/4011-Section08.js"></script> -->
    <!-- <script src="sections/4011-Section09.js"></script> -->
    <!-- <script src="sections/4011-Section10.js"></script> -->
    <!-- <script src="sections/4011-Section11.js"></script> -->
    <!-- <script src="sections/4011-Section12.js"></script> -->
    <!-- <script src="sections/4011-Section13.js"></script> -->
    <!-- <script src="sections/4011-Section14.js"></script> -->
    <!-- <script src="sections/4011-Section15.js"></script> -->
    <!-- <script src="sections/4011-Section16.js"></script> -->
    <!-- <script src="sections/4011-Section17.js"></script> -->
    <!-- <script src="sections/4011-Section18.js"></script> -->
  </head>
  <body>
    <!-- Main container -->
    <div class="col-lg-12 mx-auto p-4 py-md-5">
      <!-- Header -->
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <a
          href="https://openbuilding.ca"
          class="text-dark text-decoration-none"
        >
          <img
            src="assets/image041.png"
            class="logo"
            title="OBJECTIVE Logo"
            alt="OBJECTIVE 4.011 TEUI Calculator"
          />
        </a>
        <div class="ms-auto text-end">
          <h1 class="mb-0 fs-4">
            2024 Ontario Building Code Data Matrix <br />
            Interactive Edition | v2025.06.05
          </h1>
        </div>
      </header>

      <!-- Action buttons row -->
      <div class="row button-row mb-2">
        <div class="col-12 text-end">
          <div
            class="col text-end controls-container d-flex align-items-center justify-content-end"
          >


            <button
              id="disclaimerBtn"
              class="btn btn-sm btn-warning me-2"
              data-bs-toggle="modal"
              data-bs-target="#disclaimerModal"
            >
              ⓘ Disclaimer
            </button>
            <button
              id="reset-imported-btn"
              type="button"
              class="btn btn-sm btn-success me-2"
            >
              <i class="bi bi-arrow-clockwise"></i> Reset
            </button>
            <div class="btn-group">
              <button
                id="downloadBtn"
                type="button"
                class="btn btn-sm btn-primary"
              >
                ↓ Import/Export
              </button>
              <!-- Dropdown Toggle -->
              <button
                class="btn btn-sm btn-primary dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <span class="visually-hidden">Toggle Dropdown</span>
              </button>
              <!-- Dropdown Menu -->
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#" id="import-data-btn"
                    ><i class="bi bi-upload me-2"></i>Import Data (Excel/CSV)</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="export-data-btn"
                    ><i class="bi bi-save me-2"></i>Export User Data (CSV)</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" id="downloadReport"
                    >Download Report (PDF)</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="teui-factsheet"
                    >TEUI Factsheet (PDF)</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="tedi-factsheet"
                    >TEDI Factsheet (PDF)</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" id="export-excel"
                    ><i class="bi bi-file-earmark-spreadsheet me-2"></i>Export
                    All Data (Excel)</a
                  >
                </li>
              </ul>
            </div>
          </div>
          <!-- Hidden File Input for Import -->
          <input
            type="file"
            id="excel-file-input"
            accept=".xlsx, .xls, .csv"
            style="display: none"
          />

        </div>
      </div>

      <!-- App wrapper - this is the new wrapper div -->
      <div id="app-wrapper">
        <!-- Calculator container -->
        <div id="calculator-container">
          <!-- The HTML for the Key Values section should be: -->
          <div id="buildingInfo" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-info-circle"></i></span>
              SECTION 1. Building Information
              <div class="ms-auto d-flex align-items-center">
                <div class="section-controls me-2">
                  <!-- Buttons moved out, only feedback-area and potentially applyExcelBtn remain here -->
                  <div class="excel-loader">
                    <button
                      type="button"
                      class="btn btn-outline-success btn-sm d-none"
                      id="applyExcelBtn"
                    >
                      <i class="bi bi-check-lg"></i> Apply Data
                    </button>
                    <span
                      id="feedback-area"
                      style="
                        color: #0dcaf0;
                        font-size: 0.9rem;
                        margin-left: 10px;
                      "
                    ></span>
                  </div>
                </div>
                <button
                  id="expand-collapse-all"
                  class="btn btn-sm btn-link text-white me-2"
                >
                  <i class="bi bi-plus-circle"></i>
                </button>
                <button
                  id="notes-toggle-btn"
                  class="btn btn-sm btn-link text-white me-2"
                  title="Toggle Notes Panel"
                >
                  <i class="bi bi-card-text"></i>
                </button>
                <button class="layout-toggle-btn">
                  <i class="bi bi-arrow-right-circle"></i>
                </button>
              </div>
            </div>
            <div class="section-content">
              <!-- Key Values content will be generated by FieldManager using Section01.js -->
              <div data-render-section="buildingInfo"></div>
            </div>
          </div>

          <!-- Spacer to maintain consistent gap - this prevents scrolling under Key Values -->
          <div class="tab-spacer"></div>

          <!-- Tab container for horizontal layout - positioned immediately after keyValues -->
          <div class="tab-container">
            <!-- Tabs will be generated by JavaScript -->
          </div>

          <!-- Section spacer to maintain proper distance between Key Values and active section -->
          <div id="section-spacer" class="section-spacer"></div>



          <!-- Section 2: Building Occupancy -->
          <div id="buildingOccupancy" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-building"></i></span>
              SECTION 2. Building Occupancy
            </div>
            <div class="section-content">
              <!-- Building Occupancy content will be generated by FieldManager using Section02.js -->
              <div data-render-section="buildingOccupancy"></div>
            </div>
          </div>

          <!-- Section 3: Building Areas -->
          <div id="buildingAreas" class="section">
            <div class="section-header">
              <span class="section-icon"
                ><i class="bi bi-bounding-box"></i
              ></span>
              SECTION 3. Building Areas
            </div>
            <div class="section-content">
              <!-- Building Areas content will be generated by FieldManager using Section03.js -->
              <div data-render-section="buildingAreas"></div>
            </div>
          </div>

          <!-- Section 4: Actual vs. Target Energy & Carbon -->
          <div id="actualTargetEnergy" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-bullseye"></i></span>
              SECTION 4. Actual vs. Target Energy & Carbon
            </div>
            <div class="section-content">
              <div data-render-section="actualTargetEnergy"></div>
            </div>
          </div>

          <!-- Section 5: CO2e Emissions -->
          <div id="emissions" class="section">
            <div class="section-header">
              <span class="section-icon"
                ><i class="bi bi-cloud-upload"></i
              ></span>
              SECTION 5. CO2e Emissions
            </div>
            <div class="section-content">
              <div data-render-section="emissions"></div>
            </div>
          </div>

          <!-- Section 6: Renewable Energy -->
          <div id="onSiteEnergy" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-sun"></i></span>
              SECTION 6. Renewable Energy
            </div>
            <div class="section-content">
              <div data-render-section="onSiteEnergy"></div>
            </div>
          </div>

          <!-- Section 7: Water Use -->
          <div id="waterUse" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-droplet"></i></span>
              SECTION 7. Water Use
            </div>
            <div class="section-content">
              <div data-render-section="waterUse"></div>
            </div>
          </div>

          <!-- Section 8: Indoor Air Quality -->
          <div id="indoorAirQuality" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-lungs"></i></span>
              SECTION 8. Indoor Air Quality
            </div>
            <div class="section-content">
              <div data-render-section="indoorAirQuality"></div>
            </div>
          </div>

          <!-- Section 9: Occupant + Internal Gains -->
          <div id="occupantInternalGains" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-cup-hot"></i></span>
              SECTION 9. Occupant + Internal Gains
            </div>
            <div class="section-content">
              <div data-render-section="occupantInternalGains"></div>
            </div>
          </div>

          <!-- Section 10: Radiant Gains -->
          <div id="envelopeRadiantGains" class="section">
            <div class="section-header">
              <span class="section-icon"
                ><i class="bi bi-box-arrow-in-down-right"></i
              ></span>
              SECTION 10. Radiant Gains
            </div>
            <div class="section-content">
              <div data-render-section="envelopeRadiantGains"></div>
            </div>
          </div>

          <!-- Section 11: Transmission Losses -->
          <div id="envelopeTransmissionLosses" class="section">
            <div class="section-header">
              <span class="section-icon"
                ><i class="bi bi-box-arrow-up-right"></i
              ></span>
              SECTION 11. Transmission Losses
            </div>
            <div class="section-content">
              <div data-render-section="envelopeTransmissionLosses"></div>
            </div>
          </div>

          <!-- Section 12: Volume and Surface Metrics -->
          <div id="volumeSurfaceMetrics" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-box"></i></span>
              SECTION 12. Volume and Surface Metrics
            </div>
            <div class="section-content">
              <div data-render-section="volumeSurfaceMetrics"></div>
            </div>
          </div>

          <!-- Section 13: Mechanical Loads -->
          <div id="mechanicalLoads" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-house-gear"></i></span>
              SECTION 13. Mechanical Loads
            </div>
            <div class="section-content">
              <div data-render-section="mechanicalLoads"></div>
            </div>
          </div>

          <!-- Section 14: TEDI & TELI -->
          <div id="tediSummary" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-fire"></i></span>
              SECTION 14. TEDI & TELI
            </div>
            <div class="section-content">
              <div data-render-section="tediSummary"></div>
            </div>
          </div>

          <!-- Section 15: TEUI -->
          <div id="teuiSummary" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-outlet"></i></span>
              SECTION 15. TEUI
            </div>
            <div class="section-content">
              <div data-render-section="teuiSummary"></div>
            </div>
          </div>

          <!-- Section 16: Sankey Diagram -->
          <div id="sankeyDiagram" class="section" data-section-id="section16">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-sliders2"></i></span>
              SECTION 16. Sankey Diagram
            </div>
            <div class="section-content">
              <!-- This is the target for Section16.js to inject its dynamic content -->
              <div id="section16ContentTarget" style="width: 100%"></div>
            </div>
          </div>

          <!-- Section 17: Dependency Graph -->
          <div id="dependencyDiagram" class="section">
            <div class="section-header">
              <span class="section-icon"><i class="bi bi-link-45deg"></i></span>
              SECTION 17. Dependency Graph
            </div>
            <div class="section-content">
              <!-- Containers for Dependency Graph Components -->
              <div class="dependency-graph-controls-wrapper mb-3"></div>
              <!-- Wrapper for filters/controls -->
              <div class="dependency-graph-info-wrapper mb-3"></div>
              <!-- Wrapper for info panel -->
              <div
                class="dependency-graph-container"
                style="height: 600px; width: 100%; border: 1px solid #eee"
              >
                <!-- SVG will be injected here by 4011-Dependency.js -->
              </div>
            </div>
          </div>

          <!-- Section 18: Notes -->
          <div id="notes" class="section">
            <div class="section-header">
              <span class="section-icon"
                ><i class="bi bi-info-square"></i
              ></span>
              SECTION 18. Notes
            </div>
            <div class="section-content">
              <div data-render-section="notes"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Global Notes Panel -->
      <div id="global-notes-panel" class="notes-panel" style="display: none;">
        <div class="notes-panel-header">
          <h5><i class="bi bi-card-text"></i> Project Notes</h5>
          <button id="close-notes-panel" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="notes-panel-content">
          <textarea 
            id="global-notes-textarea" 
            class="form-control" 
            rows="15" 
            placeholder="Enter project notes here...">
          </textarea>
        </div>
      </div>

      <!-- Footer -->
      <footer class="pt-5 mt-5 text-muted border-top">
        <div class="row">
          <div class="col-md-6">
            <p>
              Based on the framework by
              <a href="https://OpenBuilding.ca">OpenBuilding.ca</a> - Version
              4.011
            </p>
          </div>
          <div class="col-md-6 text-end">
            <p>TEUI 4.011 Calculator</p>
          </div>
        </div>
      </footer>
    </div>

    <!-- Modal for disclaimer -->
    <div
      class="modal fade"
      id="disclaimerModal"
      tabindex="-1"
      aria-labelledby="disclaimerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning bg-opacity-25">
            <h5 class="modal-title" id="disclaimerModalLabel">
              Using the OBC Matrix
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              This tool helps you complete the Ontario Building Code Data Matrix for building permit applications.
            </p>
            <p>
              Simply enter your information in the blue input fields. You can toggle between Part 3 (large buildings) and Part 9 (housing and small buildings) forms using the toggle switch at the top.
            </p>
            <p>
              When you're finished, you can export your data as a CSV file or download a completed PDF form.
            </p>
            <hr />
            <p>
              <strong>Disclaimer:</strong> This interactive OBC Matrix is provided as a convenience tool. While every effort has been made to ensure accuracy, the official Ontario Building Code and related regulations should always be consulted for definitive requirements. This form is not a substitute for professional engineering or architectural advice.
            </p>
            <p>
              © Ontario Association of Architects - Interactive version by OpenBuilding.ca
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              Got it
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Weather Data Modal -->
    <div
      class="modal fade"
      id="weatherDataModal"
      tabindex="-1"
      aria-labelledby="weatherDataModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="weatherDataModalLabel">Weather Data</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <pre
              id="weatherDataContent"
              class="bg-light p-3"
              style="max-height: 400px; overflow-y: auto"
            >
Select a province and city to view weather data.</pre
            >
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Global modal fix script -->
    <script>
      // Simplified fix for lingering modal backdrops
      document.addEventListener("DOMContentLoaded", function () {
        // This single event listener handles all modals, but only cleans up when needed
        document.body.addEventListener("hidden.bs.modal", function () {
          // Use a short timeout to ensure Bootstrap has completed its operations
          setTimeout(function () {
            // Only clean up if there are backdrops but no visible modals
            if (
              document.querySelectorAll(".modal-backdrop").length > 0 &&
              !document.querySelector(".modal.show")
            ) {
              console.log("Cleaning up lingering modal backdrops");
              document
                .querySelectorAll(".modal-backdrop")
                .forEach((el) => el.remove());
              document.body.classList.remove("modal-open");
              document.body.style.overflow = "";
              document.body.style.paddingRight = "";
            }
          }, 150);
        });
      });
    </script>

    <!-- JavaScript resources -->
    <!-- Bootstrap already loaded in head -->

    <!-- Initialize components on page load -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize FieldManager (core requirement for OBC Matrix)
        if (TEUI && TEUI.FieldManager) {
          TEUI.FieldManager.renderAllSections();
          console.log("OBC Matrix FieldManager initialized");
        } else {
          console.error("TEUI.FieldManager not found - core functionality will not work");
        }

        // Initialize optional state manager
        if (TEUI && TEUI.StateManager) {
          TEUI.StateManager.initialize();
          TEUI.StateManager.loadState();
          console.log("StateManager initialized");
        }

        // Initialize optional Component Bridge
        if (TEUI && TEUI.ComponentBridge) {
          TEUI.ComponentBridge.initAll();
          console.log("ComponentBridge initialized");
        }

        // Initialize optional Calculator
        if (TEUI && TEUI.Calculator) {
          TEUI.Calculator.initialize();

          // Calculate all values after initialization
          setTimeout(function () {
            TEUI.Calculator.calculateAll();
          }, 500);
          console.log("Calculator initialized");
        }

        // Initialize Global Notes Panel with delay to ensure DOM is ready
        setTimeout(function() {
          initializeNotesPanel();
        }, 100);

        console.log("OBC Matrix initialization complete");
      });

      // Global Notes Panel functionality
      function initializeNotesPanel() {
        console.log('Initializing notes panel...');
        const notesToggleBtn = document.getElementById('notes-toggle-btn');
        const closeNotesBtn = document.getElementById('close-notes-panel');
        const notesPanel = document.getElementById('global-notes-panel');
        const notesTextarea = document.getElementById('global-notes-textarea');

        console.log('Found elements:', { notesToggleBtn, closeNotesBtn, notesPanel, notesTextarea });

        if (!notesToggleBtn || !notesPanel) {
          console.error('Required notes panel elements not found');
          return;
        }

        // Toggle notes column
        function toggleNotesPanel() {
          console.log('Toggle notes column clicked');
          const isHidden = document.body.classList.contains('notes-hidden');
          
          if (isHidden) {
            // Show notes column
            document.body.classList.remove('notes-hidden');
            notesToggleBtn.classList.add('active');
            console.log('Showed notes column');
          } else {
            // Hide notes column
            document.body.classList.add('notes-hidden');
            notesToggleBtn.classList.remove('active');
            console.log('Hidden notes column');
          }
        }

        // Event listeners
        notesToggleBtn.addEventListener('click', toggleNotesPanel);
        console.log('Added click listener to notes toggle button');
        
        // Set initial state - notes visible by default
        notesToggleBtn.classList.add('active');
      }
    </script>
  </body>
</html>
