<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S10 Dual-State Isolation Test</title>
    <link rel="stylesheet" href="4011-styles.css" />
    <style>
      .test-header {
        background: #f0f0f0;
        padding: 20px;
        border-bottom: 2px solid #ccc;
        margin-bottom: 20px;
      }
      .mode-toggle {
        margin: 10px 0;
      }
      .mode-toggle button {
        padding: 8px 16px;
        margin-right: 10px;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
      }
      .mode-toggle button.active {
        background: #007bff;
        color: white;
      }
      .debug-panel {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 300px;
        background: white;
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-family: monospace;
        font-size: 12px;
        max-height: 80vh;
        overflow-y: auto;
      }
      .debug-panel h3 {
        margin-top: 0;
        font-size: 14px;
      }
      .debug-panel pre {
        margin: 2px 0;
        white-space: pre-wrap;
      }
      .test-actions {
        margin: 20px 0;
      }
      .test-actions button {
        padding: 10px 15px;
        margin-right: 10px;
        background: #28a745;
        color: white;
        border: none;
        cursor: pointer;
      }
      .test-actions button:hover {
        background: #218838;
      }
      .status-indicator {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
      }
      .status-pass {
        background: #28a745;
        color: white;
      }
      .status-fail {
        background: #dc3545;
        color: white;
      }
      .status-unknown {
        background: #6c757d;
        color: white;
      }

      /* S10 specific styles */
      .section-content {
        max-width: 1200px;
        margin: 0 auto;
      }
      .section-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }
      .section-table th,
      .section-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      .section-table th {
        background: #f8f9fa;
        font-weight: bold;
      }
      .user-input {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 4px;
        text-align: center;
        min-width: 60px;
      }
      .calculated {
        background: #e8f5e8;
        padding: 4px;
        text-align: center;
        min-width: 60px;
      }
      .slider-container {
        padding: 2px;
      }
      .slider-container input[type="range"] {
        width: 100%;
        margin: 2px 0;
      }
      .slider-display {
        font-size: 12px;
        text-align: center;
      }
      .gain-indicator {
        font-weight: bold;
      }
      .gain-high {
        color: #28a745;
      }
      .gain-medium {
        color: #ffc107;
      }
      .gain-low {
        color: #dc3545;
      }
      .text-left-indicator {
        text-align: left !important;
      }
      .negative-value {
        color: #dc3545;
      }
      .reference-value {
        background: #f8f9fa;
        color: #6c757d;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="test-header">
      <h1>üß™ Section 10 Dual-State Isolation Test</h1>
      <p>Testing dual-state isolation for window gains calculations</p>

      <!-- Mode Toggle -->
      <div class="mode-toggle">
        <button id="target-mode" class="active">üéØ Target Mode</button>
        <button id="reference-mode">üìã Reference Mode</button>
        <span id="current-mode-display">Current: <strong>Target</strong></span>
      </div>

      <!-- Test Actions -->
      <div class="test-actions">
        <button onclick="runIsolationTest()">üîç Run Isolation Test</button>
        <button onclick="resetAllValues()">üîÑ Reset All Values</button>
        <button onclick="toggleDebugPanel()">üìä Toggle Debug Panel</button>
      </div>

      <!-- Test Status -->
      <div id="test-status">
        <span class="status-indicator status-unknown"
          >Isolation Status: Unknown</span
        >
        <span class="status-indicator status-unknown"
          >Sync Status: Unknown</span
        >
      </div>
    </div>

    <div class="section-content">
      <!-- S10 Content -->
      <div id="section-10">
        <h2>Section 10: Radiant Gains</h2>

        <!-- Window Gains Table -->
        <table class="section-table">
          <thead>
            <tr>
              <th>Component</th>
              <th>AREA m¬≤</th>
              <th>ORIENTATION</th>
              <th>SHGC</th>
              <th>WINTER SHADING</th>
              <th>SUMMER SHADING</th>
              <th>HTG GAIN<br />kWh/yr</th>
              <th>HTG GAIN<br />%</th>
              <th>COOL GAIN<br />kWh/yr</th>
              <th>COOL GAIN<br />%</th>
              <th>G-FACTOR<br />kWh/m¬≤/yr</th>
            </tr>
          </thead>
          <tbody>
            <!-- Row 73: Doors -->
            <tr>
              <td>Doors</td>
              <td>
                <input
                  type="text"
                  class="user-input"
                  data-field-id="d_73"
                  value="7.50"
                  style="width: 60px; text-align: center"
                />
              </td>
              <td>
                <select data-field-id="e_73">
                  <option value="North">North</option>
                  <option value="NorthEast">NorthEast</option>
                  <option value="East">East</option>
                  <option value="SouthEast">SouthEast</option>
                  <option value="South">South</option>
                  <option value="SouthWest">SouthWest</option>
                  <option value="West">West</option>
                  <option value="NorthWest">NorthWest</option>
                  <option value="Average" selected>Average</option>
                  <option value="Skylight">Skylight</option>
                </select>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="f_73"
                    min="0.2"
                    max="0.6"
                    step="0.05"
                    value="0.50"
                  />
                  <div class="slider-display" data-display-for="f_73">0.50</div>
                </div>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="g_73"
                    min="0"
                    max="100"
                    step="1"
                    value="0"
                  />
                  <div class="slider-display" data-display-for="g_73">0%</div>
                </div>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="h_73"
                    min="0"
                    max="100"
                    step="1"
                    value="100"
                  />
                  <div class="slider-display" data-display-for="h_73">100%</div>
                </div>
              </td>
              <td>
                <div class="calculated" data-field-id="i_73">225.00</div>
              </td>
              <td>
                <div class="calculated gain-indicator" data-field-id="j_73">
                  1.55%
                </div>
              </td>
              <td>
                <div class="calculated" data-field-id="k_73">0.00</div>
              </td>
              <td>
                <div class="calculated gain-indicator" data-field-id="l_73">
                  0.00%
                </div>
              </td>
              <td>
                <div class="calculated reference-value" data-field-id="m_73">
                  50
                </div>
              </td>
            </tr>

            <!-- Row 74: Window Area North -->
            <tr>
              <td>Window Area North</td>
              <td>
                <input
                  type="text"
                  class="user-input"
                  data-field-id="d_74"
                  value="81.14"
                  style="width: 60px; text-align: center"
                />
              </td>
              <td>
                <select data-field-id="e_74">
                  <option value="North" selected>North</option>
                  <option value="NorthEast">NorthEast</option>
                  <option value="East">East</option>
                  <option value="SouthEast">SouthEast</option>
                  <option value="South">South</option>
                  <option value="SouthWest">SouthWest</option>
                  <option value="West">West</option>
                  <option value="NorthWest">NorthWest</option>
                  <option value="Average">Average</option>
                  <option value="Skylight">Skylight</option>
                </select>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="f_74"
                    min="0.2"
                    max="0.6"
                    step="0.05"
                    value="0.50"
                  />
                  <div class="slider-display" data-display-for="f_74">0.50</div>
                </div>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="g_74"
                    min="0"
                    max="100"
                    step="1"
                    value="0"
                  />
                  <div class="slider-display" data-display-for="g_74">0%</div>
                </div>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="h_74"
                    min="0"
                    max="100"
                    step="1"
                    value="100"
                  />
                  <div class="slider-display" data-display-for="h_74">100%</div>
                </div>
              </td>
              <td>
                <div class="calculated" data-field-id="i_74">350.00</div>
              </td>
              <td>
                <div class="calculated gain-indicator" data-field-id="j_74">
                  2.41%
                </div>
              </td>
              <td>
                <div class="calculated" data-field-id="k_74">0.00</div>
              </td>
              <td>
                <div class="calculated gain-indicator" data-field-id="l_74">
                  0.00%
                </div>
              </td>
              <td>
                <div class="calculated reference-value" data-field-id="m_74">
                  24.84
                </div>
              </td>
            </tr>

            <!-- Row 75: Window Area East -->
            <tr>
              <td>Window Area East</td>
              <td>
                <input
                  type="text"
                  class="user-input"
                  data-field-id="d_75"
                  value="3.83"
                  style="width: 60px; text-align: center"
                />
              </td>
              <td>
                <select data-field-id="e_75">
                  <option value="North">North</option>
                  <option value="NorthEast">NorthEast</option>
                  <option value="East" selected>East</option>
                  <option value="SouthEast">SouthEast</option>
                  <option value="South">South</option>
                  <option value="SouthWest">SouthWest</option>
                  <option value="West">West</option>
                  <option value="NorthWest">NorthWest</option>
                  <option value="Average">Average</option>
                  <option value="Skylight">Skylight</option>
                </select>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="f_75"
                    min="0.2"
                    max="0.6"
                    step="0.05"
                    value="0.50"
                  />
                  <div class="slider-display" data-display-for="f_75">0.50</div>
                </div>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="g_75"
                    min="0"
                    max="100"
                    step="1"
                    value="0"
                  />
                  <div class="slider-display" data-display-for="g_75">0%</div>
                </div>
              </td>
              <td>
                <div class="slider-container">
                  <input
                    type="range"
                    data-field-id="h_75"
                    min="0"
                    max="100"
                    step="1"
                    value="100"
                  />
                  <div class="slider-display" data-display-for="h_75">100%</div>
                </div>
              </td>
              <td>
                <div class="calculated" data-field-id="i_75">195.00</div>
              </td>
              <td>
                <div class="calculated gain-indicator" data-field-id="j_75">
                  1.34%
                </div>
              </td>
              <td>
                <div class="calculated" data-field-id="k_75">0.00</div>
              </td>
              <td>
                <div class="calculated gain-indicator" data-field-id="l_75">
                  0.00%
                </div>
              </td>
              <td>
                <div class="calculated reference-value" data-field-id="m_75">
                  24.84
                </div>
              </td>
            </tr>

            <!-- Subtotal Row 79 -->
            <tr style="background: #f8f9fa; font-weight: bold">
              <td>SUBTOTAL</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>-</td>
              <td>
                <div class="calculated" data-field-id="i_79">770.00</div>
              </td>
              <td>
                <div class="calculated" data-field-id="j_79">5.30%</div>
              </td>
              <td>
                <div class="calculated" data-field-id="k_79">0.00</div>
              </td>
              <td>
                <div class="calculated" data-field-id="l_79">0.00%</div>
              </td>
              <td>-</td>
            </tr>
          </tbody>
        </table>

        <!-- PHPP Method Selection -->
        <div
          style="
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
          "
        >
          <h3>PHPP Method Selection</h3>
          <label for="phpp-method">Method:</label>
          <select id="phpp-method" data-field-id="d_80">
            <option value="PHPP Method" selected>
              PHPP Method (94% Utilization)
            </option>
            <option value="Simple Method">
              Simple Method (40% Utilization)
            </option>
            <option value="Comprehensive Method">
              Comprehensive Method (60% Utilization)
            </option>
          </select>

          <div
            style="
              margin-top: 10px;
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 10px;
            "
          >
            <div>
              <strong>Total Heating Gains:</strong>
              <span class="calculated" data-field-id="i_79">0.00</span> kWh/yr
            </div>
            <div>
              <strong>Utilization Factor:</strong>
              <span class="calculated" data-field-id="j_80">94.0%</span>
            </div>
            <div>
              <strong>Usable Gains:</strong>
              <span class="calculated" data-field-id="k_80">0.00</span> kWh/yr
            </div>
            <div>
              <strong>Unusable Gains:</strong>
              <span class="calculated" data-field-id="l_80">0.00</span> kWh/yr
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debug-panel">
      <h3>üîç State Debug Panel</h3>
      <div id="debug-content"></div>
    </div>

    <!-- Dependencies -->
    <script src="4011-StateManager.js"></script>
    <script src="4011-ComponentBridge.js"></script>
    <script src="4011-ClimateValues.js"></script>
    <script src="sections/4011-Section10.js"></script>

    <!-- Test Controller -->
    <script>
      // Test Controller for S10 Isolation Testing
      const TestController = (function () {
        let currentMode = "target";
        let isolationTestResults = {};
        let debugPanelVisible = true;

        function init() {
          console.log("üß™ Initializing S10 Isolation Test...");

          // Initialize TEUI namespace
          window.TEUI = window.TEUI || {};
          window.TEUI.StateManager = window.TEUI.StateManager || {};
          window.TEUI.SectionModules = window.TEUI.SectionModules || {};

          // Initialize dependencies
          initializeDependencies();

          // Setup test interface
          setupModeToggle();
          setupEventHandlers();

          // Initialize S10 if available - BUT override its event handlers
          if (window.TEUI.SectionModules.sect10) {
            // Get the module but don't call onSectionRendered yet
            window.S10Module = window.TEUI.SectionModules.sect10;
            window.S10ModeManager = window.TEUI.SectionModules.sect10.ModeManager;
            console.log("‚úÖ S10 Module loaded (event handlers will be overridden)");
          } else {
            console.warn("‚ö†Ô∏è S10 Module not available, using test calculations only");
          }

          // Start debug panel updates
          setupDebugPanel();

          console.log("‚úÖ S10 Isolation Test initialized");

          // Initialize some test values to verify isolation
          setTimeout(initializeTestValues, 1000);
        }

        function initializeTestValues() {
          console.log("üß™ Setting up initial test values...");

          // Set some default values in Target mode
          switchMode("target");
          setTimeout(() => {
            window.TEUI.StateManager.setValue("target_e_73", "South", "test-init");
            window.TEUI.StateManager.setValue("target_e_74", "North", "test-init");
            window.TEUI.StateManager.setValue("target_f_73", "0.45", "test-init");

            // Set different values in Reference mode
            switchMode("reference");
            setTimeout(() => {
              window.TEUI.StateManager.setValue("ref_e_73", "Average", "test-init");
              window.TEUI.StateManager.setValue("ref_e_74", "East", "test-init");
              window.TEUI.StateManager.setValue("ref_f_73", "0.55", "test-init");

              // Return to Target mode and run initial calculations
              switchMode("target");
              setTimeout(() => {
                calculateTestValues();
                console.log("‚úÖ Test values initialized");
              }, 200);
            }, 200);
          }, 200);
        }

        function initializeDependencies() {
          // Initialize ComponentBridge
          if (window.TEUI.ComponentBridge) {
            window.TEUI.ComponentBridge.initDualStateSync();
            console.log("‚úÖ ComponentBridge initialized");
          }

          // Initialize StateManager if not already done
          if (!window.TEUI.StateManager.initialized) {
            // Basic StateManager stub for testing
            window.TEUI.StateManager = {
              state: {},
              listeners: {},

              setValue: function (fieldId, value, source) {
                this.state[fieldId] = value;
                console.log(`üìù State: ${fieldId} = ${value} (${source})`);

                // Notify listeners
                if (this.listeners[fieldId]) {
                  this.listeners[fieldId].forEach((callback) => {
                    try {
                      callback(fieldId, value, source);
                    } catch (e) {
                      console.error("Listener error:", e);
                    }
                  });
                }
              },

              getValue: function (fieldId) {
                return this.state[fieldId];
              },

              addListener: function (fieldId, callback) {
                if (!this.listeners[fieldId]) {
                  this.listeners[fieldId] = [];
                }
                this.listeners[fieldId].push(callback);
              },

              initialized: true,
            };
          }

          // Initialize parseNumeric if not available
          if (!window.TEUI.parseNumeric) {
            window.TEUI.parseNumeric = function (value, defaultValue = 0) {
              const parsed = parseFloat(value);
              return isNaN(parsed) ? defaultValue : parsed;
            };
          }
        }

        function setupModeToggle() {
          const targetBtn = document.getElementById("target-mode");
          const referenceBtn = document.getElementById("reference-mode");

          targetBtn.onclick = () => switchMode("target");
          referenceBtn.onclick = () => switchMode("reference");
        }

        function switchMode(mode) {
          console.log(`üîÑ Switching to ${mode.toUpperCase()} mode`);

          currentMode = mode;

          // Update UI
          document
            .getElementById("target-mode")
            .classList.toggle("active", mode === "target");
          document
            .getElementById("reference-mode")
            .classList.toggle("active", mode === "reference");
          document.getElementById("current-mode-display").innerHTML =
            `Current: <strong>${mode.charAt(0).toUpperCase() + mode.slice(1)}</strong>`;

          // Add visual mode indicator to the section
          const sectionElement = document.getElementById("section-10");
          if (sectionElement) {
            sectionElement.style.borderLeft =
              mode === "target" ? "5px solid #007bff" : "5px solid #28a745";
            sectionElement.style.backgroundColor =
              mode === "target" ? "#f8f9ff" : "#f8fff8";
          }

          // Update S10 ModeManager
          if (window.S10ModeManager) {
            window.S10ModeManager.currentMode = mode;
            console.log(`‚úÖ S10 ModeManager updated to ${mode}`);
          }

          // Update display values for current mode
          updateDisplayForMode(mode);

          // Trigger calculations for the new mode
          setTimeout(() => {
            calculateTestValues();
          }, 100);
        }

        function updateDisplayForMode(mode) {
          console.log(`üîÑ Updating display for ${mode.toUpperCase()} mode`);
          const prefix = mode === "target" ? "target_" : "ref_";
          const fields = [
            "d_73",
            "d_74",
            "d_75", // Areas
            "e_73",
            "e_74",
            "e_75", // Orientations
            "f_73",
            "f_74",
            "f_75", // SHGC sliders
            "g_73",
            "g_74",
            "g_75", // Winter shading sliders
            "h_73",
            "h_74",
            "h_75", // Summer shading sliders
            "d_80", // PHPP method
          ];

          fields.forEach((fieldId) => {
            const value = window.TEUI.StateManager.getValue(`${prefix}${fieldId}`);
            const element = document.querySelector(`[data-field-id="${fieldId}"]`);

            console.log(`  ${fieldId}: ${prefix}${fieldId} = ${value}`);

            if (element && value !== undefined) {
              if (element.tagName === "SELECT") {
                element.value = value;
                console.log(`    üìã Set dropdown ${fieldId} = ${value}`);
              } else if (element.tagName === "INPUT") {
                element.value = value;
                if (element.type === "range") {
                  updateSliderDisplay(fieldId, value);
                }
                console.log(`    üìù Set input ${fieldId} = ${value}`);
              }
            } else if (element && value === undefined) {
              console.log(`    ‚ö†Ô∏è No value found for ${prefix}${fieldId}`);
            } else if (!element) {
              console.log(`    ‚ùå Element not found for ${fieldId}`);
            }
          });
        }

        function setupEventHandlers() {
          // Setup input event handlers
          const inputs = document.querySelectorAll("[data-field-id]");
          inputs.forEach((input) => {
            if (input.tagName === "SELECT") {
              input.addEventListener("change", handleInputChange);
            } else if (input.tagName === "INPUT") {
              if (input.type === "text") {
                input.addEventListener("blur", handleInputChange);
                input.addEventListener("keypress", function (e) {
                  if (e.key === "Enter") {
                    e.preventDefault();
                    this.blur();
                  }
                });
              } else {
                input.addEventListener("input", handleInputChange);
              }
            }
          });
        }

        function handleInputChange(event) {
          const fieldId = event.target.getAttribute("data-field-id");
          const value = event.target.value || event.target.textContent;

          console.log(
            `üñ±Ô∏è User input: ${fieldId} = ${value} in ${currentMode.toUpperCase()} mode`,
          );

          // Store to prefixed state for current mode
          const prefix = currentMode === "target" ? "target_" : "ref_";
          window.TEUI.StateManager.setValue(
            `${prefix}${fieldId}`,
            value,
            "user-modified",
          );
          console.log(`üìù Stored to: ${prefix}${fieldId} = ${value}`);

          // CRITICAL: Only sync to global in Target mode (ComponentBridge should handle this but let's debug)
          if (currentMode === "target") {
            window.TEUI.StateManager.setValue(fieldId, value, "user-modified");
            console.log(`üìù Also stored to global: ${fieldId} = ${value}`);
          } else {
            console.log(`üö´ Reference mode - NOT storing to global state`);
          }

          // Update slider display if needed
          if (event.target.type === "range") {
            updateSliderDisplay(fieldId, value);
          }

          // Trigger our custom calculations for the test environment
          console.log(`üßÆ Triggering calculations...`);
          setTimeout(() => {
            calculateTestValues();
          }, 100);
        }

        function updateSliderDisplay(fieldId, value) {
          const displayElement = document.querySelector(
            `[data-display-for="${fieldId}"]`,
          );
          if (displayElement) {
            if (fieldId.startsWith("f_")) {
              displayElement.textContent = parseFloat(value).toFixed(2);
            } else if (fieldId.startsWith("g_") || fieldId.startsWith("h_")) {
              displayElement.textContent = value + "%";
            }
          }
        }

        function setupDebugPanel() {
          updateDebugPanel();
          setInterval(updateDebugPanel, 1000);
        }

        function updateDebugPanel() {
          const debugContent = document.getElementById("debug-content");
          if (!debugContent) return;

          const inputFields = [
            "d_73",
            "d_74",
            "d_75",
            "e_73",
            "e_74",
            "e_75",
            "f_73",
            "f_74",
            "f_75",
            "g_73",
            "g_74",
            "g_75",
            "h_73",
            "h_74",
            "h_75",
          ];
          const calcFields = [
            "i_73",
            "i_74",
            "i_75",
            "k_73",
            "k_74",
            "k_75",
            "m_73",
            "m_74",
            "m_75",
            "i_79",
            "j_80",
            "k_80",
          ];

          let html = `<h4>Current Mode: ${currentMode}</h4>`;

          html += "<h4>Target Inputs:</h4>";
          inputFields.forEach((fieldId) => {
            const value = window.TEUI.StateManager.getValue(`target_${fieldId}`);
            if (value !== undefined) {
              html += `<pre style="color: blue;">target_${fieldId}: ${value}</pre>`;
            }
          });

          html += "<h4>Reference Inputs:</h4>";
          inputFields.forEach((fieldId) => {
            const value = window.TEUI.StateManager.getValue(`ref_${fieldId}`);
            if (value !== undefined) {
              html += `<pre style="color: green;">ref_${fieldId}: ${value}</pre>`;
            }
          });

          html += "<h4>Global State (for comparison):</h4>";
          [...inputFields, ...calcFields].forEach((fieldId) => {
            const value = window.TEUI.StateManager.getValue(fieldId);
            if (value !== undefined) {
              html += `<pre style="color: gray;">${fieldId}: ${value}</pre>`;
            }
          });

          // Show current values comparison
          html += "<h4>üîç Isolation Check:</h4>";
          const testFields = ["e_73", "f_73", "g_73", "h_73"];
          testFields.forEach((fieldId) => {
            const targetVal = window.TEUI.StateManager.getValue(`target_${fieldId}`);
            const refVal = window.TEUI.StateManager.getValue(`ref_${fieldId}`);
            const isolated = targetVal !== refVal && targetVal && refVal;
            html += `<pre style="color: ${isolated ? "green" : "red"};">${fieldId}: T=${targetVal} R=${refVal} ${isolated ? "‚úÖ" : "‚ùå"}</pre>`;
          });

          debugContent.innerHTML = html;
        }

        // Global functions for buttons
        window.runIsolationTest = function () {
          console.log("üß™ Running isolation test...");

          // Test 1: Set different values in each mode
          switchMode("target");
          setTimeout(() => {
            document.querySelector('[data-field-id="f_73"]').value = "0.3";
            document
              .querySelector('[data-field-id="f_73"]')
              .dispatchEvent(new Event("input"));

            setTimeout(() => {
              switchMode("reference");
              setTimeout(() => {
                document.querySelector('[data-field-id="f_73"]').value = "0.7";
                document
                  .querySelector('[data-field-id="f_73"]')
                  .dispatchEvent(new Event("input"));

                setTimeout(() => {
                  checkIsolation();
                }, 500);
              }, 500);
            }, 500);
          }, 500);
        };

        window.resetAllValues = function () {
          console.log("üîÑ Resetting all values...");

          // Reset StateManager
          window.TEUI.StateManager.state = {};

          // Reset DOM elements to their default values
          const defaults = {
            d_73: "7.50",
            d_74: "81.14",
            d_75: "3.83",
            e_73: "Average",
            e_74: "North",
            e_75: "East",
            f_73: "0.50",
            f_74: "0.50",
            f_75: "0.50",
            g_73: "0",
            g_74: "0",
            g_75: "0",
            h_73: "100",
            h_74: "100",
            h_75: "100",
          };

          Object.entries(defaults).forEach(([fieldId, defaultValue]) => {
            const element = document.querySelector(`[data-field-id="${fieldId}"]`);
            if (element) {
              if (element.tagName === "SELECT") {
                element.value = defaultValue;
              } else if (element.tagName === "INPUT") {
                element.value = defaultValue;
                if (element.type === "range") {
                  updateSliderDisplay(fieldId, defaultValue);
                }
              }
            }
          });

          switchMode("target");
          updateTestStatus("unknown", "unknown");

          console.log("‚úÖ Reset complete");
        };

        window.toggleDebugPanel = function () {
          const panel = document.getElementById("debug-panel");
          debugPanelVisible = !debugPanelVisible;
          panel.style.display = debugPanelVisible ? "block" : "none";
        };

        function checkIsolation() {
          console.log("üîç Checking isolation...");

          const targetF73 = window.TEUI.StateManager.getValue("target_f_73");
          const refF73 = window.TEUI.StateManager.getValue("ref_f_73");
          const globalF73 = window.TEUI.StateManager.getValue("f_73");

          console.log(`Target f_73: ${targetF73}`);
          console.log(`Reference f_73: ${refF73}`);
          console.log(`Global f_73: ${globalF73}`);

          const isolationPass = targetF73 !== refF73 && targetF73 && refF73;
          const syncPass = globalF73 === targetF73; // Global should match target

          updateTestStatus(
            isolationPass ? "pass" : "fail",
            syncPass ? "pass" : "fail",
          );

          console.log(`Isolation: ${isolationPass ? "PASS" : "FAIL"}`);
          console.log(`Sync: ${syncPass ? "PASS" : "FAIL"}`);
        }

        function updateTestStatus(isolation, sync) {
          const statusElement = document.getElementById("test-status");
          const isolationClass =
            isolation === "pass"
              ? "status-pass"
              : isolation === "fail"
                ? "status-fail"
                : "status-unknown";
          const syncClass =
            sync === "pass"
              ? "status-pass"
              : sync === "fail"
                ? "status-fail"
                : "status-unknown";

          statusElement.innerHTML = `
                    <span class="status-indicator ${isolationClass}">Isolation Status: ${isolation.toUpperCase()}</span>
                    <span class="status-indicator ${syncClass}">Sync Status: ${sync.toUpperCase()}</span>
                `;
        }

        // Test Environment Calculations (Simplified S10 Logic)
        function calculateTestValues() {
          console.log(
            `üßÆ Running test calculations in ${currentMode.toUpperCase()} mode`,
          );

          const prefix = currentMode === "target" ? "target_" : "ref_";

          // Get current mode values from prefixed state
          const getFieldValue = (fieldId) => {
            const value = window.TEUI.StateManager.getValue(`${prefix}${fieldId}`);
            return value !== undefined
              ? value
              : window.TEUI.StateManager.getValue(fieldId) || // Fallback to global
                  getDefaultValue(fieldId); // Ultimate fallback
          };

          const getNumericValue = (fieldId) => {
            const value = getFieldValue(fieldId);
            return parseFloat(value) || 0;
          };

          // Calculate for each row
          const rows = [73, 74, 75];
          let totalHeatingGains = 0;

          rows.forEach((rowId) => {
            // Get input values
            const area = getNumericValue(`d_${rowId}`);
            const orientation = getFieldValue(`e_${rowId}`);
            const shgc = getNumericValue(`f_${rowId}`);
            const winterShading = getNumericValue(`g_${rowId}`) / 100; // Convert % to decimal
            const summerShading = getNumericValue(`h_${rowId}`) / 100;

            console.log(
              `  Row ${rowId}: area=${area}, orientation=${orientation}, shgc=${shgc}, winterShading=${winterShading}`,
            );

            // Calculate gain factor based on orientation (simplified)
            const gainFactor = getGainFactor(orientation);

            // Calculate heating gains: area √ó gainFactor √ó (shgc/0.5) √ó (1 - winterShading)
            const shgcNormalization = shgc / 0.5; // Baseline SHGC is 0.5
            const heatingGains =
              area * gainFactor * shgcNormalization * (1 - winterShading);

            // Calculate cooling gains (simplified - 50% of heating with summer shading)
            const coolingGains = heatingGains * 0.5 * (1 - summerShading);

            console.log(
              `    Results: gainFactor=${gainFactor}, heatingGains=${heatingGains}, coolingGains=${coolingGains}`,
            );

            // Update DOM for calculated values
            updateCalculatedField(`m_${rowId}`, gainFactor, "number");
            updateCalculatedField(`i_${rowId}`, heatingGains, "number");
            updateCalculatedField(`k_${rowId}`, coolingGains, "number");

            totalHeatingGains += heatingGains;
          });

          // Calculate subtotals
          updateCalculatedField("i_79", totalHeatingGains, "number");

          // Calculate percentages for each row (using the calculated values from above)
          let totalCoolingGains = 0;
          rows.forEach((rowId) => {
            const element = document.querySelector(`[data-field-id="k_${rowId}"]`);
            const coolingGain = parseFloat(element?.textContent || "0");
            totalCoolingGains += coolingGain;
          });

          rows.forEach((rowId) => {
            const heatingElement = document.querySelector(
              `[data-field-id="i_${rowId}"]`,
            );
            const coolingElement = document.querySelector(
              `[data-field-id="k_${rowId}"]`,
            );

            const heatingGain = parseFloat(heatingElement?.textContent || "0");
            const coolingGain = parseFloat(coolingElement?.textContent || "0");

            const heatingPercent =
              totalHeatingGains > 0 ? heatingGain / totalHeatingGains : 0;
            const coolingPercent =
              totalCoolingGains > 0 ? coolingGain / totalCoolingGains : 0;

            updateCalculatedField(`j_${rowId}`, heatingPercent, "percent");
            updateCalculatedField(`l_${rowId}`, coolingPercent, "percent");
          });

          // Update cooling subtotal
          updateCalculatedField("k_79", totalCoolingGains, "number");
          updateCalculatedField("j_79", totalHeatingGains > 0 ? 1 : 0, "percent");
          updateCalculatedField("l_79", totalCoolingGains > 0 ? 1 : 0, "percent");

          // Calculate PHPP utilization factors
          const method = getFieldValue("d_80");
          let utilizationFactor = 0.94; // Default PHPP

          if (method.includes("Simple")) {
            utilizationFactor = 0.4;
          } else if (method.includes("Comprehensive")) {
            utilizationFactor = 0.6;
          }

          const usableGains = totalHeatingGains * utilizationFactor;
          const unusableGains = totalHeatingGains - usableGains;

          updateCalculatedField("j_80", utilizationFactor, "percent");
          updateCalculatedField("k_80", usableGains, "number");
          updateCalculatedField("l_80", unusableGains, "number");

          console.log(
            `‚úÖ Calculations complete: totalGains=${totalHeatingGains}, utilization=${utilizationFactor}`,
          );
        }

        function getDefaultValue(fieldId) {
          const defaults = {
            d_73: "7.50",
            d_74: "81.14",
            d_75: "3.83",
            e_73: "Average",
            e_74: "North",
            e_75: "East",
            f_73: "0.50",
            f_74: "0.50",
            f_75: "0.50",
            g_73: "0",
            g_74: "0",
            g_75: "0",
            h_73: "100",
            h_74: "100",
            h_75: "100",
            d_80: "PHPP Method",
          };
          return defaults[fieldId] || "0";
        }

        function getGainFactor(orientation) {
          // Simplified gain factors (kWh/m¬≤/yr) based on orientation
          const gainFactors = {
            North: 0.19,
            NorthEast: 12.4,
            East: 2.09,
            SouthEast: 18.7,
            South: 24.76,
            SouthWest: 21.3,
            West: 25.86,
            NorthWest: 16.2,
            Average: 24.84,
            Skylight: 35.2,
          };
          return gainFactors[orientation] || gainFactors["Average"];
        }

        function updateCalculatedField(fieldId, value, format = "number") {
          const element = document.querySelector(`[data-field-id="${fieldId}"]`);
          if (!element) return;

          let formattedValue;
          if (format === "percent") {
            formattedValue = (value * 100).toFixed(1) + "%";
          } else if (format === "number") {
            formattedValue = value.toFixed(2);
          } else {
            formattedValue = value.toString();
          }

          element.textContent = formattedValue;

          // Store to prefixed state as well
          const prefix = currentMode === "target" ? "target_" : "ref_";
          window.TEUI.StateManager.setValue(
            `${prefix}${fieldId}`,
            value.toString(),
            "calculated",
          );

          // Also store to global in Target mode
          if (currentMode === "target") {
            window.TEUI.StateManager.setValue(
              fieldId,
              value.toString(),
              "calculated",
            );
          }
        }

        return { init };
      })();

      // Initialize when DOM loaded
      document.addEventListener("DOMContentLoaded", TestController.init);
    </script>
  </body>
</html>
