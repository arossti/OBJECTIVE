<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Calculations Demo</title>
    <link rel="stylesheet" href="4011-styles.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        /* Section styling */
        .section-container {
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #333;
            color: white;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        .section-content {
            padding: 0;
        }
        .section-title {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }
        .weather-data-btn {
            background-color: #008CBA;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
        }
        
        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        th {
            background-color: #f2f2f2;
            font-weight: normal;
            text-align: center;
            color: #333;
            font-size: 14px;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Cell styling */
        .row-id {
            color: #666;
            font-size: 0.9em;
            width: 50px;
        }
        .row-label {
            font-weight: 500;
            width: 180px;
        }
        .label-prefix {
            color: #666;
            font-size: 0.9em;
            margin-right: 5px;
        }
        .label-main {
            font-weight: 500;
        }
        .unit-label {
            color: #666;
            font-size: 0.9em;
            margin-left: 5px;
        }
        
        /* Value fields */
        .user-input {
            font-weight: bold;
            color: #0066cc;
            padding: 2px 5px;
            background-color: #e6f2ff;
            border-radius: 3px;
            display: inline-block;
            min-width: 30px;
            text-align: right;
            cursor: text;
        }
        .calculated-value {
            text-align: right;
            min-width: 30px;
            display: inline-block;
        }
        .negative-value {
            color: red;
        }
        
        /* Dropdown styling */
        .dropdown-container {
            position: relative;
            width: 100%;
            z-index: 10;
        }
        .dropdown-select {
            width: 100%;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="%23333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
        }
        .dropdown-select:focus {
            outline: none;
            border-color: #0066cc;
        }
        
        /* Slider styling */
        .slider-container {
            width: 100%;
            display: flex;
            align-items: center;
        }
        .slider {
            flex-grow: 1;
            margin-right: 10px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 2px;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0066cc;
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #0066cc;
            cursor: pointer;
            border: none;
        }
        .slider-value {
            width: 40px;
            text-align: right;
            font-weight: 500;
        }
        
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            position: relative;
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 70%;
            max-width: 700px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .close-btn:hover {
            color: #333;
        }
        .modal-body {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .data-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .data-label {
            flex: 1;
            font-weight: 500;
        }
        .data-value {
            flex: 1;
            text-align: right;
        }
        
        /* Debug section */
        .debug-info {
            margin-top: 30px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="section-container">
        <div class="section-header">
            <h2 class="section-title">SECTION 3. Climate Calculations</h2>
            <button id="showWeatherDataBtn" class="weather-data-btn">More Weather Data</button>
        </div>
        
        <div class="section-content">
            <table>
                <thead>
                    <tr>
                        <th>03-ID</th>
                        <th>Climate Units</th>
                        <th>°C</th>
                        <th>°F</th>
                        <th>F</th>
                        <th>G</th>
                        <th>°C</th>
                        <th>°F</th>
                        <th>J</th>
                        <th>K</th>
                        <th>L</th>
                        <th>M</th>
                        <th>N</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Province Row -->
                    <tr data-id="L.1.1">
                        <td class="row-id">L.1.1</td>
                        <td class="row-label">Province</td>
                        <td colspan="2">
                            <div class="dropdown-container">
                                <select id="provinceSelect" class="dropdown-select" data-field-id="d_19" data-dropdown-id="dd_d_19">
                                    <option value="">Select Province</option>
                                </select>
                            </div>
                        </td>
                        <td></td>
                        <td class="label-prefix">L.1.2</td>
                        <td class="label-main">City</td>
                        <td>
                            <div class="dropdown-container">
                                <select id="citySelect" class="dropdown-select" data-field-id="h_19" data-dropdown-id="dd_h_19" disabled>
                                    <option value="">Select City</option>
                                </select>
                            </div>
                        </td>
                        <td>Climate Zone</td>
                        <td>
                            <span id="climateZone" class="calculated-value" data-field-id="j_19">4.0</span>
                        </td>
                        <td class="label-prefix">L.3.3</td>
                        <td class="label-main">Days Cooling</td>
                        <td>
                            <span id="daysCooling" class="user-input editable" data-field-id="m_19" contenteditable="true">120</span>
                        </td>
                    </tr>
                    
                    <!-- Heating Degree Days Row -->
                    <tr data-id="L.2.1">
                        <td class="row-id">L.2.1</td>
                        <td class="row-label">Heating Degree Days (HDD)</td>
                        <td>
                            <span id="hdd" class="calculated-value" data-field-id="d_20">0</span>
                        </td>
                        <td></td>
                        <td class="label-prefix">L.2.2</td>
                        <td class="label-main">Current or Future Values</td>
                        <td>
                            <div class="dropdown-container">
                                <select id="timeframeSelect" class="dropdown-select" data-field-id="h_20" data-dropdown-id="dd_h_20">
                                    <option value="Present">Present (1991-2020)</option>
                                    <option value="Future">Future (2021-2050)</option>
                                </select>
                            </div>
                        </td>
                        <td></td>
                        <td>
                            <span id="hddRef" class="calculated-value reference-value" data-field-id="j_20">HDD Ref Lookup</span>
                        </td>
                        <td>
                            <span class="reference-label">HDD - Energy Star</span>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    
                    <!-- Cooling Degree Days Row -->
                    <tr data-id="L.2.3">
                        <td class="row-id">L.2.3</td>
                        <td class="row-label">Cooling Degree Days (CDD)</td>
                        <td>
                            <span id="cdd" class="calculated-value" data-field-id="d_21">0</span>
                        </td>
                        <td></td>
                        <td class="label-prefix">G.4.2</td>
                        <td class="label-main">Capacitance</td>
                        <td>
                            <div class="dropdown-container">
                                <select id="capacitanceSelect" class="dropdown-select" data-field-id="h_21" data-dropdown-id="dd_h_21">
                                    <option value="Static">Static</option>
                                    <option value="Capacitance" selected>Capacitance</option>
                                </select>
                            </div>
                        </td>
                        <td>
                            <div class="slider-container">
                                <input type="range" id="capacitanceSlider" class="slider" min="0" max="100" step="5" value="50">
                                <span id="capacitanceValue" class="slider-value" data-field-id="i_21">50%</span>
                            </div>
                        </td>
                        <td>
                            <span id="cddRef" class="calculated-value reference-value" data-field-id="j_21">CDD Ref Lookup</span>
                        </td>
                        <td>
                            <span class="reference-label">CDD - Energy Star</span>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    
                    <!-- Ground Facing & Elevation Row -->
                    <tr data-id="L.2.4">
                        <td class="row-id">L.2.4</td>
                        <td class="row-label">Ground Facing GF HDD</td>
                        <td>
                            <span id="gfHdd" class="calculated-value" data-field-id="d_22">1960</span>
                        </td>
                        <td class="unit-label">°C•days</td>
                        <td class="label-prefix">L.2.5</td>
                        <td class="label-main">GF CDD</td>
                        <td>
                            <span id="gfCdd" class="calculated-value" data-field-id="h_22">0</span>
                        </td>
                        <td class="unit-label">°C•days</td>
                        <td class="label-prefix">L.1.3</td>
                        <td class="label-main">Elevation (ASL)</td>
                        <td>
                            <span id="elevation" class="calculated-value" data-field-id="l_22">0</span>
                        </td>
                        <td class="unit-label">m</td>
                        <td></td>
                    </tr>
                    
                    <!-- Coldest Days Row -->
                    <tr data-id="L.3.1">
                        <td class="row-id">L.3.1</td>
                        <td class="row-label">Coldest Days (Location Specific)</td>
                        <td>
                            <span id="coldestDays" class="calculated-value" data-field-id="d_23">0</span>
                        </td>
                        <td>
                            <span id="coldestDaysF" class="calculated-value" data-field-id="e_23">32</span>
                        </td>
                        <td class="label-prefix">B.1.2</td>
                        <td class="label-main">Tset Heating</td>
                        <td>
                            <span id="tsetHeating" class="calculated-value" data-field-id="h_23">18</span>
                        </td>
                        <td>
                            <span id="tsetHeatingF" class="calculated-value" data-field-id="i_23">64</span>
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>
                            <span id="heatingPercent" class="calculated-value" data-field-id="m_23">0%</span>
                        </td>
                        <td></td>
                    </tr>
                    
                    <!-- Hottest Days Row -->
                    <tr data-id="L.3.2">
                        <td class="row-id">L.3.2</td>
                        <td class="row-label">Hottest Days (Location Specific)</td>
                        <td>
                            <span id="hottestDays" class="calculated-value" data-field-id="d_24">0</span>
                        </td>
                        <td>
                            <span id="hottestDaysF" class="calculated-value" data-field-id="e_24">32</span>
                        </td>
                        <td class="label-prefix">B.1.3</td>
                        <td class="label-main">Tset Cooling</td>
                        <td>
                            <span id="tsetCooling" class="calculated-value" data-field-id="h_24">24</span>
                        </td>
                        <td>
                            <span id="tsetCoolingF" class="calculated-value" data-field-id="i_24">75</span>
                        </td>
                        <td class="label-prefix">B.1.4</td>
                        <td class="label-main">Cooling Override</td>
                        <td>
                            <span id="coolingOverride" class="user-input editable" data-field-id="l_24" contenteditable="true">24</span>
                        </td>
                        <td>
                            <span id="coolingPercent" class="calculated-value" data-field-id="m_24">109%</span>
                        </td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Weather Data Modal -->
    <div id="weatherDataModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="weatherDataModalTitle">Weather Data</h3>
            <div id="weatherDataContent" class="modal-body"></div>
        </div>
    </div>
    
    <div id="debugInfo" class="debug-info"></div>

    <!-- Include ClimateValues.js -->
    <script src="4011-ClimateValues.js"></script>
    
    <script>
        // Create TEUI namespace if it doesn't exist (in case ClimateValues.js hasn't loaded yet)
        window.TEUI = window.TEUI || {};
        
        // Climate Calculations Demo - Standalone Module
        // Using IIFE pattern to create module scope
        (function() {
            // State management - follows architectural pattern with a centralized state
            const AppState = {
                values: {
                    'd_19': 'ON',
                    'h_19': '',
                    'd_20': 0,
                    'd_21': 0,
                    'h_20': 'Present',
                    'h_21': 'Capacitance',
                    'i_21': 50,
                    'd_22': 1960,
                    'h_22': 0,
                    'l_22': 0,
                    'd_23': 0,
                    'e_23': 32,
                    'h_23': 18,
                    'i_23': 64,
                    'm_23': '0%',
                    'd_24': 0,
                    'e_24': 32,
                    'h_24': 24,
                    'i_24': 75,
                    'l_24': 24,
                    'm_24': '109%',
                    'j_19': 4.0,
                    'j_20': 'HDD Ref Lookup',
                    'j_21': 'CDD Ref Lookup',
                    'm_19': 120
                },
                
                // State getters/setters with proper validation
                setValue: function(fieldId, value, source) {
                    this.values[fieldId] = value;
                    this.notifyListeners(fieldId, value, source);
                    return value;
                },
                
                getValue: function(fieldId) {
                    return this.values[fieldId];
                },
                
                // Observer pattern for state changes
                listeners: {},
                
                addListener: function(fieldId, callback) {
                    if (!this.listeners[fieldId]) {
                        this.listeners[fieldId] = [];
                    }
                    this.listeners[fieldId].push(callback);
                },
                
                notifyListeners: function(fieldId, value, source) {
                    if (this.listeners[fieldId]) {
                        this.listeners[fieldId].forEach(callback => {
                            try {
                                callback(value, fieldId, source);
                            } catch (e) {
                                console.error(`Error in listener for ${fieldId}:`, e);
                            }
                        });
                    }
                }
            };
            
            // DOM element cache to avoid repeated lookups
            const DOMElements = {
                provinceSelect: null,
                citySelect: null,
                timeframeSelect: null,
                capacitanceSelect: null,
                capacitanceSlider: null,
                capacitanceValue: null,
                calculatedFields: {},
                editableFields: {},
                debugInfo: null,
                
                // Initialize cache on first access
                init: function() {
                    if (this.initialized) return;
                    
                    this.provinceSelect = document.getElementById('provinceSelect');
                    this.citySelect = document.getElementById('citySelect');
                    this.timeframeSelect = document.getElementById('timeframeSelect');
                    this.capacitanceSelect = document.getElementById('capacitanceSelect');
                    this.capacitanceSlider = document.getElementById('capacitanceSlider');
                    this.capacitanceValue = document.getElementById('capacitanceValue');
                    this.debugInfo = document.getElementById('debugInfo');
                    
                    // Cache all calculated fields
                    const calculatedElements = document.querySelectorAll('[data-field-id]');
                    calculatedElements.forEach(element => {
                        const fieldId = element.getAttribute('data-field-id');
                        if (fieldId) {
                            this.calculatedFields[fieldId] = element;
                        }
                    });
                    
                    // Cache editable fields
                    const editableElements = document.querySelectorAll('.editable');
                    editableElements.forEach(element => {
                        const fieldId = element.getAttribute('data-field-id');
                        if (fieldId) {
                            this.editableFields[fieldId] = element;
                        }
                    });
                    
                    this.initialized = true;
                },
                
                // Safely get DOM element 
                get: function(id) {
                    if (!this.initialized) this.init();
                    
                    if (this[id]) return this[id];
                    if (this.calculatedFields[id]) return this.calculatedFields[id];
                    
                    // Fallback to direct lookup if not cached
                    return document.querySelector(`[data-field-id="${id}"]`);
                }
            };
            
            // Debug logging with timestamp
            function logDebug(message, obj) {
                console.log(message, obj);
                const debugElem = DOMElements.debugInfo;
                if (debugElem) {
                    const timestamp = new Date().toLocaleTimeString();
                    let content = debugElem.innerHTML;
                    
                    // Convert objects to strings for display
                    let objString = '';
                    if (obj !== undefined) {
                        if (typeof obj === 'object' && obj !== null) {
                            try {
                                objString = JSON.stringify(obj, null, 2);
                            } catch (e) {
                                objString = String(obj);
                            }
                        } else {
                            objString = String(obj);
                        }
                    }
                    
                    content = `[${timestamp}] ${message} ${objString}\n` + content;
                    debugElem.innerHTML = content;
                }
            }
            
            // ClimateData Access - proper data access with validation
            const ClimateDataService = {
                // Check data availability with resilient retry mechanism
                ensureAvailable: function(callback, maxRetries = 10) {
                    let attempts = 0;
                    
                    const checkData = () => {
                        attempts++;
                        logDebug(`Checking climate data availability (attempt ${attempts}/${maxRetries})`);
                        
                        if (window.TEUI?.ClimateData && Object.keys(window.TEUI.ClimateData).length > 0) {
                            logDebug('Climate data available', Object.keys(window.TEUI.ClimateData));
                            callback(window.TEUI.ClimateData);
                            return;
                        }
                        
                        if (attempts >= maxRetries) {
                            logDebug('Error: Climate data not available after max retries');
                            this.showDataError();
                            return;
                        }
                        
                        // Exponential backoff for retries
                        const delay = Math.min(100 * Math.pow(2, attempts), 2000);
                        logDebug(`Will retry in ${delay}ms`);
                        setTimeout(checkData, delay);
                    };
                    
                    checkData();
                },
                
                // Display error message when data can't be loaded
                showDataError: function() {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.padding = '20px';
                    errorDiv.style.margin = '20px 0';
                    errorDiv.style.backgroundColor = '#ffebee';
                    errorDiv.style.color = '#c62828';
                    errorDiv.style.border = '1px solid #ef9a9a';
                    errorDiv.style.borderRadius = '4px';
                    
                    errorDiv.innerHTML = `
                        <h3 style="margin-top:0">Climate Data Error</h3>
                        <p>The application was unable to load climate data from 4011-ClimateValues.js.</p>
                        <p>Please ensure the file is correctly loaded and contains valid data.</p>
                        <button id="retryButton" style="padding:8px 16px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer;">
                            Retry Loading
                        </button>
                    `;
                    
                    // Insert at the top of the page
                    document.body.insertBefore(errorDiv, document.body.firstChild);
                    
                    // Add retry button handler
                    document.getElementById('retryButton').addEventListener('click', function() {
                        errorDiv.remove();
                        initializeApplication();
                    });
                },
                
                // Get all provinces from climate data
                getProvinces: function() {
                    if (!window.TEUI?.ClimateData) return [];
                    return Object.keys(window.TEUI.ClimateData).sort();
                },
                
                // Get cities for a province
                getCitiesForProvince: function(province) {
                    if (!window.TEUI?.ClimateData || !window.TEUI.ClimateData[province]) return [];
                    return Object.keys(window.TEUI.ClimateData[province]).sort();
                },
                
                // Get climate data for a specific city
                getCityData: function(province, city) {
                    if (!window.TEUI?.ClimateData || 
                        !window.TEUI.ClimateData[province] || 
                        !window.TEUI.ClimateData[province][city]) {
                        return null;
                    }
                    return window.TEUI.ClimateData[province][city];
                },
                
                // Get full province name from abbreviation
                getProvinceFullName: function(abbr) {
                    const provinceNames = {
                        'AB': 'Alberta',
                        'BC': 'British Columbia',
                        'MB': 'Manitoba',
                        'NB': 'New Brunswick',
                        'NL': 'Newfoundland and Labrador',
                        'NS': 'Nova Scotia',
                        'NT': 'Northwest Territories',
                        'NU': 'Nunavut',
                        'ON': 'Ontario',
                        'PE': 'Prince Edward Island',
                        'QC': 'Québec',
                        'SK': 'Saskatchewan',
                        'YT': 'Yukon'
                    };
                    return provinceNames[abbr] || abbr;
                }
            };
            
            // UI Components - manages DOM updates in a centralized way
            const UIController = {
                // Initialize all UI components and bind events
                initialize: function() {
                    DOMElements.init();
                    this.setupEventListeners();
                    this.setupEditableFields();
                },
                
                // Set up event listeners for interactive components
                setupEventListeners: function() {
                    const elements = DOMElements;
                    
                    // Province dropdown
                    elements.provinceSelect.addEventListener('change', function() {
                        const provinceValue = this.value;
                        logDebug('Province changed to:', provinceValue);
                        
                        // Update state
                        AppState.setValue('d_19', provinceValue, 'user');
                    });
                    
                    // Province change should update city options
                    AppState.addListener('d_19', function(value) {
                        UIController.updateCityDropdown(value);
                    });
                    
                    // City dropdown
                    elements.citySelect.addEventListener('change', function() {
                        const cityValue = this.value;
                        logDebug('City changed to:', cityValue);
                        
                        // Update state
                        AppState.setValue('h_19', cityValue, 'user');
                    });
                    
                    // City change should update climate data
                    AppState.addListener('h_19', function(value) {
                        if (value) {
                            UIController.updateClimateData();
                        }
                    });
                    
                    // Timeframe dropdown
                    elements.timeframeSelect.addEventListener('change', function() {
                        const timeframeValue = this.value;
                        logDebug('Timeframe changed to:', timeframeValue);
                        
                        // Update state
                        AppState.setValue('h_20', timeframeValue, 'user');
                    });
                    
                    // Timeframe change should update climate data
                    AppState.addListener('h_20', function() {
                        UIController.updateClimateData();
                    });
                    
                    // Capacitance dropdown
                    elements.capacitanceSelect.addEventListener('change', function() {
                        const capacitanceValue = this.value;
                        logDebug('Capacitance changed to:', capacitanceValue);
                        
                        // Update state
                        AppState.setValue('h_21', capacitanceValue, 'user');
                    });
                    
                    // Capacitance change should recalculate
                    AppState.addListener('h_21', function() {
                        CalculationService.calculateAll();
                    });
                    
                    // Slider
                    elements.capacitanceSlider.addEventListener('input', function() {
                        const sliderValue = this.value;
                        elements.capacitanceValue.textContent = sliderValue + '%';
                        
                        // Update state
                        AppState.setValue('i_21', sliderValue, 'user');
                    });
                    
                    // Slider change should recalculate
                    AppState.addListener('i_21', function() {
                        CalculationService.calculateAll();
                    });
                    
                    // Weather data button
                    document.getElementById('showWeatherDataBtn').addEventListener('click', function() {
                        UIController.showWeatherDataModal();
                    });
                    
                    // Modal close button
                    document.querySelector('.close-btn').addEventListener('click', function() {
                        UIController.closeModal();
                    });
                    
                    // Click outside modal to close
                    window.addEventListener('click', function(event) {
                        if (event.target === document.getElementById('weatherDataModal')) {
                            UIController.closeModal();
                        }
                    });
                    
                    // Escape key to close modal
                    document.addEventListener('keydown', function(event) {
                        if (event.key === 'Escape' && document.getElementById('weatherDataModal').style.display === 'block') {
                            UIController.closeModal();
                        }
                    });
                },
                
                // Set up editable fields with proper event handling
                setupEditableFields: function() {
                    const editableFields = document.querySelectorAll('.editable');
                    
                    editableFields.forEach(field => {
                        const fieldId = field.getAttribute('data-field-id');
                        if (!fieldId) return;
                        
                        // Remove any existing listeners to prevent duplicates
                        field.removeEventListener('blur', handleEditableBlur);
                        
                        // Add blur handler
                        field.addEventListener('blur', handleEditableBlur);
                        
                        // Add enter key handler
                        field.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                this.blur();
                            }
                        });
                        
                        // Visual feedback for editing
                        field.addEventListener('focus', function() {
                            this.classList.add('editing');
                        });
                        
                        field.addEventListener('focusout', function() {
                            this.classList.remove('editing');
                        });
                    });
                    
                    // Handle editable field blur
                    function handleEditableBlur() {
                        const fieldId = this.getAttribute('data-field-id');
                        if (!fieldId) return;
                        
                        const newValue = this.textContent.trim();
                        
                        // Store the parsed value
                        const numericValue = parseFloat(newValue) || 0;
                        AppState.setValue(fieldId, numericValue, 'user');
                        
                        logDebug(`Editable field ${fieldId} changed to:`, numericValue);
                        
                        // Recalculate
                        CalculationService.calculateAll();
                    }
                },
                
                // Populate province dropdown with options
                populateProvinceDropdown: function() {
                    const provinceSelect = DOMElements.provinceSelect;
                    
                    // Clear dropdown except first option
                    while (provinceSelect.options.length > 1) {
                        provinceSelect.remove(1);
                    }
                    
                    // Get provinces from climate data
                    const provinces = ClimateDataService.getProvinces();
                    
                    // Add province options
                    provinces.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province;
                        option.textContent = ClimateDataService.getProvinceFullName(province);
                        provinceSelect.appendChild(option);
                    });
                    
                    logDebug('Populated province dropdown with options:', provinces);
                    
                    // Set default province
                    const defaultProvince = AppState.getValue('d_19') || 'ON';
                    provinceSelect.value = defaultProvince;
                    
                    // Ensure the province is set in state
                    if (provinceSelect.value) {
                        AppState.setValue('d_19', provinceSelect.value, 'init');
                    }
                },
                
                // Update city dropdown based on selected province
                updateCityDropdown: function(provinceValue) {
                    const citySelect = DOMElements.citySelect;
                    
                    // Preserve a reference to the dropdown container
                    const dropdownContainer = citySelect.parentElement;
                    
                    // Clear all options except first
                    while (citySelect.options.length > 1) {
                        citySelect.remove(1);
                    }
                    
                    if (!provinceValue) {
                        citySelect.disabled = true;
                        return;
                    }
                    
                    // Get cities for the selected province
                    const cities = ClimateDataService.getCitiesForProvince(provinceValue);
                    
                    if (cities.length === 0) {
                        logDebug('No cities found for province:', provinceValue);
                        citySelect.disabled = true;
                        return;
                    }
                    
                    // Add city options
                    cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                    
                    // Enable the dropdown
                    citySelect.disabled = false;
                    
                    // Ensure the dropdown container is visible
                    if (dropdownContainer) {
                        dropdownContainer.style.display = '';
                    }
                    
                    // Select default city if available
                    let cityToSelect = '';
                    if (provinceValue === 'ON' && cities.includes('Alexandria')) {
                        cityToSelect = 'Alexandria';
                    } else if (cities.length > 0) {
                        cityToSelect = cities[0];
                    }
                    
                    citySelect.value = cityToSelect;
                    logDebug('Default city selected:', cityToSelect);
                    
                    // Update state with selected city
                    AppState.setValue('h_19', cityToSelect, 'init');
                },
                
                // Update climate data fields based on selected city/province
                updateClimateData: function() {
                    const provinceValue = AppState.getValue('d_19');
                    const cityValue = AppState.getValue('h_19');
                    const timeframeValue = AppState.getValue('h_20');
                    
                    if (!provinceValue || !cityValue) {
                        logDebug('Missing province or city values');
                        return;
                    }
                    
                    try {
                        // Get city data
                        const cityData = ClimateDataService.getCityData(provinceValue, cityValue);
                        logDebug('Retrieved climate data for city:', cityData);
                        
                        if (!cityData) {
                            logDebug('No climate data found for city');
                            return;
                        }
                        
                        // Update elevation
                        AppState.setValue('l_22', cityData["Elev ASL (m)"] || 0, 'data');
                        
                        // Update HDD based on timeframe
                        const hddValue = timeframeValue === 'Future' 
                            ? (cityData.HDD18_2021_2050 || 0) 
                            : (cityData.HDD18 || 0);
                        AppState.setValue('d_20', hddValue, 'data');
                        
                        // Update CDD based on timeframe
                        const cddValue = timeframeValue === 'Future' 
                            ? (cityData.CDD24_2021_2050 || 0) 
                            : (cityData.CDD24 || 0);
                        AppState.setValue('d_21', cddValue, 'data');
                        
                        // Update coldest days
                        AppState.setValue('d_23', cityData.January_2_5 || 0, 'data');
                        
                        // Update hottest days based on timeframe
                        const hottestValue = timeframeValue === 'Future' 
                            ? (cityData.Future_July_2_5_Tdb || 0) 
                            : (cityData.July_2_5_Tdb || 0);
                        AppState.setValue('d_24', hottestValue, 'data');
                        
                        // Update reference lookups
                        AppState.setValue('j_20', cityData.HDD18 || 0, 'data');
                        AppState.setValue('j_21', cityData.CDD24 || 0, 'data');
                        
                        // Recalculate derived values
                        CalculationService.calculateAll();
                        
                    } catch (error) {
                        logDebug('Error updating climate data:', error.message);
                    }
                },
                
                // Show weather data modal
                showWeatherDataModal: function() {
                    const provinceValue = AppState.getValue('d_19');
                    const cityValue = AppState.getValue('h_19');
                    
                    if (!provinceValue || !cityValue) {
                        alert('Please select a province and city first.');
                        return;
                    }
                    
                    // Get city data
                    const cityData = ClimateDataService.getCityData(provinceValue, cityValue);
                    
                    if (!cityData) {
                        alert(`No climate data found for ${cityValue}, ${provinceValue}`);
                        return;
                    }
                    
                    // Set modal title
                    const weatherDataModalTitle = document.getElementById('weatherDataModalTitle');
                    weatherDataModalTitle.textContent = `Weather Data for ${cityValue}, ${ClimateDataService.getProvinceFullName(provinceValue)}`;
                    
                    // Format data for display
                    const weatherDataContent = document.getElementById('weatherDataContent');
                    let formattedData = '';
                    Object.entries(cityData).forEach(([key, value]) => {
                        formattedData += `<div class="data-row"><div class="data-label">${key}</div><div class="data-value">${value}</div></div>`;
                    });
                    
                    // Set modal content
                    weatherDataContent.innerHTML = formattedData;
                    
                    // Show modal
                    document.getElementById('weatherDataModal').style.display = 'block';
                },
                
                // Close weather data modal
                closeModal: function() {
                    document.getElementById('weatherDataModal').style.display = 'none';
                }
            };
            
            // Calculation Service - handles all derived values
            const CalculationService = {
                // Calculate all derived values
                calculateAll: function() {
                    // Calculate climate zone based on HDD
                    const hddValue = parseFloat(AppState.getValue('d_20'));
                    let climateZoneValue = '6.0';
                    
                    if (hddValue < 3000) climateZoneValue = '4.0';
                    else if (hddValue < 4000) climateZoneValue = '5.0';
                    else if (hddValue < 5000) climateZoneValue = '6.0';
                    else if (hddValue < 6000) climateZoneValue = '7.1';
                    else if (hddValue < 7000) climateZoneValue = '7.2';
                    else climateZoneValue = '8.0';
                    
                    AppState.setValue('j_19', climateZoneValue, 'calculated');
                    
                    // Calculate Fahrenheit conversions
                    const coldestC = parseFloat(AppState.getValue('d_23'));
                    const coldestF = (coldestC * 9/5) + 32;
                    AppState.setValue('e_23', Math.round(coldestF), 'calculated');
                    
                    const hottestC = parseFloat(AppState.getValue('d_24'));
                    const hottestF = (hottestC * 9/5) + 32;
                    AppState.setValue('e_24', Math.round(hottestF), 'calculated');
                    
                    // Calculate heating setpoint Fahrenheit
                    const heatingC = parseFloat(AppState.getValue('h_23'));
                    const heatingF = (heatingC * 9/5) + 32;
                    AppState.setValue('i_23', Math.round(heatingF), 'calculated');
                    
                    // Calculate cooling setpoint Fahrenheit
                    const coolingC = parseFloat(AppState.getValue('h_24'));
                    const coolingF = (coolingC * 9/5) + 32;
                    AppState.setValue('i_24', Math.round(coolingF), 'calculated');
                    
                    // Calculate ground facing HDD
                    const daysCoolingValue = parseFloat(AppState.getValue('m_19'));
                    const heatingDays = 365 - daysCoolingValue;
                    const gfHddValue = Math.round((heatingC - 10) * heatingDays);
                    AppState.setValue('d_22', gfHddValue, 'calculated');
                    
                    // Calculate ground facing CDD based on capacitance setting
                    const capacitanceSetting = AppState.getValue('h_21');
                    const gfCddValue = capacitanceSetting === 'Static'
                        ? Math.max(0, (10 - coolingC) * daysCoolingValue)
                        : (10 - coolingC) * daysCoolingValue;
                    AppState.setValue('h_22', Math.round(gfCddValue), 'calculated');
                    
                    // Calculate cooling percentage
                    const coolingOverrideValue = parseFloat(AppState.getValue('l_24'));
                    const coolingPercent = Math.round((coolingOverrideValue / 22) * 100);
                    AppState.setValue('m_24', coolingPercent + '%', 'calculated');
                    
                    logDebug('Calculations complete');
                }
            };
            
            // Subscribe to state changes to update UI
            function setupStateObservers() {
                // Set up listeners for all state values that need to update the UI
                Object.keys(AppState.values).forEach(fieldId => {
                    AppState.addListener(fieldId, (value) => {
                        // Update UI when state changes
                        updateUIFromState(fieldId, value);
                    });
                });
            }
            
            // Update UI element from state value
            function updateUIFromState(fieldId, value) {
                const element = DOMElements.get(fieldId);
                if (!element) return;
                
                // Different handling based on element type
                if (element.tagName === 'SELECT') {
                    element.value = value;
                } else if (element.tagName === 'INPUT' && element.type === 'range') {
                    element.value = value;
                } else if (element.isContentEditable) {
                    // Only update if not currently being edited
                    if (!element.classList.contains('editing')) {
                        element.textContent = value;
                    }
                } else {
                    // Format value differently based on field type
                    let displayValue = value;
                    
                    // Apply formatting based on field type
                    if (fieldId.startsWith('d_') || fieldId.startsWith('h_') || 
                        fieldId.startsWith('e_') || fieldId.startsWith('i_') || 
                        fieldId.startsWith('l_')) {
                        // For numeric fields
                        if (typeof value === 'number') {
                            if (fieldId === 'j_19') {
                                // Climate zone has 1 decimal place
                                displayValue = value.toFixed(1);
                            } else {
                                // Integer values
                                displayValue = Math.round(value);
                            }
                        }
                    }
                    
                    // Update element content
                    element.textContent = displayValue;
                    
                    // Handle negative values
                    if (typeof value === 'number' && value < 0) {
                        element.classList.add('negative-value');
                    } else {
                        element.classList.remove('negative-value');
                    }
                }
            }
            
            // Application initialization
            function initializeApplication() {
                // First ensure climate data is available
                ClimateDataService.ensureAvailable(function() {
                    // Initialize UI components
                    UIController.initialize();
                    
                    // Set up state observers
                    setupStateObservers();
                    
                    // Populate province dropdown
                    UIController.populateProvinceDropdown();
                    
                    logDebug('Application initialized successfully');
                });
            }
            
            // Initialize when DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                initializeApplication();
            });
            
            // Initialize immediately if DOM is already loaded
            if (document.readyState === 'interactive' || document.readyState === 'complete') {
                initializeApplication();
            }
        })();
    </script>
</body>
</html> 