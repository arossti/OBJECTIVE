<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S03 Climate Calculations - REFERENCE MODE</title>

    <!-- Link to production 4011RF styles for reference mode consistency -->
    <link rel="stylesheet" href="../../OBJECTIVE 4011RF/4011-styles.css" />
    
    <!-- Import climate data only -->
    <script src="../core/data/4012-ClimateValues.js"></script>

    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }

      /* Section container */
      .section-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }

      /* Section header */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      /* Reference mode toggle */
      .reference-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .reference-toggle label {
        font-weight: 500;
        color: #666;
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 24px;
        background-color: #ccc;
        border-radius: 12px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .toggle-switch.active {
        background-color: #2196f3;
      }

      .toggle-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .toggle-switch.active .toggle-slider {
        transform: translateX(26px);
      }

      /* Weather data button */
      .weather-data-btn {
        padding: 8px 16px;
        background-color: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
      }

      .weather-data-btn:hover {
        background-color: #1976d2;
      }

      /* Table styles */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th {
        background-color: #f5f5f5;
        padding: 10px 8px;
        text-align: left;
        font-weight: 600;
        color: #666;
        border-bottom: 2px solid #e0e0e0;
      }

      td {
        padding: 10px 8px;
        border-bottom: 1px solid #e0e0e0;
        vertical-align: middle;
      }

      /* Field styles */
      .row-id {
        font-weight: 600;
        color: #666;
        width: 60px;
      }

      .row-label {
        font-weight: 500;
        color: #333;
        min-width: 200px;
      }

      .label-prefix {
        font-weight: 600;
        color: #666;
        text-align: right;
        padding-right: 4px;
      }

      .label-main {
        font-weight: 500;
        color: #333;
      }

      .unit-label {
        color: #666;
        font-size: 12px;
      }

      /* Calculated values - MUST be black bold on grey */
      .calculated-value {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: bold;
        color: #000 !important;
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
        display: inline-block;
        min-width: 60px;
        text-align: center;
      }

      /* User input editable fields - MUST be blue bold */
      .user-input.editable {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: bold;
        color: #0066cc !important;
        background-color: #f0f7ff !important;
        border: 1px solid #0066cc;
        display: inline-block;
        min-width: 60px;
        text-align: center;
        cursor: text;
      }

      .user-input.editable:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
      }

      /* Value cells - calculated/derived values */
      .value-cell {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: bold;
        color: #000 !important;
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
        text-align: center;
        min-width: 80px;
        display: inline-block;
      }

      /* External lookup values (HDD/CDD) - Yellow highlight */
      .value-cell.external-lookup,
      .calculated-value.external-lookup {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border-color: #ffeaa7;
      }

      /* Missing/null values */
      .value-cell.missing-value,
      .calculated-value.missing-value {
        color: #6c757d !important;
        font-style: italic;
        font-weight: normal;
      }

      /* Reference values */
      .reference-value {
        color: #ff5722;
        background-color: #fff3e0;
      }

      .reference-label {
        color: #ff5722;
        font-style: italic;
        font-size: 12px;
      }

      /* Reference mode styles now handled by production 4011-styles.css */
      /* Using body.viewing-reference-inputs and .reference-input-display-locked classes */

      /* Exempt the timeframe dropdown from reference mode lockdown */
      #timeframeSelect {
        /* This will remain active in reference mode */
      }

      /* User input fields */
      .user-input {
        padding: 4px 8px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 60px;
        text-align: center;
        transition: all 0.2s;
      }

      .user-input.editable {
        cursor: text;
      }

      .user-input.editable:hover {
        border-color: #2196f3;
        background-color: #f0f8ff;
      }

      .user-input.editable:focus,
      .user-input.editable.editing {
        outline: none;
        border-color: #2196f3;
        background-color: #fff;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
      }

      /* Dropdown styles */
      .dropdown-container {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .dropdown-select {
        width: 100%;
        padding: 8px 36px 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        font-size: 0.95rem;
        font-weight: 500;
        color: #333;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg width='12' height='6' viewBox='0 0 12 6' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M0 0l6 6 6-6z' fill='%23333'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
        transition: all 0.2s;
      }

      .dropdown-select:hover {
        border-color: #0066cc;
      }

      .dropdown-select:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
      }

      .dropdown-select:disabled {
        background-color: #f5f5f5;
        color: #999;
        cursor: not-allowed;
      }

      /* Slider styles */
      .slider-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .slider {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #2196f3;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #2196f3;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .slider-value {
        font-weight: 500;
        color: #333;
        min-width: 40px;
        text-align: center;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        position: relative;
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 5px;
        width: 70%;
        max-width: 700px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
      }

      .close-btn:hover {
        color: #333;
      }

      .modal-body {
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
      }

      .data-row {
        display: flex;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .data-label {
        flex: 1;
        font-weight: 500;
      }

      .data-value {
        flex: 1;
        text-align: right;
      }

      /* Debug section */
      .debug-info {
        margin-top: 30px;
        padding: 10px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        height: 200px;
        overflow-y: auto;
      }

      /* State indicator */
      .state-indicator {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 20px;
      }

      .state-indicator.target {
        background-color: #e3f2fd;
        color: #1976d2;
      }

      .state-indicator.reference {
        background-color: #ffebee;
        color: #c62828;
      }

      /* Input fields */
      .input-field {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: all 0.2s;
      }

      /* Editable input fields */
      .input-field:not(:disabled):not(.reference-value) {
        color: #0066cc;
        font-weight: bold;
        background-color: #f0f7ff;
      }

      .input-field:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
      }

      /* Non-editable fields */
      .input-field:disabled:not(.reference-value) {
        background-color: #f8f9fa;
        color: #000;
        font-weight: 600;
        cursor: not-allowed;
      }

      /* Reference mode fields */
      .reference-value {
        color: #dc3545 !important;
        font-weight: bold !important;
        font-style: italic !important;
        background-color: #fee !important;
        border-color: #dc3545 !important;
      }

      /* Inline calculations */
      .calculation-group {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.875rem;
      }

      .calculation-label {
        color: #666;
        min-width: 60px;
      }

      .calculation-value {
        font-weight: 600;
        color: #000;
        padding: 4px 8px;
        background-color: #f8f9fa;
        border-radius: 4px;
        min-width: 60px;
        text-align: center;
      }

      /* Override checkbox container */
      .override-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .override-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .override-label {
        font-size: 0.875rem;
        color: #666;
        cursor: pointer;
        user-select: none;
      }

      /* Cooling override input - make text blue */
      #coolingOverrideValue {
        color: #0066cc !important;
        background-color: #f0f7ff !important;
      }

      /* External lookup values (HDD/CDD Ref Lookup) - Yellow highlight for HTTP links */
      .value-cell.external-lookup,
      .calculated-value.external-lookup,
      .reference-value.external-lookup {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border: 1px solid #ffeaa7;
        cursor: pointer;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: bold;
        text-align: center;
        transition: all 0.2s;
      }

      button.reference-value.external-lookup {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border: 1px solid #ffeaa7;
        font-family: inherit;
      }

      .reference-value.external-lookup:hover {
        background-color: #ffeaa7 !important;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Cell Type Naming Convention:
           dd = dropdown
           sl = slider  
           ref = reference
           dv = derived values
           cf = calculated fields
           ue = user editable
           el = external lookup
        */

      /* dd - Dropdown styles - Use Bootstrap defaults with consistent font */
      .cell-dd select,
      select.form-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #fff;
        font-size: 0.95rem;
        font-weight: 500;
        color: #333;
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg width='12' height='6' viewBox='0 0 12 6' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M0 0l6 6 6-6z' fill='%23333'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
        padding-right: 36px;
        transition: all 0.2s;
      }

      /* Editable dropdown styling */
      .cell-dd select:not(:disabled):not(.reference-value) {
        color: #0066cc;
        font-weight: bold;
      }

      .cell-dd select:hover:not(:disabled) {
        border-color: #0066cc;
      }

      .cell-dd select:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
      }

      /* Dropdown options */
      .cell-dd select option {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        font-weight: normal;
        padding: 8px;
      }

      /* Dropdown cells */
      .cell-dd,
      .dropdown-cell {
        min-width: 140px;
        padding: 2px 8px !important;
      }

      /* sl - Slider styles - Match 4011 styling */
      .cell-sl {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95rem;
      }

      .cell-sl .slider {
        width: 100%;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
        height: 5px;
        background: #ddd;
        outline: none;
        opacity: 0.7;
        transition: opacity 0.2s;
        border-radius: 5px;
      }

      .cell-sl .slider:hover {
        opacity: 1;
      }

      .cell-sl .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 15px;
        height: 15px;
        background: #0066cc;
        cursor: pointer;
        border-radius: 50%;
      }

      .cell-sl .slider::-moz-range-thumb {
        width: 15px;
        height: 15px;
        background: #0066cc;
        cursor: pointer;
        border-radius: 50%;
        border: none;
      }

      /* Slider value display - Match 4011 styling */
      .cell-sl .slider-value {
        display: inline-block;
        min-width: 50px;
        text-align: center;
        font-weight: 500;
        color: #0066cc !important; /* Blue text like 4011 */
        cursor: pointer;
      }

      /* dv - Derived values (calculated/non-editable) */
      .cell-dv {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: bold;
        color: #000 !important;
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
        display: inline-block;
        min-width: 60px;
        text-align: center;
      }

      /* cf - Calculated fields */
      .cell-cf {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: bold;
        color: #000 !important;
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
        display: inline-block;
        min-width: 60px;
        text-align: center;
      }

      /* ue - User editable fields */
      .cell-ue {
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: bold;
        color: #0066cc !important;
        background-color: #f0f7ff !important;
        border: 1px solid #0066cc;
        display: inline-block;
        min-width: 60px;
        text-align: center;
        cursor: text;
      }

      .cell-ue:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
      }

      /* el - External lookup (HTTP links) */
      .cell-el {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border: 1px solid #ffeaa7 !important;
        cursor: pointer;
        text-decoration: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: bold;
        text-align: center;
        transition: all 0.2s;
        white-space: nowrap; /* Prevent wrapping */
        display: inline-block;
      }

      button.cell-el {
        font-family: inherit;
      }

      .cell-el:hover {
        background-color: #ffeaa7 !important;
        border-color: #ffe8a1 !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* ref - Reference mode styles */
      .cell-ref {
        color: #dc3545 !important;
        font-weight: bold !important;
        font-style: italic !important;
        background-color: #fee !important;
        border-color: #dc3545 !important;
      }

      /* Missing/null values */
      .cell-missing {
        color: #6c757d !important;
        font-style: italic;
        font-weight: normal;
      }

      /* Reference mode overrides now handled by production styles */

      /* Global font family - ensure sans-serif everywhere */
      body,
      select,
      option,
      input,
      button {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
      }
    </style>
  </head>
  <body>
    <div class="section-container">
      <div class="section-header">
        <h2 class="section-title">
          SECTION 3. Climate Calculations
          <span id="stateIndicator" class="state-indicator reference"
            >REFERENCE MODE</span
          >
        </h2>
        <div style="display: flex; gap: 20px; align-items: center">
          <button id="showWeatherDataBtn" class="weather-data-btn">
            More Weather Data
          </button>
          <a href="4012 S03 Target.html" style="padding: 8px 16px; background-color: #1976d2; color: white; text-decoration: none; border-radius: 4px; font-weight: 500;">
            Switch to Target Mode
          </a>
        </div>
      </div>

      <div class="section-content">
        <table>
          <thead>
            <tr>
              <th>03-ID</th>
              <th>Climate Units</th>
              <th>°C</th>
              <th>°F</th>
              <th>F</th>
              <th>G</th>
              <th>°C</th>
              <th>°F</th>
              <th>J</th>
              <th>K</th>
              <th>L</th>
              <th>M</th>
              <th>N</th>
            </tr>
          </thead>
          <tbody>
            <!-- Province Row -->
            <tr data-id="L.1.1">
              <td class="row-id">L.1.1</td>
              <td class="row-label">Province</td>
              <td colspan="2">
                <div class="dropdown-container">
                  <select
                    id="provinceSelect"
                    class="cell-dd"
                    data-field-id="d_19"
                    data-dropdown-id="dd_d_19"
                  >
                    <option value="">Select Province</option>
                  </select>
                </div>
              </td>
              <td></td>
              <td class="label-prefix">L.1.2</td>
              <td class="label-main">City</td>
              <td>
                <div class="dropdown-container">
                  <select
                    id="citySelect"
                    class="cell-dd"
                    data-field-id="h_19"
                    data-dropdown-id="dd_h_19"
                    disabled
                  >
                    <option value="">Select City</option>
                  </select>
                </div>
              </td>
              <td>Climate Zone</td>
              <td>
                <span id="climateZone" class="cell-cf" data-field-id="j_19"
                  >4.0</span
                >
              </td>
              <td class="label-prefix">L.3.3</td>
              <td class="label-main">Days Cooling</td>
              <td>
                <span
                  id="daysCooling"
                  class="cell-ue"
                  data-field-id="m_19"
                  contenteditable="true"
                  >120</span
                >
              </td>
            </tr>

            <!-- Heating Degree Days Row -->
            <tr data-id="L.2.1">
              <td class="row-id">L.2.1</td>
              <td class="row-label">Heating Degree Days (HDD)</td>
              <td>
                <span id="hdd" class="cell-dv" data-field-id="d_20">0</span>
              </td>
              <td></td>
              <td class="label-prefix">L.2.2</td>
              <td class="label-main">Current or Future Values</td>
              <td>
                <div class="dropdown-container reference-exempt">
                  <select
                    id="timeframeSelect"
                    class="cell-dd reference-exempt"
                    data-field-id="h_20"
                    data-dropdown-id="dd_h_20"
                  >
                    <option value="Present">Present (1991-2020)</option>
                    <option value="Future">Future (2021-2050)</option>
                  </select>
                </div>
              </td>
              <td></td>
              <td>
                <button id="hdd_ref_lookup" class="cell-el">
                  HDD Ref Lookup
                </button>
              </td>
              <td>
                <span class="reference-label">HDD - Energy Star</span>
              </td>
              <td></td>
              <td></td>
              <td></td>
            </tr>

            <!-- Cooling Degree Days Row -->
            <tr data-id="L.2.3">
              <td class="row-id">L.2.3</td>
              <td class="row-label">Cooling Degree Days (CDD)</td>
              <td>
                <span id="cdd" class="cell-dv" data-field-id="d_21">0</span>
              </td>
              <td></td>
              <td class="label-prefix">G.4.2</td>
              <td class="label-main">Capacitance</td>
              <td>
                <div class="dropdown-container">
                  <select
                    id="capacitanceSelect"
                    class="cell-dd"
                    data-field-id="h_21"
                    data-dropdown-id="dd_h_21"
                  >
                    <option value="Static">Static</option>
                    <option value="Capacitance" selected>Capacitance</option>
                  </select>
                </div>
              </td>
              <td>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    width: 100%;
                  "
                >
                  <input
                    type="range"
                    id="capacitance_slider"
                    class="slider"
                    min="0"
                    max="100"
                    value="50"
                    style="flex: 1"
                  />
                  <span id="capacitance_value" class="slider-value">50%</span>
                </div>
              </td>
              <td>
                <button id="cdd_ref_lookup" class="cell-el">
                  CDD Ref Lookup
                </button>
              </td>
              <td>
                <span class="reference-label">CDD - Energy Star</span>
              </td>
              <td></td>
              <td></td>
              <td></td>
            </tr>

            <!-- Ground Facing & Elevation Row -->
            <tr data-id="L.2.4">
              <td class="row-id">L.2.4</td>
              <td class="row-label">Ground Facing GF HDD</td>
              <td>
                <span id="gfHdd" class="cell-dv" data-field-id="d_22"
                  >1960</span
                >
              </td>
              <td class="unit-label">°C•days</td>
              <td class="label-prefix">L.2.5</td>
              <td class="label-main">GF CDD</td>
              <td>
                <span id="gfCdd" class="cell-dv" data-field-id="h_22">0</span>
              </td>
              <td class="unit-label">°C•days</td>
              <td class="label-prefix">L.1.3</td>
              <td class="label-main">Elevation (ASL)</td>
              <td>
                <span id="elevation" class="cell-dv" data-field-id="l_22"
                  >0</span
                >
              </td>
              <td class="unit-label">m</td>
              <td></td>
            </tr>

            <!-- Coldest Days Row -->
            <tr data-id="L.3.1">
              <td class="row-id">L.3.1</td>
              <td class="row-label">Coldest Days (Location Specific)</td>
              <td>
                <span id="coldestDays" class="cell-dv" data-field-id="d_23"
                  >0</span
                >
              </td>
              <td>
                <span id="coldestDaysF" class="cell-dv" data-field-id="e_23"
                  >32</span
                >
              </td>
              <td class="label-prefix">B.1.2</td>
              <td class="label-main">Tset Heating</td>
              <td>
                <span id="tsetHeating" class="cell-dv" data-field-id="h_23"
                  >18</span
                >
              </td>
              <td>
                <span id="tsetHeatingF" class="cell-dv" data-field-id="i_23"
                  >64</span
                >
              </td>
              <td></td>
              <td></td>
              <td></td>
              <td>
                <span id="heatingPercent" class="cell-dv" data-field-id="m_23"
                  >0%</span
                >
              </td>
              <td></td>
            </tr>

            <!-- Hottest Days Row -->
            <tr data-id="L.3.2">
              <td class="row-id">L.3.2</td>
              <td class="row-label">Hottest Days (Location Specific)</td>
              <td>
                <span id="hottestDays" class="cell-dv" data-field-id="d_24"
                  >0</span
                >
              </td>
              <td>
                <span id="hottestDaysF" class="cell-dv" data-field-id="e_24"
                  >32</span
                >
              </td>
              <td class="label-prefix">B.1.3</td>
              <td class="label-main">Tset Cooling</td>
              <td>
                <span id="tsetCooling" class="cell-dv" data-field-id="h_24"
                  >24</span
                >
              </td>
              <td>
                <span id="tsetCoolingF" class="cell-dv" data-field-id="i_24"
                  >75</span
                >
              </td>
              <td class="label-prefix">B.1.4</td>
              <td class="label-main">Cooling Override</td>
              <td>
                <span
                  id="coolingOverride"
                  class="cell-ue"
                  data-field-id="l_24"
                  contenteditable="true"
                  >24</span
                >
              </td>
              <td>
                <span id="coolingPercent" class="cell-dv" data-field-id="m_24"
                  >109%</span
                >
              </td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Weather Data Modal -->
    <div id="weatherDataModal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 id="weatherDataModalTitle">Weather Data</h3>
        <div id="weatherDataContent" class="modal-body"></div>
      </div>
    </div>

    <div id="debugInfo" class="debug-info"></div>

    <!-- Include ClimateValues.js -->
    <script src="../core/data/4012-ClimateValues.js"></script>

    <script>
      // Initialize namespace
      window.TEUI = window.TEUI || {};

      // Add formatNumber function from 4011-StateManager.js for slider display
      window.TEUI.formatNumber = function (value, formatType = "number-2dp") {
        // Handle N/A or null/undefined input first
        if (
          value === null ||
          value === undefined ||
          String(value).trim().toUpperCase() === "N/A"
        ) {
          return "N/A";
        }
        // Handle raw format type
        if (formatType === "raw") {
          return String(value);
        }

        // Use global parseNumeric to get a clean number or NaN
        const numValue = window.TEUI.parseNumeric(value, NaN);

        // Handle non-numeric values after parsing
        if (isNaN(numValue)) {
          // Return original string if it wasn't parseable but wasn't explicitly N/A
          if (typeof value === "string" && value.trim() !== "") return value;
          // Otherwise return a default based on expected format
          if (formatType.startsWith("percent")) return "0%";
          if (formatType.startsWith("currency")) return "$0.00"; // Basic currency default
          return "0.00"; // Default numeric format
        }

        try {
          // Handle Aliases
          if (formatType === "u-value") formatType = "number-3dp";
          if (formatType === "rsi") formatType = "number-2dp";

          // Handle Integer types first
          if (formatType === "integer") {
            return numValue.toLocaleString(undefined, {
              minimumFractionDigits: 0,
              maximumFractionDigits: 0,
              useGrouping: true,
            }); // With commas
          }
          if (formatType === "integer-nocomma") {
            return numValue.toLocaleString(undefined, {
              minimumFractionDigits: 0,
              maximumFractionDigits: 0,
              useGrouping: false,
            }); // No commas
          }

          // Parsing complex format types
          const formatParts = formatType.split("-");
          let type = formatParts[0]; // 'number', 'percent', 'cad'
          const dpPart = formatParts[1] || ""; // e.g., '0dp', '2dp', '3dp', '4dp'
          const useCommas = formatParts.includes("comma");

          let decimals = 2; // Default decimal places
          if (dpPart) {
            const match = dpPart.match(/(\d+)d/);
            if (match) decimals = parseInt(match[1], 10);
          }

          // Percentage Formatting
          if (type === "percent") {
            return numValue.toLocaleString(undefined, {
              style: "percent",
              minimumFractionDigits: decimals,
              maximumFractionDigits: decimals,
            });
          }
          // CAD Currency Formatting (using toFixed)
          else if (type === "cad") {
            if (isNaN(decimals) || decimals < 0) decimals = 2; // Safety check
            const fixedString = numValue.toFixed(decimals);
            // Basic comma insertion - might need refinement for edge cases
            let finalString = fixedString;
            if (useCommas) {
              const parts = fixedString.split(".");
              parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
              finalString = parts.join(".");
            }
            return "$" + finalString;
          }
          // Number Formatting (Default)
          else {
            return numValue.toLocaleString(undefined, {
              minimumFractionDigits: decimals,
              maximumFractionDigits: decimals,
              useGrouping: useCommas,
            });
          }
        } catch (e) {
          console.error(
            `Error formatting value ${value} with format ${formatType}:`,
            e,
          );
          return String(value); // Fallback to string representation on error
        }
      };

      // Add parseNumeric function from 4011-StateManager.js
      window.TEUI.parseNumeric = function (value, defaultValue = 0) {
        if (value === null || value === undefined) {
          return defaultValue;
        }
        let numericValue;
        if (typeof value === "string") {
          // Remove commas, trim whitespace
          const cleanedValue = value.replace(/,/g, "").trim();
          if (cleanedValue === "" || cleanedValue.toUpperCase() === "N/A") {
            return defaultValue;
          }
          numericValue = parseFloat(cleanedValue);
        } else if (typeof value === "number") {
          numericValue = value;
        } else {
          numericValue = NaN; // Handle other types if needed
        }
        // Return defaultValue if parsing resulted in NaN
        return isNaN(numericValue) ? defaultValue : numericValue;
      };

      // Dual state management for Target and Reference modes
      (function () {
        // Number formatting system (similar to 4011-StateManager)
        const NumberFormat = {
          formats: {
            "0dp": (value) => Math.round(value).toString(),
            "1dp": (value) => value.toFixed(1),
            "2dp": (value) => value.toFixed(2),
            percent: (value) => Math.round(value) + "%",
            currency: (value) => "$" + value.toFixed(2),
            temperature: (value) => Math.round(value) + "°C",
            temperatureF: (value) => Math.round(value) + "°F",
          },

          format: function (value, format) {
            if (
              value === null ||
              value === undefined ||
              value === 666 ||
              isNaN(value)
            ) {
              return "N/A";
            }

            const formatter = this.formats[format];
            if (formatter) {
              return formatter(value);
            }

            return value.toString();
          },
        };

        // REFERENCE-ONLY State Management (completely isolated - no shared globals)
        const DualState = {
          state: {},
          listeners: {},

          setValue: function(fieldId, value, source = "user") {
            this.state[fieldId] = value;
            this.notifyListeners(fieldId, value);
            logDebug(`REFERENCE setValue: ${fieldId} = ${value} (${source})`);
          },

          getValue: function(fieldId) {
            return this.state[fieldId];
          },

          addListener: function(fieldId, callback) {
            if (!this.listeners[fieldId]) {
              this.listeners[fieldId] = [];
            }
            this.listeners[fieldId].push(callback);
          },

          notifyListeners: function(fieldId, value) {
            if (this.listeners[fieldId]) {
              this.listeners[fieldId].forEach(callback => callback(value));
            }
          },

          initialize: function() {
            logDebug("REFERENCE STATE: Initializing completely isolated state");
            // Reference mode defaults - completely separate from any other file
            this.state = {
              'd_19': 'BC',         // Province (different from Target)
              'h_19': 'Vancouver',  // City (different from Target)
              'h_20': 'Present',    // Timeframe
              'h_21': 'Capacitance', // Capacitance setting
              'h_23': 18,           // Heating setpoint
              'h_24': 24,           // Cooling setpoint
              'm_19': 120,          // Days cooling
              'i_21': 50            // Capacitance percentage
            };
          }
        };

        // DOM element cache
        const DOMElements = {
          provinceSelect: null,
          citySelect: null,
          timeframeSelect: null,
          capacitanceSelect: null,
          capacitanceSlider: null,
          capacitanceValue: null,
          referenceToggle: null,
          stateIndicator: null,
          sectionContent: null,
          calculatedFields: {},
          editableFields: {},
          debugInfo: null,

          init: function () {
            if (this.initialized) return;

            this.provinceSelect = document.getElementById("provinceSelect");
            this.citySelect = document.getElementById("citySelect");
            this.timeframeSelect = document.getElementById("timeframeSelect");
            this.capacitanceSelect = document.getElementById("capacitanceSelect");
            this.capacitanceSlider = document.getElementById("capacitance_slider");
            this.capacitanceValue = document.getElementById("capacitance_value");
            // referenceToggle removed - this is Reference-only mode
            this.stateIndicator = document.getElementById("stateIndicator");
            this.sectionContent = document.querySelector(".section-content");
            this.debugInfo = document.getElementById("debugInfo");

            // Cache all calculated fields
            const calculatedElements = document.querySelectorAll("[data-field-id]");
            calculatedElements.forEach((element) => {
              const fieldId = element.getAttribute("data-field-id");
              if (fieldId) {
                this.calculatedFields[fieldId] = element;
              }
            });

            // Cache editable fields
            const editableElements = document.querySelectorAll(".editable");
            editableElements.forEach((element) => {
              const fieldId = element.getAttribute("data-field-id");
              if (fieldId) {
                this.editableFields[fieldId] = element;
              }
            });

            this.initialized = true;
          },

          get: function (id) {
            if (!this.initialized) this.init();

            if (this[id]) return this[id];
            if (this.calculatedFields[id]) return this.calculatedFields[id];

            return document.querySelector(`[data-field-id="${id}"]`);
          },
        };

        // Debug logging
        function logDebug(message, obj) {
          console.log(message, obj);
          const debugElem = DOMElements.debugInfo;
          if (debugElem) {
            const timestamp = new Date().toLocaleTimeString();
            let content = debugElem.innerHTML;

            let objString = "";
            if (obj !== undefined) {
              if (typeof obj === "object" && obj !== null) {
                try {
                  objString = JSON.stringify(obj, null, 2);
                } catch (e) {
                  objString = String(obj);
                }
              } else {
                objString = String(obj);
              }
            }

            content = `[${timestamp}] ${message} ${objString}\n` + content;
            debugElem.innerHTML = content;
          }
        }

        // ClimateData Access
        const ClimateDataService = {
          ensureAvailable: function (callback, maxRetries = 10) {
            let attempts = 0;

            const checkData = () => {
              attempts++;
              logDebug(
                `Checking climate data availability (attempt ${attempts}/${maxRetries})`,
              );

              if (
                window.TEUI?.ClimateData &&
                Object.keys(window.TEUI.ClimateData).length > 0
              ) {
                logDebug(
                  "Climate data available",
                  Object.keys(window.TEUI.ClimateData),
                );
                callback(window.TEUI.ClimateData);
                return;
              }

              if (attempts >= maxRetries) {
                logDebug("Error: Climate data not available after max retries");
                this.showDataError();
                return;
              }

              const delay = Math.min(100 * Math.pow(2, attempts), 2000);
              logDebug(`Will retry in ${delay}ms`);
              setTimeout(checkData, delay);
            };

            checkData();
          },

          showDataError: function () {
            const errorDiv = document.createElement("div");
            errorDiv.style.padding = "20px";
            errorDiv.style.margin = "20px 0";
            errorDiv.style.backgroundColor = "#ffebee";
            errorDiv.style.color = "#c62828";
            errorDiv.style.border = "1px solid #ef9a9a";
            errorDiv.style.borderRadius = "4px";

            errorDiv.innerHTML = `
                        <h3 style="margin-top:0">Climate Data Error</h3>
                        <p>The application was unable to load climate data from 4012-ClimateValues.js.</p>
                        <p>Please ensure the file is correctly loaded and contains valid data.</p>
                        <button id="retryButton" style="padding:8px 16px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer;">
                            Retry Loading
                        </button>
                    `;

            document.body.insertBefore(errorDiv, document.body.firstChild);

            document
              .getElementById("retryButton")
              .addEventListener("click", function () {
                errorDiv.remove();
                initializeApplication();
              });
          },

          getProvinces: function () {
            if (!window.TEUI?.ClimateData) return [];
            return Object.keys(window.TEUI.ClimateData).sort();
          },

          getCitiesForProvince: function (province) {
            if (!window.TEUI?.ClimateData || !window.TEUI.ClimateData[province])
              return [];
            return Object.keys(window.TEUI.ClimateData[province]).sort();
          },

          getCityData: function (province, city) {
            if (
              !window.TEUI?.ClimateData ||
              !window.TEUI.ClimateData[province] ||
              !window.TEUI.ClimateData[province][city]
            ) {
              return null;
            }
            return window.TEUI.ClimateData[province][city];
          },

          getProvinceFullName: function (abbr) {
            const provinceNames = {
              AB: "Alberta",
              BC: "British Columbia",
              MB: "Manitoba",
              NB: "New Brunswick",
              NL: "Newfoundland and Labrador",
              NS: "Nova Scotia",
              NT: "Northwest Territories",
              NU: "Nunavut",
              ON: "Ontario",
              PE: "Prince Edward Island",
              QC: "Québec",
              SK: "Saskatchewan",
              YT: "Yukon",
            };
            return provinceNames[abbr] || abbr;
          },
        };

        // UI Controller
        const UIController = {
          initialize: function () {
            DOMElements.init();
            this.setupEventListeners();
            this.setupEditableFields();
          },



          setupEventListeners: function () {
            const elements = DOMElements;

            // Province dropdown
            elements.provinceSelect.addEventListener("change", function () {
              const provinceValue = this.value;
              logDebug("Province changed to:", provinceValue);
              DualState.setValue("d_19", provinceValue, "user");
            });

            // Province change should update city options
            DualState.addListener("d_19", function (value) {
              UIController.updateCityDropdown(value);
            });

            // City dropdown
            elements.citySelect.addEventListener("change", function () {
              const cityValue = this.value;
              logDebug("City changed to:", cityValue);
              DualState.setValue("h_19", cityValue, "user");
            });

            // City change should update climate data
            DualState.addListener("h_19", function (value) {
              if (value) {
                UIController.updateClimateData();
              }
            });

            // Timeframe dropdown (exempt from reference lockdown)
            elements.timeframeSelect.addEventListener("change", function () {
              const timeframeValue = this.value;
              logDebug("Timeframe changed to:", timeframeValue);
              DualState.setValue("h_20", timeframeValue, "user");
            });

            // Timeframe change should update climate data
            DualState.addListener("h_20", function () {
              UIController.updateClimateData();
            });

            // Capacitance dropdown
            elements.capacitanceSelect.addEventListener("change", function () {
              const capacitanceValue = this.value;
              logDebug("Capacitance changed to:", capacitanceValue);
              DualState.setValue("h_21", capacitanceValue, "user");
            });

            // Capacitance change should recalculate
            DualState.addListener("h_21", function () {
              CalculationService.calculateAll();
            });

            // Slider
            elements.capacitanceSlider.addEventListener("input", function () {
              const value = this.value;
              capacitanceValue.textContent = window.TEUI.formatNumber(
                value / 100,
                "percent-0dp",
              );
              DualState.setValue("i_21", value);

              // Update calculations
              UIController.updateCalculations();
            });

            // Also listen to 'change' event for Safari compatibility
            elements.capacitanceSlider.addEventListener("change", function () {
              const value = this.value;
              capacitanceValue.textContent = window.TEUI.formatNumber(
                value / 100,
                "percent-0dp",
              );
              DualState.setValue("i_21", value);

              // Update calculations
              UIController.updateCalculations();
            });

            // Weather data button
            document
              .getElementById("showWeatherDataBtn")
              .addEventListener("click", function () {
                UIController.showWeatherDataModal();
              });

            // Modal close button
            document
              .querySelector(".close-btn")
              .addEventListener("click", function () {
                UIController.closeModal();
              });

            // Click outside modal to close
            window.addEventListener("click", function (event) {
              if (event.target === document.getElementById("weatherDataModal")) {
                UIController.closeModal();
              }
            });

            // Escape key to close modal
            document.addEventListener("keydown", function (event) {
              if (
                event.key === "Escape" &&
                document.getElementById("weatherDataModal").style.display === "block"
              ) {
                UIController.closeModal();
              }
            });
          },

          setupEditableFields: function () {
            const editableFields = document.querySelectorAll(".editable");

            editableFields.forEach((field) => {
              const fieldId = field.getAttribute("data-field-id");
              if (!fieldId) return;

              field.removeEventListener("blur", handleEditableBlur);
              field.addEventListener("blur", handleEditableBlur);

              field.addEventListener("keydown", function (e) {
                if (e.key === "Enter") {
                  e.preventDefault();
                  this.blur();
                }
              });

              field.addEventListener("focus", function () {
                this.classList.add("editing");
              });

              field.addEventListener("focusout", function () {
                this.classList.remove("editing");
              });
            });

            function handleEditableBlur() {
              const fieldId = this.getAttribute("data-field-id");
              if (!fieldId) return;

              const newValue = this.textContent.trim();
              const numericValue = parseFloat(newValue) || 0;
              DualState.setValue(fieldId, numericValue, "user");

              logDebug(`Editable field ${fieldId} changed to:`, numericValue);
              CalculationService.calculateAll();
            }
          },

          populateProvinceDropdown: function () {
            const provinceSelect = DOMElements.provinceSelect;

            while (provinceSelect.options.length > 1) {
              provinceSelect.remove(1);
            }

            const provinces = ClimateDataService.getProvinces();

            provinces.forEach((province) => {
              const option = document.createElement("option");
              option.value = province;
              option.textContent = ClimateDataService.getProvinceFullName(province);
              provinceSelect.appendChild(option);
            });

            logDebug("Populated province dropdown with options:", provinces);

            const defaultProvince = DualState.getValue("d_19") || "BC";
            provinceSelect.value = defaultProvince;

            if (provinceSelect.value) {
              DualState.setValue("d_19", provinceSelect.value, "init");
            }
          },

          updateCityDropdown: function (provinceValue) {
            const citySelect = DOMElements.citySelect;
            const dropdownContainer = citySelect.parentElement;

            while (citySelect.options.length > 1) {
              citySelect.remove(1);
            }

            if (!provinceValue) {
              citySelect.disabled = true;
              return;
            }

            const cities = ClimateDataService.getCitiesForProvince(provinceValue);

            if (cities.length === 0) {
              logDebug("No cities found for province:", provinceValue);
              citySelect.disabled = true;
              return;
            }

            cities.forEach((city) => {
              const option = document.createElement("option");
              option.value = city;
              option.textContent = city;
              citySelect.appendChild(option);
            });

            citySelect.disabled = false;

            if (dropdownContainer) {
              dropdownContainer.style.display = "";
            }

            let cityToSelect = "";
            if (provinceValue === "BC" && cities.includes("Vancouver")) {
              cityToSelect = "Vancouver";
            } else if (provinceValue === "QC" && cities.includes("Montreal")) {
              cityToSelect = "Montreal";  
            } else if (cities.length > 0) {
              cityToSelect = cities[0];
            }

            citySelect.value = cityToSelect;
            logDebug("Default city selected:", cityToSelect);

            DualState.setValue("h_19", cityToSelect, "init");
          },

          updateClimateData: function () {
            const province = DualState.getValue("d_19");
            const city = DualState.getValue("h_19");
            const timeframe = DualState.getValue("h_20");

            if (!province || !city) {
              logDebug("Cannot update climate data - missing province or city");
              return;
            }

            const cityData = ClimateDataService.getCityData(province, city);
            if (!cityData) {
              logDebug("No climate data found for:", { province, city });
              return;
            }

            // Update HDD18
            const hddValue =
              timeframe === "Future" ? cityData.HDD18_2021_2050 : cityData.HDD18;
            const hddElement = document.getElementById("l_21");
            if (hddElement) {
              if (hddValue === null || hddValue === undefined || hddValue === 666) {
                hddElement.textContent = "N/A";
                hddElement.className = "cell-missing";
              } else {
                hddElement.textContent = hddValue;
                hddElement.className = "cell-dv"; // Regular calculated value styling
              }
              DualState.setValue("l_21", hddValue);
            }

            // Also update the main HDD display
            const mainHddElement = document.getElementById("hdd");
            if (mainHddElement) {
              if (hddValue === null || hddValue === undefined || hddValue === 666) {
                mainHddElement.textContent = "N/A";
                mainHddElement.className = "cell-missing";
              } else {
                mainHddElement.textContent = hddValue;
                mainHddElement.className = "cell-dv"; // Regular calculated value styling
              }
              DualState.setValue("d_20", hddValue);
            }

            // Update CDD24
            const cddValue =
              timeframe === "Future" ? cityData.CDD24_2021_2050 : cityData.CDD24;
            const cddElement = document.getElementById("l_23");
            if (cddElement) {
              if (cddValue === null || cddValue === undefined || cddValue === 666) {
                cddElement.textContent = "N/A";
                cddElement.className = "cell-missing";

                // Check if we're using a fallback
                if (
                  timeframe === "Future" &&
                  cityData.CDD24 !== null &&
                  cityData.CDD24 !== undefined &&
                  cityData.CDD24 !== 666
                ) {
                  console.warn(
                    `Future CDD not available for ${city}, ${province}. Using present value as fallback.`,
                  );
                  cddElement.textContent = cityData.CDD24;
                  cddElement.className = "cell-dv"; // Regular calculated value styling
                  DualState.setValue("l_23", cityData.CDD24);
                }
              } else {
                cddElement.textContent = cddValue;
                cddElement.className = "cell-dv"; // Regular calculated value styling
                DualState.setValue("l_23", cddValue);
              }
            }

            // Also update the main CDD display
            const mainCddElement = document.getElementById("cdd");
            if (mainCddElement) {
              if (cddValue === null || cddValue === undefined || cddValue === 666) {
                mainCddElement.textContent = "N/A";
                mainCddElement.className = "cell-missing";

                // Check if we're using a fallback
                if (
                  timeframe === "Future" &&
                  cityData.CDD24 !== null &&
                  cityData.CDD24 !== undefined &&
                  cityData.CDD24 !== 666
                ) {
                  mainCddElement.textContent = cityData.CDD24;
                  mainCddElement.className = "cell-dv"; // Regular calculated value styling
                  DualState.setValue("d_21", cityData.CDD24);
                }
              } else {
                mainCddElement.textContent = cddValue;
                mainCddElement.className = "cell-dv"; // Regular calculated value styling
                DualState.setValue("d_21", cddValue);
              }
            }

            // Update other climate values
            const updates = [
              {
                id: "l_24",
                value: cityData.HDD18,
                label: "Ground Facing GF HDD",
              },
              { id: "l_25", value: cityData.CDD24, label: "GF CDD" },
              {
                id: "l_31",
                value: cityData.January_2_5,
                label: "Coldest Days",
              },
              {
                id: "l_32",
                value: cityData.July_2_5_Tdb,
                label: "Hottest Days",
              },
              { id: "l_13", value: cityData.Elevation_ASL, label: "Elevation" },
            ];

            updates.forEach((update) => {
              const element = document.getElementById(update.id);
              if (element) {
                if (
                  update.value === null ||
                  update.value === undefined ||
                  update.value === 666
                ) {
                  element.textContent = "N/A";
                  element.className = "cell-missing";
                } else {
                  element.textContent = update.value;
                  element.className = "cell-dv";
                }
                DualState.setValue(update.id, update.value);
              }
            });

            // Update calculations
            CalculationService.updateCalculations();
          },

          showWeatherDataModal: function () {
            const provinceValue = DualState.getValue("d_19");
            const cityValue = DualState.getValue("h_19");

            if (!provinceValue || !cityValue) {
              alert("Please select a province and city first.");
              return;
            }

            const cityData = ClimateDataService.getCityData(provinceValue, cityValue);

            if (!cityData) {
              alert(`No climate data found for ${cityValue}, ${provinceValue}`);
              return;
            }

            const weatherDataModalTitle = document.getElementById(
              "weatherDataModalTitle",
            );
            weatherDataModalTitle.textContent = `Weather Data for ${cityValue}, ${ClimateDataService.getProvinceFullName(provinceValue)}`;

            const weatherDataContent = document.getElementById("weatherDataContent");
            let formattedData = "";
            Object.entries(cityData).forEach(([key, value]) => {
              formattedData += `<div class="data-row"><div class="data-label">${key}</div><div class="data-value">${value}</div></div>`;
            });

            weatherDataContent.innerHTML = formattedData;
            document.getElementById("weatherDataModal").style.display = "block";
          },

          closeModal: function () {
            document.getElementById("weatherDataModal").style.display = "none";
          },

          updateCalculations: function () {
            // Implementation of updateCalculations method
          },
        };

        // Calculation Service
        const CalculationService = {
          calculateAll: function () {
            // Calculate climate zone based on HDD
            const hddValue = parseFloat(DualState.getValue("d_20"));
            let climateZoneValue = "6.0";

            if (hddValue < 3000) climateZoneValue = "4.0";
            else if (hddValue < 4000) climateZoneValue = "5.0";
            else if (hddValue < 5000) climateZoneValue = "6.0";
            else if (hddValue < 6000) climateZoneValue = "7.1";
            else if (hddValue < 7000) climateZoneValue = "7.2";
            else climateZoneValue = "8.0";

            DualState.setValue("j_19", climateZoneValue, "calculated");

            // Calculate Fahrenheit conversions
            const coldestC = parseFloat(DualState.getValue("d_23"));
            const coldestF = (coldestC * 9) / 5 + 32;
            DualState.setValue("e_23", Math.round(coldestF), "calculated");

            const hottestC = parseFloat(DualState.getValue("d_24"));
            const hottestF = (hottestC * 9) / 5 + 32;
            DualState.setValue("e_24", Math.round(hottestF), "calculated");

            // Calculate heating setpoint Fahrenheit
            const heatingC = parseFloat(DualState.getValue("h_23"));
            const heatingF = (heatingC * 9) / 5 + 32;
            DualState.setValue("i_23", Math.round(heatingF), "calculated");

            // Calculate cooling setpoint Fahrenheit
            const coolingC = parseFloat(DualState.getValue("h_24"));
            const coolingF = (coolingC * 9) / 5 + 32;
            DualState.setValue("i_24", Math.round(coolingF), "calculated");

            // Calculate ground facing HDD
            const daysCoolingValue = parseFloat(DualState.getValue("m_19"));
            const heatingDays = 365 - daysCoolingValue;
            const gfHddValue = Math.round((heatingC - 10) * heatingDays);
            DualState.setValue("d_22", gfHddValue, "calculated");

            // Calculate ground facing CDD based on capacitance setting
            const capacitanceSetting = DualState.getValue("h_21");
            const gfCddValue =
              capacitanceSetting === "Static"
                ? Math.max(0, (10 - coolingC) * daysCoolingValue)
                : (10 - coolingC) * daysCoolingValue;
            DualState.setValue("h_22", Math.round(gfCddValue), "calculated");

            // Calculate cooling percentage
            const coolingOverrideValue = parseFloat(DualState.getValue("l_24"));
            const coolingPercent = Math.round((coolingOverrideValue / 22) * 100);
            DualState.setValue("m_24", coolingPercent + "%", "calculated");

            logDebug("Calculations complete");
          },
          formatValue(value, isMissing = false) {
            if (
              value === null ||
              value === undefined ||
              value === 666 ||
              isNaN(value)
            ) {
              return { text: "N/A", className: "cell-missing" };
            }
            return { text: value.toString(), className: "" };
          },
          updateCalculations: function () {
            // Implementation of updateCalculations method
          },
        };

        // Subscribe to state changes to update UI
        function setupStateObservers() {
          const allFields = new Set([
            ...Object.keys(DualState.states.target),
            ...Object.keys(DualState.states.reference),
          ]);

          allFields.forEach((fieldId) => {
            DualState.addListener(fieldId, (value) => {
              updateUIFromState(fieldId, value);
            });
          });
        }

        // Update UI element from state value
        function updateUIFromState(fieldId, value) {
          const element = DOMElements.get(fieldId);
          if (!element) return;

          if (element.tagName === "SELECT") {
            element.value = value;
          } else if (element.tagName === "INPUT" && element.type === "range") {
            element.value = value;
          } else if (element.isContentEditable) {
            if (!element.classList.contains("editing")) {
              element.textContent = value;
            }
          } else {
            let displayValue = value;

            if (
              fieldId.startsWith("d_") ||
              fieldId.startsWith("h_") ||
              fieldId.startsWith("e_") ||
              fieldId.startsWith("i_") ||
              fieldId.startsWith("l_")
            ) {
              if (typeof value === "number") {
                if (fieldId === "j_19") {
                  displayValue = value.toFixed(1);
                } else {
                  displayValue = Math.round(value);
                }
              }
            }

            element.textContent = displayValue;

            if (typeof value === "number" && value < 0) {
              element.classList.add("negative-value");
            } else {
              element.classList.remove("negative-value");
            }
          }
        }

        // Application initialization
        function initializeApplication() {
          ClimateDataService.ensureAvailable(function () {
            // Initialize tuple architecture first
            DualState.initialize();
            
            UIController.initialize();
            UIController.populateProvinceDropdown();
            setupStateObservers();

            // Initialize temperature setpoints and timeframe
            DualState.setValue("h_23", 18, "init");
            DualState.setValue("h_24", 24, "init");
            DualState.setValue("h_20", "Present", "init");

            // Trigger city dropdown population after province is set
            const currentProvince = DualState.getValue("d_19");
            if (currentProvince) {
              UIController.updateCityDropdown(currentProvince);
            }

            logDebug("Application initialized successfully - REFERENCE MODE");
          });
        }

        // Start the application when DOM is ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initializeApplication);
        } else {
          initializeApplication();
        }

        // Export for testing
        window.S03Module = {
          DualState: DualState,
          ClimateDataService: ClimateDataService,
          UIController: UIController,
          CalculationService: CalculationService,
        };
      })();
    </script>
  </body>
</html>
