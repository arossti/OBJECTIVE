<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StateManager Toggle Test - CORRECTED PATTERNS</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 800px;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }
      .mode-indicator {
        font-size: 18px;
        font-weight: bold;
        padding: 8px 16px;
        border-radius: 4px;
      }
      .mode-target {
        background: #e3f2fd;
        color: #1976d2;
      }
      .mode-reference {
        background: #ffebee;
        color: #c62828;
      }

      .toggle-btn {
        padding: 10px 20px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }
      .toggle-btn:hover {
        background: #1976d2;
      }

      .test-field {
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .field-label {
        min-width: 150px;
        font-weight: 500;
      }
      .field-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 120px;
      }
      .field-value {
        font-weight: bold;
        color: #666;
        min-width: 100px;
      }

      .debug {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }

      .persistence-test {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
      }
      .persistence-test h3 {
        margin-top: 0;
        color: #2e7d32;
      }

      .reset-btn {
        background: #f44336;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h2>StateManager Toggle Test - CORRECTED PATTERNS</h2>
        <div>
          <span id="modeIndicator" class="mode-indicator mode-target"
            >TARGET MODE</span
          >
          <button id="toggleBtn" class="toggle-btn">Switch to Reference</button>
          <button id="resetBtn" class="reset-btn">Reset All</button>
        </div>
      </div>

      <div class="test-field">
        <label class="field-label">Province:</label>
        <select id="provinceSelect" class="field-input">
          <option value="ON">Ontario</option>
          <option value="BC">British Columbia</option>
          <option value="AB">Alberta</option>
        </select>
        <span class="field-value"
          >Target: <span id="targetProvince">ON</span> | Reference:
          <span id="refProvince">BC</span></span
        >
      </div>

      <div class="test-field">
        <label class="field-label">City:</label>
        <select id="citySelect" class="field-input">
          <option value="Alexandria">Alexandria</option>
          <option value="Vancouver">Vancouver</option>
          <option value="Calgary">Calgary</option>
        </select>
        <span class="field-value"
          >Target: <span id="targetCity">Alexandria</span> | Reference:
          <span id="refCity">Vancouver</span></span
        >
      </div>

      <div class="test-field">
        <label class="field-label">Capacitance (%):</label>
        <input
          type="range"
          id="capacitanceSlider"
          class="field-input"
          min="0"
          max="100"
          step="5"
        />
        <span class="field-value"
          >Target: <span id="targetCapacitance">50</span>% | Reference:
          <span id="refCapacitance">75</span>%</span
        >
      </div>

      <div class="persistence-test">
        <h3>ðŸŽ¯ PERSISTENCE TEST</h3>
        <p><strong>Instructions:</strong></p>
        <ol>
          <li>Change values in Target mode</li>
          <li>Switch to Reference mode and change different values</li>
          <li>Toggle back and forth - values should persist</li>
          <li>
            Refresh the page - values should be restored from localStorage
          </li>
        </ol>
      </div>

      <div id="debugLog" class="debug"></div>
    </div>

    <script>
      // âœ… MINIMAL STATEMANAGER - CORRECTED PATTERNS
      const StateManager = {
        fields: new Map(),
        listeners: new Map(),

        setValue: function (fieldId, value, state = "user-modified") {
          const oldValue = this.getValue(fieldId);
          this.fields.set(fieldId, { value, state, timestamp: Date.now() });
          this.notifyListeners(fieldId, value, oldValue, state);
          this.saveState();
          this.log(`setValue: ${fieldId} = ${value} (${state})`);
          return true;
        },

        getValue: function (fieldId) {
          const field = this.fields.get(fieldId);
          return field ? field.value : null;
        },

        addListener: function (fieldId, callback) {
          if (!this.listeners.has(fieldId)) {
            this.listeners.set(fieldId, new Set());
          }
          this.listeners.get(fieldId).add(callback);
        },

        notifyListeners: function (fieldId, newValue, oldValue, state) {
          if (!this.listeners.has(fieldId)) return;
          this.listeners.get(fieldId).forEach((callback) => {
            try {
              callback(newValue, oldValue, fieldId, state);
            } catch (error) {
              console.error(`Error in listener for ${fieldId}:`, error);
            }
          });
        },

        saveState: function () {
          try {
            const stateData = {};
            this.fields.forEach((field, fieldId) => {
              if (field.state !== "default") {
                stateData[fieldId] = field;
              }
            });
            localStorage.setItem("TEUI_TOGGLE_TEST", JSON.stringify(stateData));
            this.log(`Saved ${Object.keys(stateData).length} fields to localStorage`);
          } catch (e) {
            this.log("Error saving state: " + e.message);
          }
        },

        loadState: function () {
          try {
            const saved = localStorage.getItem("TEUI_TOGGLE_TEST");
            if (saved) {
              const stateData = JSON.parse(saved);
              Object.entries(stateData).forEach(([fieldId, field]) => {
                this.fields.set(fieldId, field);
              });
              this.log(
                `Loaded ${Object.keys(stateData).length} fields from localStorage`,
              );
              return true;
            }
          } catch (e) {
            this.log("Error loading state: " + e.message);
          }
          return false;
        },

        reset: function () {
          localStorage.removeItem("TEUI_TOGGLE_TEST");
          this.fields.clear();
          this.initialize();
          this.log("Reset all state to defaults");
        },

        initialize: function () {
          const loaded = this.loadState();

          if (!loaded) {
            // Set defaults only if no saved state
            this.setValue("target_d_19", "ON", "default");
            this.setValue("target_h_19", "Alexandria", "default");
            this.setValue("target_i_21", 50, "default");

            this.setValue("ref_d_19", "BC", "default");
            this.setValue("ref_h_19", "Vancouver", "default");
            this.setValue("ref_i_21", 75, "default");

            this.log("Initialized with defaults");
          } else {
            this.log("Initialized from saved state");
          }
        },

        log: function (message) {
          const debugLog = document.getElementById("debugLog");
          if (debugLog) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent =
              `[${timestamp}] ${message}\n` + debugLog.textContent;
          }
          console.log(message);
        },
      };

      // âœ… MODE MANAGER - PROPER STATEMANAGER INTEGRATION
      const ModeManager = {
        currentMode: "target",

        switchMode: function (mode) {
          if (this.currentMode === mode) return;

          this.currentMode = mode;
          StateManager.log(`Switched to ${mode.toUpperCase()} mode`);

          this.updateUI();
        },

        updateUI: function () {
          const indicator = document.getElementById("modeIndicator");
          const toggleBtn = document.getElementById("toggleBtn");

          if (this.currentMode === "target") {
            indicator.textContent = "TARGET MODE";
            indicator.className = "mode-indicator mode-target";
            toggleBtn.textContent = "Switch to Reference";
          } else {
            indicator.textContent = "REFERENCE MODE";
            indicator.className = "mode-indicator mode-reference";
            toggleBtn.textContent = "Switch to Target";
          }

          this.refreshFields();
          this.updateValueDisplays();
        },

        refreshFields: function () {
          const prefix = this.currentMode === "target" ? "target_" : "ref_";

          // Update province dropdown
          const provinceValue = StateManager.getValue(prefix + "d_19") || "ON";
          document.getElementById("provinceSelect").value = provinceValue;

          // Update city dropdown
          const cityValue = StateManager.getValue(prefix + "h_19") || "Alexandria";
          document.getElementById("citySelect").value = cityValue;

          // Update capacitance slider
          const capacitanceValue = StateManager.getValue(prefix + "i_21") || 50;
          document.getElementById("capacitanceSlider").value = capacitanceValue;
        },

        updateValueDisplays: function () {
          // Update Target displays
          document.getElementById("targetProvince").textContent =
            StateManager.getValue("target_d_19") || "ON";
          document.getElementById("targetCity").textContent =
            StateManager.getValue("target_h_19") || "Alexandria";
          document.getElementById("targetCapacitance").textContent =
            StateManager.getValue("target_i_21") || 50;

          // Update Reference displays
          document.getElementById("refProvince").textContent =
            StateManager.getValue("ref_d_19") || "BC";
          document.getElementById("refCity").textContent =
            StateManager.getValue("ref_h_19") || "Vancouver";
          document.getElementById("refCapacitance").textContent =
            StateManager.getValue("ref_i_21") || 75;
        },

        setValue: function (fieldId, value) {
          const prefix = this.currentMode === "target" ? "target_" : "ref_";
          StateManager.setValue(prefix + fieldId, value, "user-modified");
        },
      };

      // âœ… EVENT HANDLERS - NO DIRECT DOM MANIPULATION
      function setupEventHandlers() {
        // Province change
        document
          .getElementById("provinceSelect")
          .addEventListener("change", function () {
            ModeManager.setValue("d_19", this.value);
          });

        // City change
        document.getElementById("citySelect").addEventListener("change", function () {
          ModeManager.setValue("h_19", this.value);
        });

        // Capacitance change
        document
          .getElementById("capacitanceSlider")
          .addEventListener("input", function () {
            ModeManager.setValue("i_21", parseInt(this.value));
          });

        // Mode toggle
        document.getElementById("toggleBtn").addEventListener("click", function () {
          const newMode =
            ModeManager.currentMode === "target" ? "reference" : "target";
          ModeManager.switchMode(newMode);
        });

        // Reset button
        document.getElementById("resetBtn").addEventListener("click", function () {
          if (confirm("Reset all state? This will clear saved values.")) {
            StateManager.reset();
            ModeManager.updateUI();
          }
        });
      }

      // âœ… STATEMANAGER LISTENERS - PROPER UPDATE PATTERN
      function setupStateListeners() {
        // Listen to all Target field changes
        ["target_d_19", "target_h_19", "target_i_21"].forEach((fieldId) => {
          StateManager.addListener(fieldId, function (newValue) {
            ModeManager.updateValueDisplays();
          });
        });

        // Listen to all Reference field changes
        ["ref_d_19", "ref_h_19", "ref_i_21"].forEach((fieldId) => {
          StateManager.addListener(fieldId, function (newValue) {
            ModeManager.updateValueDisplays();
          });
        });
      }

      // âœ… INITIALIZATION
      document.addEventListener("DOMContentLoaded", function () {
        StateManager.initialize();
        setupEventHandlers();
        setupStateListeners();
        ModeManager.updateUI();

        StateManager.log(
          "âœ… CORRECTED PATTERNS: StateManager + Prefixes + Listeners + Persistence",
        );
      });
    </script>
  </body>
</html>
