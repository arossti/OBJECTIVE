<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2024 OBC Matrix Framework | Part 3</title>
    <meta
      name="description"
      content="Calculate Total Energy Use Intensity & Thermal Energy Demand Intensity for buildings"
    />

    <!-- CSS Resources -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Direct style override for select elements -->
    <style>
      select,
      option,
      .form-select,
      select.form-select {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif !important;
        /* Force sans-serif as fallback */
        font-family: sans-serif !important;
      }

      /* Notes Column Toggle Styles */
      .notes-column {
        transition: opacity 0.3s ease, width 0.3s ease;
      }

      /* Hide notes column when body has notes-hidden class */
      body.notes-hidden .notes-column {
        display: none;
      }

      /* Notes toggle button active state */
      #notes-toggle-btn.active {
        background-color: rgba(255,255,255,0.2);
      }

      /* Hide the separate notes panel - we're using column toggle instead */
      #global-notes-panel {
        display: none !important;
      }
    </style>

    <link href="OBC-styles.css" rel="stylesheet" />



    <!-- Core Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.4/dagre-d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>

    <!-- Core Logic & Managers FIRST -->
    <!-- <script src="OBC-ReferenceValues.js"></script> -->
    <!-- <script src="OBC-ReferenceManager.js"></script> -->
    <!-- <script src="OBC-ReferenceToggle.js"></script> -->
    <!-- Core State Management FIRST -->
    <script src="OBC-StateManager.js"></script>
    
    <!-- Universal Expandable Rows Utility -->
    <script src="OBC-ExpandableRows.js"></script>
    
    <script src="OBC-FieldManager.js"></script>
    <!-- FieldManager depends on StateManager -->
    <script src="OBC-ExcelMapper.js"></script>
    <script src="OBC-FileHandler.js"></script>

    <!-- Initialize everything AFTER core scripts are loaded -->
    <script src="OBC-Navigation.js"></script>

    <!-- Section modules LAST (they depend on core managers/utils) -->
    <script src="sections/OBC-Section01.js"></script>
    <script src="sections/OBC-Section02.js"></script>
    <script src="sections/OBC-Section03.js"></script>
    <script src="sections/OBC-Section04.js"></script>
    <script src="sections/OBC-Section05.js"></script>
    <script src="sections/OBC-Section06.js"></script>
    <script src="sections/OBC-Section07.js"></script>
    <script src="sections/OBC-Section08.js"></script>
    <script src="sections/OBC-Section09.js"></script>
    <script src="sections/OBC-Section10.js"></script>
  </head>
  <body>
    <!-- Main container -->
    <div class="col-lg-12 mx-auto p-4 py-md-5">
      <!-- Header -->
      <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
        <a
          href="https://openbuilding.ca"
          class="text-dark text-decoration-none"
        >
          <img
            src="assets/image041.png"
            class="logo"
            title="OBJECTIVE Logo"
            alt="OBJECTIVE 4.011 OBC Matrix"
          />
        </a>
        <div class="ms-auto text-end">
          <h1 class="mb-0 fs-4">
            2024 Ontario Building Code Data Matrix <br />
            Interactive Edition | v2025.06.05
          </h1>
        </div>
      </header>

      <!-- Action buttons row -->
      <div class="row button-row mb-2">
        <div class="col-12 text-end">
          <div
            class="col text-end controls-container d-flex align-items-center justify-content-end"
          >


            <button
              id="disclaimerBtn"
              class="btn btn-sm btn-warning me-2"
              data-bs-toggle="modal"
              data-bs-target="#disclaimerModal"
            >
              ⓘ Disclaimer
            </button>
            <button
              id="reset-imported-btn"
              type="button"
              class="btn btn-sm btn-success me-2"
              onclick="resetAllData()"
              title="Reset all data and clear saved state"
            >
              <i class="bi bi-arrow-clockwise"></i> Reset
            </button>
            <div class="btn-group">
              <button
                id="downloadBtn"
                type="button"
                class="btn btn-sm btn-primary"
              >
                ↓ Import/Export
              </button>
              <!-- Dropdown Toggle -->
              <button
                class="btn btn-sm btn-primary dropdown-toggle dropdown-toggle-split"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <span class="visually-hidden">Toggle Dropdown</span>
              </button>
              <!-- Dropdown Menu -->
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#" id="import-data-btn"
                    ><i class="bi bi-upload me-2"></i>Import Data (Excel/CSV)</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="export-data-btn"
                    ><i class="bi bi-save me-2"></i>Export User Data (CSV)</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" id="downloadReport"
                    >Download Report (PDF)</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="teui-factsheet"
                    >TEUI Factsheet (PDF)</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" id="tedi-factsheet"
                    >TEDI Factsheet (PDF)</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" id="export-excel"
                    ><i class="bi bi-file-earmark-spreadsheet me-2"></i>Export
                    All Data (Excel)</a
                  >
                </li>
              </ul>
            </div>
            <!-- Cross-Navigation to OBJECTIVE Calculator -->
            <button
              class="btn btn-sm btn-dark ms-2"
              onclick="saveStateAndNavigate('../index.html')"
              title="Switch to OBJECTIVE TEUI Calculator (saves current work)"
              style="transition: background-color 0.2s ease;"
              onmouseover="this.style.backgroundColor='#6c757d'"
              onmouseout="this.style.backgroundColor=''"
            >
              <i class="bi bi-building"></i> OBJECTIVE
            </button>
          </div>
          <!-- Hidden File Input for Import -->
          <input
            type="file"
            id="excel-file-input"
            accept=".xlsx, .xls, .csv"
            style="display: none"
          />

        </div>
      </div>

      <!-- Calculator container -->
      <div id="calculator-container">
        <!-- Section 1: Building Information -->
        <div id="buildingInfo" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-info-circle"></i></span>
            SECTION 1. Building Information
            <div class="ms-auto d-flex align-items-center">
              <button
                id="notes-toggle-btn"
                class="btn btn-sm btn-link text-white me-2"
                title="Toggle Notes Column"
              >
                <i class="bi bi-card-text"></i>
              </button>
              <button
                id="expand-collapse-all"
                class="btn btn-sm btn-link text-white me-2"
                title="Expand/Collapse All Sections"
              >
                <i class="bi bi-plus-circle"></i>
              </button>
              <button 
                class="layout-toggle-btn"
                title="Toggle Layout Mode"
              >
                <i class="bi bi-arrow-right-circle"></i>
              </button>
            </div>
          </div>
          <div class="section-content">
            <!-- Building Information content will be generated by FieldManager using Section01.js -->
            <div data-render-section="buildingInfo"></div>
          </div>
        </div>

        <!-- Spacer to maintain consistent gap - this prevents scrolling under Building Info -->
        <div class="tab-spacer"></div>

        <!-- Tab container for horizontal layout - positioned immediately after buildingInfo -->
        <div class="tab-container">
          <!-- Tabs will be generated by JavaScript -->
        </div>

        <!-- Section spacer to maintain proper distance between Building Info and active section -->
        <div id="section-spacer" class="section-spacer"></div>

        <!-- Section 2: Building Occupancy -->
        <div id="buildingOccupancy" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-building"></i></span>
            SECTION 2. Building Occupancy
          </div>
          <div class="section-content">
            <!-- Building Occupancy content will be generated by FieldManager using Section02.js -->
            <div data-render-section="buildingOccupancy"></div>
          </div>
        </div>

        <!-- Section 3: Building Areas -->
        <div id="buildingAreas" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-bounding-box"></i></span>
            SECTION 3. Building Areas
          </div>
          <div class="section-content">
            <!-- Building Areas content will be generated by FieldManager using Section03.js -->
            <div data-render-section="buildingAreas"></div>
          </div>
        </div>

        <!-- Section 4: Firefighting & Life Safety Systems -->
        <div id="firefightingSystems" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-fire"></i></span>
            SECTION 4. Firefighting & Life Safety Systems
          </div>
          <div class="section-content">
            <!-- Firefighting Systems content will be generated by FieldManager using Section04.js -->
            <div data-render-section="firefightingSystems"></div>
          </div>
        </div>

        <!-- Section 5: Structural Requirements -->
        <div id="structuralRequirements" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-building"></i></span>
            SECTION 5. Structural Requirements
          </div>
          <div class="section-content">
            <!-- Structural Requirements content will be generated by FieldManager using Section05.js -->
            <div data-render-section="structuralRequirements"></div>
          </div>
        </div>

        <!-- Section 6: Occupant Safety & Accessibility -->
        <div id="occupantSafety" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-people"></i></span>
            SECTION 6. Occupant Safety & Accessibility
          </div>
          <div class="section-content">
            <!-- Occupant Safety content will be generated by FieldManager using Section06.js -->
            <div data-render-section="occupantSafety"></div>
          </div>
        </div>

        <!-- Section 7: Fire Resistance & Spatial Separation -->
        <div id="fireResistance" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-shield"></i></span>
            SECTION 7. Fire Resistance & Spatial Separation
          </div>
          <div class="section-content">
            <!-- Fire Resistance content will be generated by FieldManager using Section07.js -->
            <div data-render-section="fireResistance"></div>
          </div>
        </div>

        <!-- Section 8: Plumbing Fixture Requirements -->
        <div id="plumbingFixtures" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-droplet"></i></span>
            SECTION 8. Plumbing Fixture Requirements
          </div>
          <div class="section-content">
            <!-- Plumbing Fixtures content will be generated by FieldManager using Section08.js -->
            <div data-render-section="plumbingFixtures"></div>
          </div>
        </div>

        <!-- Section 9: Compliance & Design -->
        <div id="complianceDesign" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-check-circle"></i></span>
            SECTION 9. Compliance & Design
          </div>
          <div class="section-content">
            <!-- Compliance & Design content will be generated by FieldManager using Section09.js -->
            <div data-render-section="complianceDesign"></div>
          </div>
        </div>

        <!-- Section 10: Notes -->
        <div id="notes" class="section">
          <div class="section-header">
            <span class="section-icon"><i class="bi bi-card-text"></i></span>
            SECTION 10. Notes
          </div>
          <div class="section-content">
            <!-- Notes content will be generated by FieldManager using Section10.js -->
            <div data-render-section="notes"></div>
          </div>
        </div>
      </div>

      <!-- Global Notes Panel -->
      <div id="global-notes-panel" class="notes-panel" style="display: none;">
        <div class="notes-panel-header">
          <h5><i class="bi bi-card-text"></i> Project Notes</h5>
          <button id="close-notes-panel" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="notes-panel-content">
          <textarea 
            id="global-notes-textarea" 
            class="form-control" 
            rows="15" 
            placeholder="Enter project notes here...">
          </textarea>
        </div>
      </div>

      <!-- Footer -->
      <footer class="pt-5 mt-5 text-muted border-top">
        <div class="row">
          <div class="col-md-6">
            <p>
              Interactive edition by
              <a href="https://OpenBuilding.ca">OpenBuilding.ca</a>
            </p>
          </div>
          <div class="col-md-6 text-end">
            <p>© Ontario Association of Architects - 2024 OBC Matrix</p>
          </div>
        </div>
      </footer>
    </div>

    <!-- Modal for disclaimer -->
    <div
      class="modal fade"
      id="disclaimerModal"
      tabindex="-1"
      aria-labelledby="disclaimerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning bg-opacity-25">
            <h5 class="modal-title" id="disclaimerModalLabel">
              Using the OBC Matrix
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              This tool helps you complete the Ontario Building Code Data Matrix for building permit applications.
            </p>
            <p>
              Simply enter your information in the blue input fields. You can toggle between Part 3 (large buildings) and Part 9 (housing and small buildings) forms using the toggle switch at the top.
            </p>
            <p>
              When you're finished, you can export your data as a CSV file or download a completed PDF form. You can also port data entered here to partially furnish the Energy Model by switching to OBJECTIVE (Button top right) and then 'Import from OBC Matrix', or vice-versa.  This maintains a strict separation of data between systems but allows a quick start populating either the Matrix or OBJECTIVE apps with information from each independent but linked apps. 
            </p>
            <hr />
            <p>
              <strong>Disclaimer:</strong> This interactive OBC Matrix is provided as a convenience tool. While every effort has been made to ensure accuracy, the official Ontario Building Code and related regulations should always be consulted for definitive requirements. This form is not a substitute for professional engineering or architectural advice.
            </p>
            <p>
              © Ontario Association of Architects - Interactive version by OpenBuilding.ca
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              Got it
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Weather Data Modal -->
    <div
      class="modal fade"
      id="weatherDataModal"
      tabindex="-1"
      aria-labelledby="weatherDataModalLabel"
      aria-hidden="true"
      data-bs-backdrop="static"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="weatherDataModalLabel">Weather Data</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <pre
              id="weatherDataContent"
              class="bg-light p-3"
              style="max-height: 400px; overflow-y: auto"
            >
Select a province and city to view weather data.</pre
            >
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Global modal fix script -->
    <script>
      // Simplified fix for lingering modal backdrops
      document.addEventListener("DOMContentLoaded", function () {
        // This single event listener handles all modals, but only cleans up when needed
        document.body.addEventListener("hidden.bs.modal", function () {
          // Use a short timeout to ensure Bootstrap has completed its operations
          setTimeout(function () {
            // Only clean up if there are backdrops but no visible modals
            if (
              document.querySelectorAll(".modal-backdrop").length > 0 &&
              !document.querySelector(".modal.show")
            ) {
              console.log("Cleaning up lingering modal backdrops");
              document
                .querySelectorAll(".modal-backdrop")
                .forEach((el) => el.remove());
              document.body.classList.remove("modal-open");
              document.body.style.overflow = "";
              document.body.style.paddingRight = "";
            }
          }, 150);
        });
      });
    </script>

    <!-- JavaScript resources -->
    <!-- Bootstrap already loaded in head -->

    <!-- Initialize components on page load -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Note: Core initialization is handled by OBC-Navigation.js
        // This prevents duplicate initialization that was causing performance issues
        
        // Initialize Global Notes Panel with delay to ensure DOM is ready
        setTimeout(function() {
          initializeNotesPanel();
        }, 100);

        console.log("OBC Matrix HTML script ready - waiting for Navigation script to handle core initialization");
      });

      // Cross-system navigation with state preservation
      function saveStateAndNavigate(url) {
        if (OBC && OBC.StateManager) {
          // Force immediate save before navigation
          OBC.StateManager.saveState();
          console.log("OBC StateManager: State saved before navigating to OBJECTIVE");
        }
        
        // Navigate after a brief delay to ensure save completes
        setTimeout(() => {
          window.location.href = url;
        }, 100);
      }

      // Reset all data including localStorage
      function resetAllData() {
        if (OBC && OBC.StateManager) {
          // Clear all state including localStorage
          OBC.StateManager.clear();
          console.log("OBC StateManager: All data cleared including localStorage");
          
          // Reload the page to show clean state
          setTimeout(() => {
            window.location.reload();
          }, 100);
        }
      }

      // Global Notes Panel functionality
      function initializeNotesPanel() {
        console.log('Initializing notes panel...');
        const notesToggleBtn = document.getElementById('notes-toggle-btn');
        const closeNotesBtn = document.getElementById('close-notes-panel');
        const notesPanel = document.getElementById('global-notes-panel');
        const notesTextarea = document.getElementById('global-notes-textarea');

        console.log('Found elements:', { notesToggleBtn, closeNotesBtn, notesPanel, notesTextarea });

        if (!notesToggleBtn || !notesPanel) {
          console.error('Required notes panel elements not found');
          return;
        }

        // Toggle notes column
        function toggleNotesPanel() {
          console.log('Toggle notes column clicked');
          const isHidden = document.body.classList.contains('notes-hidden');
          
          if (isHidden) {
            // Show notes column
            document.body.classList.remove('notes-hidden');
            notesToggleBtn.classList.add('active');
            console.log('Showed notes column');
          } else {
            // Hide notes column
            document.body.classList.add('notes-hidden');
            notesToggleBtn.classList.remove('active');
            console.log('Hidden notes column');
          }
        }

        // Event listeners
        notesToggleBtn.addEventListener('click', toggleNotesPanel);
        console.log('Added click listener to notes toggle button');
        
        // Set initial state - notes visible by default
        notesToggleBtn.classList.add('active');
      }
    </script>
  </body>
</html>
