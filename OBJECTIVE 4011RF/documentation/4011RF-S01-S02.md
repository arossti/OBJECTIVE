# S01 & S02 State-Mixing Analysis & Remaining Issues

This document tracks the progress on S01 and S02 state-mixing repairs and identifies remaining issues for future sessions.

---

## âœ… **COMPLETED FIXES**

### **Task 1: Section 02 Conditioned Area Slider (`h_15`) - FIXED**
- âœ… **Fixed area slider state isolation**: `handleAreaSliderInput` and `handleAreaSliderChange` now read from `ModeManager.getValue("h_15")` instead of global StateManager
- âœ… **Cleaned up duplicate defaults**: Removed hardcoded `h_15` defaults from state objects, field definition is now single source of truth
- âœ… **Added fallback logic**: Slider functions fall back to field definition default when state is empty

### **Task 2: Section 01 TEUI Denominator - FIXED** 
- âœ… **Fixed Reference calculations**: S01 now uses separate `targetArea` and `referenceArea` variables
- âœ… **Updated all Reference Column E calculations**: `e_10`, `e_8`, `e_6` now use `referenceArea` and `refServiceLife`
- âœ… **Added missing listeners**: S01 now listens to `ref_h_15` and `ref_h_13` for Reference building changes
- âœ… **Fixed gauge and warning functions**: All calculations use correct area variables

---

## ðŸš¨ **REMAINING ISSUES TO INVESTIGATE**

### **Issue: Service Life & Reporting Year State Mixing**

**Problem Observed**: 
S01's Reference Column E values still update when changes are made to S02's **Target mode** reporting year (`h_12`) and service life (`h_13`) sliders. This indicates continued state contamination.

**Expected Behavior**: 
Reference calculations should ONLY be affected by Reference mode changes to these sliders.

**Likely Root Cause**:
S01's Reference calculations may still be reading from global/unprefixed values instead of `ref_` prefixed values:

```javascript
// S01 likely still doing (WRONG):
const serviceLife = getGlobalNumericValue("h_13") || 50;  // Target value contaminating Reference

// Should be doing (CORRECT):
const refServiceLife = getGlobalNumericValue("ref_h_13") || serviceLife;  // Reference-specific value
```

**Investigation Needed**:
1. **Verify S02 is writing correctly**: Check that S02 writes `ref_h_12` and `ref_h_13` when in Reference mode
2. **Audit S01 dependencies**: Ensure S01 reads Reference building parameters from `ref_` prefixed fields
3. **Check calculation chain**: Verify downstream sections (S04, S13, S15) also use Reference-specific building parameters

### **Next Session Tasks**:
1. Investigate S02's slider output - verify it writes `ref_h_12` and `ref_h_13` in Reference mode
2. Audit S01's use of `h_12` and `h_13` vs `ref_h_12` and `ref_h_13` 
3. Test calculation propagation chain through S04â†’S13â†’S15â†’S01

---

## ðŸŽ¯ **Architecture Notes**

**S02 Responsibility**: Write both unprefixed (Target) and `ref_` prefixed (Reference) values to StateManager based on current mode
**S01 Responsibility**: Read Target values from unprefixed fields, Reference values from `ref_` prefixed fields
**Critical**: Complete state isolation between Target and Reference building parameters
