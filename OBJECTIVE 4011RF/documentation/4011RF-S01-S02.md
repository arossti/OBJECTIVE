# S01 & S02 State-Mixing Analysis & Remaining Issues

This document tracks the progress on S01 and S02 state-mixing repairs and identifies remaining issues for future sessions.

---

## ‚úÖ **COMPLETED FIXES**

### **Task 1: Section 02 Conditioned Area Slider (`h_15`) - FIXED**
- ‚úÖ **Fixed area slider state isolation**: `handleAreaSliderInput` and `handleAreaSliderChange` now read from `ModeManager.getValue("h_15")` instead of global StateManager
- ‚úÖ **Cleaned up duplicate defaults**: Removed hardcoded `h_15` defaults from state objects, field definition is now single source of truth
- ‚úÖ **Added fallback logic**: Slider functions fall back to field definition default when state is empty

### **Task 2: Section 01 TEUI Denominator - FIXED** 
- ‚úÖ **Fixed Reference calculations**: S01 now uses separate `targetArea` and `referenceArea` variables
- ‚úÖ **Updated all Reference Column E calculations**: `e_10`, `e_8`, `e_6` now use `referenceArea` and `refServiceLife`
- ‚úÖ **Added missing listeners**: S01 now listens to `ref_h_15` and `ref_h_13` for Reference building changes
- ‚úÖ **Fixed gauge and warning functions**: All calculations use correct area variables

---

## üö® **CURRENT PROBLEM DEFINITION (December 2024)**

### **Core Issue: S02 Reference Mode Cross-State Contamination**

**PROBLEMATIC FIELDS**:
- **`h_12`** (Reporting Year) - S02 slider, should only affect Reference when in Reference mode
- **`h_13`** (Service Life) - S02 slider, should only affect Reference when in Reference mode  
- **`h_15`** (Building Area) - S02 slider, should only affect Reference when in Reference mode

**AFFECTED SECTIONS**:
- **S02**: Field owner, manages Target/Reference states via ModeManager
- **S01**: Consumer section, displays Target (h_6, h_8, k_6, k_8) and Reference (e_6, e_8) columns
- **S04/S05**: Intermediate calculation sections that may propagate contamination

**OBSERVED BEHAVIOR** (‚ùå WRONG):
When S02 is in **Reference mode** and user changes `h_12`/`h_13` sliders:
- ‚úÖ Reference Column E (e_6, e_8) updates correctly 
- ‚ùå **Target Column H (h_6, h_8) ALSO updates** (should remain unchanged)
- ‚ùå **Actual Column K (k_6, k_8) ALSO updates** (should remain unchanged)

**EXPECTED BEHAVIOR** (‚úÖ CORRECT):
When S02 is in **Reference mode** and user changes `h_12`/`h_13` sliders:
- ‚úÖ Reference Column E (e_6, e_8) should update (uses `ref_h_13`, `ref_h_15`)
- ‚úÖ Target Column H (h_6, h_8) should remain unchanged (uses `h_13`, `h_15`)
- ‚úÖ Actual Column K (k_6, k_8) should remain unchanged (uses `h_13`, `h_15`)

**FIXES ATTEMPTED (December 2024)**:
1. ‚úÖ **FieldManager dual-state routing**: Routes user input through section ModeManagers
2. ‚úÖ **S01 state isolation**: Target calculations use `targetServiceLife`, Reference use `refServiceLife`  
3. ‚úÖ **Field ownership correction**: Removed incorrect field definitions from S01
4. ‚ùå **Result**: Issue persists despite architectural improvements

**INVESTIGATION PRIORITIES FOR NEXT SESSION**:

1. **üîç PRIORITY 1: Verify S02 ModeManager Output**
   ```bash
   # Check logs for: S02 Reference mode h_13 slider change
   # Expected: ModeManager only writes to ref_h_13
   # Suspect: Something still writes to unprefixed h_13
   ```

2. **üîç PRIORITY 2: Find Remaining Direct StateManager Writes**
   ```bash
   # Search for any code bypassing FieldManager dual-state routing
   grep -r "StateManager.setValue.*h_13" --exclude-dir=ARCHIVE
   grep -r "\.setValue.*h_13" --exclude-dir=ARCHIVE  
   ```

3. **üîç PRIORITY 3: S05 "Target Mode" Contamination**
   ```
   # Issue: S05 runs updateCalculatedDisplayValues in Target mode during S02 Reference operations
   # Location: sections/4011-Section05.js line 192
   # Investigation: Why does S05 think it's in Target mode during Reference ops?
   ```

### **ROOT CAUSE HYPOTHESIS**:
Despite FieldManager routing improvements, there's still a **legacy direct StateManager write** somewhere that bypasses dual-state architecture and contaminates the unprefixed `h_13` key that S01 Target calculations read from.

### **SUCCESS CRITERIA**:
Perfect state isolation where S02 Reference mode operations **never** affect S01 Target/Actual columns.

---

## üéØ **Architecture Notes**

**S02 Responsibility**: Write both unprefixed (Target) and `ref_` prefixed (Reference) values to StateManager based on current mode
**S01 Responsibility**: Read Target values from unprefixed fields, Reference values from `ref_` prefixed fields
**Critical**: Complete state isolation between Target and Reference building parameters
