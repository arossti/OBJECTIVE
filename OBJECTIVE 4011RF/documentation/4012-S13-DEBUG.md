# S13 Mechanical Loads - Known Issues & Implementation Plan

**Current Status:** ✅ Reference mode ventilation calculations WORKING (as of commit `37359d5`)

**Critical Victory:** S12 now publishes `ref_d_105` (Conditioned Volume), enabling S13 Reference ventilation chain to function. The elephant is moving! 🐘

---

## KNOWN ISSUES

### 1. Number Formatting in Reference Mode

**Symptom:**
- When switching to Reference mode, number formats are lost
- Missing comma thousands separators (e.g., `8000` instead of `8,000`)
- Percentages show as decimals (e.g., `1.7` instead of `170%`)
- Specifically affects: i_122, d_124, and all fields with `number-2dp-comma` format

**Root Cause:**
`ModeManager.updateCalculatedDisplayValues()` (lines 199-301) uses hardcoded formats:
- Only `m_115` gets `percent-0dp`
- Everything else gets `number-2dp` (no comma, no percentage handling)

**Probable Fix:**
Create a field-specific format map matching the `setFieldValue()` calls:
```javascript
const fieldFormats = {
  "i_122": "percent-0dp",        // Latent load factor
  "d_124": "percent-0dp",        // Free cooling %
  "m_115": "percent-0dp",        // AFUE efficiency
  "d_121": "number-2dp-comma",   // Heating vent energy
  "m_121": "number-2dp-comma",   // Net heat loss
  "d_122": "number-2dp-comma",   // Cooling vent energy
  "m_129": "number-2dp-comma",   // CED mitigated
  // ... etc
};
const formatType = fieldFormats[fieldId] || "number-2dp-comma";
```

**Implementation Method:**
1. **Backup first:** Commit current working state
2. **Map formats:** Review all `setFieldValue()` calls in S13 to build complete format map
3. **Update function:** Replace lines 265-277 with format map lookup
4. **Test immediately:** Hard refresh, toggle to Reference mode, verify formats
5. **If broken:** `git reset --hard` to previous commit
6. **If working:** Commit with clear message about formatting only

**Risk Level:** 🟡 MEDIUM - Only affects display, not calculations. Revert is easy.

---

### 2. Free Cooling & CED Calculations in Reference Mode

**Symptom:**
- **d_124** (Free Cooling %) shows `0.00` in Reference mode
- **m_129** (CED Mitigated) shows `0.00` in Reference mode
- Target mode shows proper values (e.g., m_129 = `-20.73` days)

**Root Cause:**
Functions use `getFieldValue()` which doesn't handle `ref_` prefix:

**Problem Functions:**
1. `calculateCEDMitigated()` (line 2728):
   - Reads `d_129`, `h_124`, `d_123` without mode awareness
   - Should read `ref_d_129`, `ref_h_124`, `ref_d_123` when `isReferenceCalculation=true`

2. `calculateFreeCooling()` (line 2747):
   - Reads `h_120` without mode awareness (line 2763)
   - Reads `cooling_h_124` without mode awareness (line 2770)
   - Reads `d_129` without mode awareness (line 2821)
   - Only calculates d_124 and m_124 for Target mode (line 2819 check)

**Probable Fix:**

```javascript
// calculateCEDMitigated - add mode-aware reads
const d129 = window.TEUI.parseNumeric(
  isReferenceCalculation
    ? window.TEUI.StateManager.getValue("ref_d_129")
    : getFieldValue("d_129")
) || 0;
// ... same for h_124, d_123

// calculateFreeCooling - add mode-aware reads
const h_120 = window.TEUI.parseNumeric(
  isReferenceCalculation
    ? window.TEUI.StateManager.getValue("ref_h_120")
    : getFieldValue("h_120")
) || 0;

const h_124_raw = isReferenceCalculation
  ? window.TEUI.StateManager.getValue("ref_cooling_h_124")
  : window.TEUI.StateManager.getValue("cooling_h_124");

// Calculate d_124 and m_124 for BOTH modes, return object
return {
  h_124: finalFreeCoolingLimit,
  d_124: percentFreeCooling,
  m_124: activeCoolingDays,
};

// Update call site in calculateReferenceModel (line 2934)
const freeCoolingResults = calculateFreeCooling(true); // Not wrapped in object
```

**Implementation Method:**
1. **Test first:** Verify current calculations work in Target mode
2. **One function at a time:**
   - Fix `calculateCEDMitigated()` first
   - Commit and test
   - Then fix `calculateFreeCooling()`
   - Commit and test
3. **Each test:** Check d_124, m_129 in BOTH Target and Reference modes
4. **Verify dependencies:** Ensure Cooling.js publishes `ref_cooling_h_124` and `ref_cooling_m_124`

**Risk Level:** 🔴 HIGH - These functions are in the critical calculation chain. Changes could break ventilation/cooling flow.

**Mitigation:**
- Make changes to ONE function per commit
- Test Target mode first (should still work)
- Test Reference mode (should now work)
- If broken, `git reset --hard` immediately

---

## IMPORT FUNCTIONALITY - TODO

**Reference:** See `MAPPER.md` for complete import sync pattern documentation

**Current State:**
- ✅ S02-S12 have import sync via `syncFromGlobalState()` pattern
- ❌ S13 does NOT have import sync yet
- ❌ S15 has partial import (only d_142 field)

**S13 Import Requirements:**

Per previous session analysis, S13 needs to sync **11 user input fields**:

```javascript
// Fields to sync from Excel import:
[
  "d_113",  // Primary Heating System
  "f_113",  // HSPF
  "j_115",  // AFUE
  "d_116",  // Cooling System
  "j_116",  // COPc (cooling efficiency)
  "d_118",  // HRV/ERV SRE %
  "g_118",  // Ventilation Method
  "l_118",  // ACH
  "d_119",  // Rate Per Person
  "l_119",  // Summer Boost
  "k_120",  // Unoccupied Setback %
]
```

**Implementation:** Follow 3-step pattern from MAPPER.md:

**Step 1:** Add `syncFromGlobalState()` to TargetState (S13 lines ~45-65)
```javascript
syncFromGlobalState: function (fieldIds = [/* 11 fields above */]) {
  fieldIds.forEach((fieldId) => {
    const globalValue = window.TEUI.StateManager.getValue(fieldId);
    if (globalValue !== null && globalValue !== undefined) {
      this.setValue(fieldId, globalValue, "imported");
    }
  });
},
```

**Step 2:** Add `syncFromGlobalState()` to ReferenceState (S13 lines ~145-165)
```javascript
syncFromGlobalState: function (fieldIds = [/* 11 fields above */]) {
  fieldIds.forEach((fieldId) => {
    const refFieldId = `ref_${fieldId}`;
    const globalValue = window.TEUI.StateManager.getValue(refFieldId);
    if (globalValue !== null && globalValue !== undefined) {
      this.setValue(fieldId, globalValue, "imported");
    }
  });
},
```

**Step 3:** Add S13 to FileHandler sync array
```javascript
// In 4011-FileHandler.js, add to patternASections array:
{ id: "sect13", name: "S13" },
```

**Step 4:** Expose TargetState and ReferenceState in module return
```javascript
// In S13 return statement (~line 3520):
TargetState: TargetState,
ReferenceState: ReferenceState,
```

**Commit Reference:** See commit `639e119` (currently not on branch, but saved)
- This commit has the complete S13 import sync implementation
- Can cherry-pick after other bugs are fixed

**Risk Level:** 🟢 LOW - Import sync is well-tested pattern, isolated from calculations

---

## TESTING CHECKLIST

After ANY changes to S13:

**Target Mode:**
- [ ] All heating values calculate (d_114, l_113, etc.)
- [ ] All ventilation values calculate (d_120, d_121, m_121, etc.)
- [ ] All cooling values calculate (d_122, d_123, d_124, etc.)
- [ ] Free cooling shows (h_124, d_124, m_124)
- [ ] CED values show (d_129, m_129)
- [ ] Number formats correct (commas, percentages)
- [ ] Sliders update calculations (d_118, l_118, etc.)

**Reference Mode:**
- [ ] Mode switch preserves values (slider thumbs move)
- [ ] All calculations show non-zero values
- [ ] Number formats correct (commas, percentages)
- [ ] Ventilation chain works (d_120 ≠ 0)
- [ ] Free cooling calculates (d_124, m_129 ≠ 0 if applicable)
- [ ] T-cells show correct comparison indicators

**Mode Switching:**
- [ ] Toggle Target → Reference → Target preserves values
- [ ] No console errors
- [ ] Calculations update on slider changes in both modes

---

## COMMIT HISTORY

**Working Baseline:** `37359d5` - Clean up S13 diagnostic logging
- S13 Reference ventilation works
- S12 publishes ref_d_105
- Slider values update on mode switch
- All diagnostic logging removed

**Previous Commits (on IRONING):**
- `ae66290` - CRITICAL: S12 publishes ref_d_105 (THE FIX)
- `286a27d` - Fix S13 slider.value update in refreshUI
- `0fc4ee7` - Safe restore point before S13 work

**Saved but not on branch:**
- `639e119` - S13 import sync complete (can cherry-pick later)
- `7b0a347` - Formatting fixes (BROKE ventilation, reverted)

---

## NOTES

**What Works:**
- S13 Reference ventilation calculations are CORRECT
- Volume-based ventilation (d_120) calculates properly
- Heating season ventilation energy (d_121, i_121, m_121) works
- Cooling season ventilation (d_122, d_123) works
- The calculation chain S13 → S14 → S15 → S04 → S01 is unblocked

**What Needs Polish:**
- Display formatting in Reference mode
- Free cooling calculations in Reference mode
- Import sync functionality (future feature)

**Key Lesson:**
The "Final Boss" victory (commit `8b1bb24`) was premature - it fixed g_118 state isolation but missed:
1. The slider.value update bug (fixed in `286a27d`)
2. The missing ref_d_105 publication (fixed in `ae66290`)

Always test BOTH modes thoroughly after "victory" declarations!

---

**Last Updated:** October 6, 2025
**Status:** Ready for incremental fixes
**Next Action:** Choose Issue #1 (formatting) OR Issue #2 (cooling math) to tackle first
