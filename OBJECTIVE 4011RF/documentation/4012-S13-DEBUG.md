# S13 Mechanical Loads - Known Issues & Implementation Plan

**Current Branch:** SON-OF-A-BOSS (as of Oct 6, 2025)
**Parent Branch:** IRONING (commit `a17e46d`)

---

## CRITICAL CONTEXT FOR NEW AGENTS

### Architectural Constraints

**MANDATORY:** All solutions MUST conform to the dual-state architecture documented in:
- **`../README.md`** (root directory) - Core architectural principles
- Pattern A dual-state isolation requirements
- Mode-aware calculation patterns
- State sovereignty principles

**DO NOT:**
- Violate state isolation between Target and Reference modes
- Add calculations to `switchMode()` (UI toggle is display-only)
- Use Target values as fallbacks for Reference calculations
- Break the dual-engine calculation pattern

### The Excel vs JavaScript Synchronicity Problem

**ROOT CAUSE OF REMAINING BUGS:**

Excel is **asynchronous** - calculations can happen in any order and eventually resolve through iterative recalculation. Our JavaScript app is **synchronous** - calculations must execute in the correct order or they fail.

**Example:**
```
Excel: d_117 (cooling load) can calculate BEFORE d_120 (ventilation rate) exists
       because Excel will recalculate d_117 automatically when d_120 becomes available

JavaScript: If d_117 calculation runs before d_120 is published to StateManager,
           d_117 gets 0 and stays 0 until something triggers recalculation
```

**This is why we see "whack-a-mole" behavior** - adjusting a ventilation parameter triggers `calculateAll()`, which re-runs cooling calculations with now-available ventilation values, and suddenly cooling loads appear.

**Solutions must ensure:**
1. Calculation order matches dependency chain
2. All prerequisite values are published BEFORE dependent calculations read them
3. Or calculations must be robust to missing values (store results, re-run when dependencies available)

### Critical Historical Fixes

**October 5-6, 2025 - The Journey to Current State:**

**1. The Elephant Bug (SOLVED ‚úÖ)**
- **Problem:** S13 Reference ventilation showed 0.00 for d_120 and everything downstream
- **Root Cause:** S12's `calculateVolumeMetrics()` calculated `d_105` (Conditioned Volume) but NEVER published it with `ref_` prefix
- **Fix (commit `ae66290`):** S12 now calls `setCalculatedValue("d_105", d105_vol, "number-2dp-comma", isReferenceCalculation)` AND includes `d_105` in return statement
- **Result:** Ventilation by volume now has the volume it needs to calculate

**2. Number Formatting (SOLVED ‚úÖ)**
- **Fix (commit `df37cb7`):** Implemented field-specific format map (S10 pattern) for 45 calculated fields
- **Result:** Proper commas, percentages, and decimal places in both modes

**3. Free Cooling Calculations (SOLVED ‚úÖ)**
- **Fix (commits `c7597d5`, `d55e35d`, `8d5b2eb`):** Added mode-aware reads to `calculateCEDMitigated()` and `calculateFreeCooling()`
- **Result:** d_124, h_124, m_124, m_129 all calculate correctly in Reference mode

**4. Import Sync (SOLVED ‚úÖ)**
- **Fix (commit `a17e46d`):** Implemented 3-step Pattern A import sync for 11 S13 user input fields
- **Result:** 90% Excel import parity confirmed

### Current State Summary

**What Works:**
- ‚úÖ S13 Reference ventilation calculations (d_120, d_121, i_121, m_121)
- ‚úÖ S13 Reference free cooling (d_124, h_124, m_124, m_129)
- ‚úÖ Number formatting in both modes
- ‚úÖ Import sync for all Pattern A sections including S13
- ‚úÖ S12 publishes ref_d_105 for volume-based ventilation

**What's Broken:**

**BUG #1 - PRIORITY 1: Volume Constant Ventilation Method (Oct 7, 2025)**
- ‚ùå **CRITICAL:** g_118 = "Volume Constant" zeros out cooling load d_117
  - **Affects BOTH Target AND Reference modes equally** (separate bug from timing/orchestrator issues)
  - Cooling loads generate correctly with ANY other g_118 selection (Occupant Constant, Occupant by Schedule, Volume by Schedule)
  - **Only fails with g_118 = "Volume Constant"**
  - Root cause: Missing or zero value in Volume Constant calculation chain
  - Dependency chain: d_120 (vent rate) ‚Üí d_122 (cooling vent energy) ‚Üí d_129 (CED unmitigated) ‚Üí m_129 (CED mitigated) ‚Üí d_117 (cooling load)
  - Volume Constant formula (line 2553): `ventRateLs = volume > 0 ? (ach * volume) / 3.6 : 0`
  - Required inputs:
    - volume (d_105 from S12)
    - ach (l_118 slider)
    - time constant (8760 hrs - implicit in "Constant" method)
  - **Fix Strategy:** Diagnostic logging ‚Üí identify missing value ‚Üí surgical fix

**BUG #2 - PRIORITY 2: Indoor RH% (i_59) Reference Mode (Oct 7, 2025)**
- ‚ùå S08 indoor RH% (i_59) doesn't affect Reference model cooling calculations
  - In Target mode: Changes to i_59 update cooling calculations correctly
  - In Reference mode: Changes to i_59 have no effect on cooling calculations
  - **Affects ONLY Reference mode** (separate bug from Volume Constant)
  - Listeners exist: lines 2288-2289 listen to both i_59 and ref_i_59
  - Investigation needed: Where/how is i_59 used in cooling calculations?
  - Note: This is NOT coolingSeasonMeanRH (outdoor seasonal average, hardcoded 55.85%, correct)
  - This is indoor humidity setpoint during cooling season (user-controlled in S08)
  - **Fix Strategy:** Identify where i_59 affects cooling ‚Üí add mode-aware read for ref_i_59

---

**Original Status (kept for reference):**
‚úÖ Reference mode ventilation calculations WORKING (as of commit `37359d5`)
üêò S12 now publishes `ref_d_105` (Conditioned Volume) - The elephant is moving!

---

## KNOWN ISSUES

### 1. Number Formatting in Reference Mode

**Symptom:**
- When switching to Reference mode, number formats are lost
- Missing comma thousands separators (e.g., `8000` instead of `8,000`)
- Percentages show as decimals (e.g., `1.7` instead of `170%`)
- Specifically affects: i_122, d_124, and all fields with `number-2dp-comma` format

**Root Cause:**
`ModeManager.updateCalculatedDisplayValues()` (lines 199-301) uses hardcoded formats:
- Only `m_115` gets `percent-0dp`
- Everything else gets `number-2dp` (no comma, no percentage handling)

**Probable Fix:**
Create a field-specific format map matching the `setFieldValue()` calls:
```javascript
const fieldFormats = {
  "i_122": "percent-0dp",        // Latent load factor
  "d_124": "percent-0dp",        // Free cooling %
  "m_115": "percent-0dp",        // AFUE efficiency
  "d_121": "number-2dp-comma",   // Heating vent energy
  "m_121": "number-2dp-comma",   // Net heat loss
  "d_122": "number-2dp-comma",   // Cooling vent energy
  "m_129": "number-2dp-comma",   // CED mitigated
  // ... etc
};
const formatType = fieldFormats[fieldId] || "number-2dp-comma";
```

**Implementation Method:**
1. **Backup first:** Commit current working state
2. **Map formats:** Review all `setFieldValue()` calls in S13 to build complete format map
3. **Update function:** Replace lines 265-277 with format map lookup
4. **Test immediately:** Hard refresh, toggle to Reference mode, verify formats
5. **If broken:** `git reset --hard` to previous commit
6. **If working:** Commit with clear message about formatting only

**Risk Level:** üü° MEDIUM - Only affects display, not calculations. Revert is easy.

---

### 2. Free Cooling & CED Calculations in Reference Mode

**Symptom:**
- **d_124** (Free Cooling %) shows `0.00` in Reference mode
- **m_129** (CED Mitigated) shows `0.00` in Reference mode
- Target mode shows proper values (e.g., m_129 = `-20.73` days)

**Root Cause:**
Functions use `getFieldValue()` which doesn't handle `ref_` prefix:

**Problem Functions:**
1. `calculateCEDMitigated()` (line 2728):
   - Reads `d_129`, `h_124`, `d_123` without mode awareness
   - Should read `ref_d_129`, `ref_h_124`, `ref_d_123` when `isReferenceCalculation=true`

2. `calculateFreeCooling()` (line 2747):
   - Reads `h_120` without mode awareness (line 2763)
   - Reads `cooling_h_124` without mode awareness (line 2770)
   - Reads `d_129` without mode awareness (line 2821)
   - Only calculates d_124 and m_124 for Target mode (line 2819 check)

**Probable Fix:**

```javascript
// calculateCEDMitigated - add mode-aware reads
const d129 = window.TEUI.parseNumeric(
  isReferenceCalculation
    ? window.TEUI.StateManager.getValue("ref_d_129")
    : getFieldValue("d_129")
) || 0;
// ... same for h_124, d_123

// calculateFreeCooling - add mode-aware reads
const h_120 = window.TEUI.parseNumeric(
  isReferenceCalculation
    ? window.TEUI.StateManager.getValue("ref_h_120")
    : getFieldValue("h_120")
) || 0;

const h_124_raw = isReferenceCalculation
  ? window.TEUI.StateManager.getValue("ref_cooling_h_124")
  : window.TEUI.StateManager.getValue("cooling_h_124");

// Calculate d_124 and m_124 for BOTH modes, return object
return {
  h_124: finalFreeCoolingLimit,
  d_124: percentFreeCooling,
  m_124: activeCoolingDays,
};

// Update call site in calculateReferenceModel (line 2934)
const freeCoolingResults = calculateFreeCooling(true); // Not wrapped in object
```

**Implementation Method:**
1. **Test first:** Verify current calculations work in Target mode
2. **One function at a time:**
   - Fix `calculateCEDMitigated()` first
   - Commit and test
   - Then fix `calculateFreeCooling()`
   - Commit and test
3. **Each test:** Check d_124, m_129 in BOTH Target and Reference modes
4. **Verify dependencies:** Ensure Cooling.js publishes `ref_cooling_h_124` and `ref_cooling_m_124`

**Risk Level:** üî¥ HIGH - These functions are in the critical calculation chain. Changes could break ventilation/cooling flow.

**Mitigation:**
- Make changes to ONE function per commit
- Test Target mode first (should still work)
- Test Reference mode (should now work)
- If broken, `git reset --hard` immediately

---

## IMPORT FUNCTIONALITY - TODO

**Reference:** See `MAPPER.md` for complete import sync pattern documentation

**Current State:**
- ‚úÖ S02-S12 have import sync via `syncFromGlobalState()` pattern
- ‚ùå S13 does NOT have import sync yet
- ‚ùå S15 has partial import (only d_142 field)

**S13 Import Requirements:**

Per previous session analysis, S13 needs to sync **11 user input fields**:

```javascript
// Fields to sync from Excel import:
[
  "d_113",  // Primary Heating System
  "f_113",  // HSPF
  "j_115",  // AFUE
  "d_116",  // Cooling System
  "j_116",  // COPc (cooling efficiency)
  "d_118",  // HRV/ERV SRE %
  "g_118",  // Ventilation Method
  "l_118",  // ACH
  "d_119",  // Rate Per Person
  "l_119",  // Summer Boost
  "k_120",  // Unoccupied Setback %
]
```

**Implementation:** Follow 3-step pattern from MAPPER.md:

**Step 1:** Add `syncFromGlobalState()` to TargetState (S13 lines ~45-65)
```javascript
syncFromGlobalState: function (fieldIds = [/* 11 fields above */]) {
  fieldIds.forEach((fieldId) => {
    const globalValue = window.TEUI.StateManager.getValue(fieldId);
    if (globalValue !== null && globalValue !== undefined) {
      this.setValue(fieldId, globalValue, "imported");
    }
  });
},
```

**Step 2:** Add `syncFromGlobalState()` to ReferenceState (S13 lines ~145-165)
```javascript
syncFromGlobalState: function (fieldIds = [/* 11 fields above */]) {
  fieldIds.forEach((fieldId) => {
    const refFieldId = `ref_${fieldId}`;
    const globalValue = window.TEUI.StateManager.getValue(refFieldId);
    if (globalValue !== null && globalValue !== undefined) {
      this.setValue(fieldId, globalValue, "imported");
    }
  });
},
```

**Step 3:** Add S13 to FileHandler sync array
```javascript
// In 4011-FileHandler.js, add to patternASections array:
{ id: "sect13", name: "S13" },
```

**Step 4:** Expose TargetState and ReferenceState in module return
```javascript
// In S13 return statement (~line 3520):
TargetState: TargetState,
ReferenceState: ReferenceState,
```

**Commit Reference:** See commit `639e119` (currently not on branch, but saved)
- This commit has the complete S13 import sync implementation
- Can cherry-pick after other bugs are fixed

**Risk Level:** üü¢ LOW - Import sync is well-tested pattern, isolated from calculations

---

## TESTING CHECKLIST

After ANY changes to S13:

**Target Mode:**
- [ ] All heating values calculate (d_114, l_113, etc.)
- [ ] All ventilation values calculate (d_120, d_121, m_121, etc.)
- [ ] All cooling values calculate (d_122, d_123, d_124, etc.)
- [ ] Free cooling shows (h_124, d_124, m_124)
- [ ] CED values show (d_129, m_129)
- [ ] Number formats correct (commas, percentages)
- [ ] Sliders update calculations (d_118, l_118, etc.)

**Reference Mode:**
- [ ] Mode switch preserves values (slider thumbs move)
- [ ] All calculations show non-zero values
- [ ] Number formats correct (commas, percentages)
- [ ] Ventilation chain works (d_120 ‚â† 0)
- [ ] Free cooling calculates (d_124, m_129 ‚â† 0 if applicable)
- [ ] T-cells show correct comparison indicators

**Mode Switching:**
- [ ] Toggle Target ‚Üí Reference ‚Üí Target preserves values
- [ ] No console errors
- [ ] Calculations update on slider changes in both modes

---

## COMMIT HISTORY

**Working Baseline:** `37359d5` - Clean up S13 diagnostic logging
- S13 Reference ventilation works
- S12 publishes ref_d_105
- Slider values update on mode switch
- All diagnostic logging removed

**Previous Commits (on IRONING):**
- `ae66290` - CRITICAL: S12 publishes ref_d_105 (THE FIX)
- `286a27d` - Fix S13 slider.value update in refreshUI
- `0fc4ee7` - Safe restore point before S13 work

**Saved but not on branch:**
- `639e119` - S13 import sync complete (can cherry-pick later)
- `7b0a347` - Formatting fixes (BROKE ventilation, reverted)

---

## NOTES

**What Works:**
- S13 Reference ventilation calculations are CORRECT
- Volume-based ventilation (d_120) calculates properly
- Heating season ventilation energy (d_121, i_121, m_121) works
- Cooling season ventilation (d_122, d_123) works
- The calculation chain S13 ‚Üí S14 ‚Üí S15 ‚Üí S04 ‚Üí S01 is unblocked

**What Needs Polish:**
- Display formatting in Reference mode
- Free cooling calculations in Reference mode
- Import sync functionality (future feature)

**Key Lesson:**
The "Final Boss" victory (commit `8b1bb24`) was premature - it fixed g_118 state isolation but missed:
1. The slider.value update bug (fixed in `286a27d`)
2. The missing ref_d_105 publication (fixed in `ae66290`)

Always test BOTH modes thoroughly after "victory" declarations!

---

## OCTOBER 6-7, 2025 SESSION SUMMARY

### üîç BREAKTHROUGH: Volume Constant Bug Isolated (Oct 7, 2025)

**Critical Discovery:** The "cooling bump" mystery is NOT a timing/orchestrator issue.

**Evidence:**
- Bug affects **BOTH Target AND Reference modes equally**
- Cooling loads generate correctly with 4 out of 5 g_118 ventilation methods
- **ONLY fails with g_118 = "Volume Constant"**
- This eliminates timing, listener propagation, and mode-switching as root causes

**Implication:** Simple calculation logic bug, not architectural issue. Fix is surgical, not systemic.

**Volume Constant Dependency Chain Identified:**
```
g_118 = "Volume Constant" ‚Üí calculateVentilationRates() line 2553
‚Üí ventRateLs = volume > 0 ? (ach * volume) / 3.6 : 0
‚Üí d_120 (ventilation rate L/s)
‚Üí d_122 (cooling ventilation energy) line 2673
‚Üí d_129 (CED unmitigated) line 2730
‚Üí m_129 (CED mitigated) line 2768
‚Üí d_117 (cooling load) line 2438/2447
```

**Required Inputs for Volume Constant:**
1. **volume** (d_105) - conditioned volume from S12
2. **ach** (l_118) - air changes per hour slider (default 3.0)
3. **Time constant** - 8760 hours (implied, not a parameter)

**Diagnostic Strategy:** Add console logging to identify which input is missing/zero.

**Strategic Reassessment:** SEPT15-RACE-MITIGATION.md Orchestrator may not be needed for S13 after all. The "cooling bump" working was masking a simple calculation bug, not proving an orchestrator requirement.

### Fixes Completed Oct 6 ‚úÖ

**1. Free Cooling Calculations (Commits: c7597d5, d55e35d, 8d5b2eb)**
- ‚úÖ Added mode-aware reads to `calculateCEDMitigated()` for d_129, h_124, d_123
- ‚úÖ Added mode-aware reads to `calculateFreeCooling()` for h_120, cooling_h_124, d_129, cooling_m_124
- ‚úÖ Fixed `setFieldValue()` parameter bug - removed incorrect `isReferenceCalculation` 4th parameter
- ‚úÖ Free cooling values (d_124, h_124, m_124) now calculate correctly in Reference mode
- ‚úÖ CED mitigated (m_129) now calculates correctly in Reference mode

**2. Number Formatting (Commit: df37cb7)**
- ‚úÖ Implemented field-specific format map following S10 pattern
- ‚úÖ 45 calculated fields now have correct formats (percentages, commas, decimals)
- ‚úÖ Formats work correctly in BOTH Target and Reference modes

### Issues Discovered Oct 6 (Resolved Oct 7) üêõ

**"Critical: Reference Mode Cooling Toggle Intermittent Failure" - MISDIAGNOSED**

**Original Symptom (Oct 6):**
- User enters Reference mode ‚Üí selects "Cooling" at d_116 ‚Üí **d_117 shows 0.00**
- User then adjusts ANY ventilation parameter (g_118, d_118, l_118, etc.) ‚Üí **d_117 suddenly appears with correct value**
- Appeared to be timing/listener/orchestrator issue

**Oct 7 Breakthrough - Pattern Recognition:**
- User tested systematically: Bug affects **BOTH Target AND Reference** equally
- Bug ONLY occurs when **g_118 = "Volume Constant"**
- All other g_118 selections work perfectly (Occupant Constant, Occupant by Schedule, Volume by Schedule)

**Root Cause Identified:**
- NOT a timing/orchestrator issue
- NOT a mode-switching issue
- NOT a listener propagation issue
- **Simple calculation bug:** Volume Constant formula missing/zero input value

**Why "adjusting ventilation" appeared to fix it:**
- Changing g_118 FROM "Volume Constant" TO anything else ‚Üí cooling works
- We interpreted this as "triggering recalculation" when it was actually "switching to working formula"
- Classic diagnostic red herring!

**What We Tried (Oct 6 afternoon - correctly rejected):**
1. ‚ùå Added ref_ listeners for dropdowns - didn't help (because not a listener issue)
2. ‚ùå Removed "Target-only" DOM update restrictions - didn't help (because not a mode issue)
3. ‚úÖ Correctly reverted - avoided committing broken code

**Key User Insight (Oct 6) - Now Reinterpreted:**
> "Setting g_118 to 'Volume Constant' then Cooling load becomes 0 for some mystifying reason"

This was the critical clue we initially overlooked. The mystery wasn't about timing - it was about Volume Constant specifically.

### Technical Debt Identified üîß

**1. Calculation Order Dependencies**
- S13 has complex interdependencies: heating ‚Üí ventilation ‚Üí cooling ‚Üí free cooling ‚Üí CED
- Reference mode calculations may execute in wrong order or with incomplete inputs
- Need to ensure all prerequisite values are available BEFORE dependent calculations run

**2. State Publication Timing**
- Values may be calculated but not yet published to StateManager when next calculation reads them
- Need to verify calculation flow in `calculateReferenceModel()` matches `calculateTargetModel()`
- May need explicit ordering or dependency management

**3. Fragility vs Robustness**
- Target mode appears more robust - tolerates missing values better
- Reference mode calculations appear fragile - fail if ANY dependency missing
- Need to understand WHY Target mode works when Reference mode doesn't

### üîó Architectural Context: SEPT15-RACE-MITIGATION.md

**CRITICAL:** S13's cooling toggle issue is a **specific manifestation** of the broader StateManager listener limitation documented in [SEPT15-RACE-MITIGATION.md](SEPT15-RACE-MITIGATION.md).

**Key Connections:**
- **Lines 126-135**: StateManager.setValue(..., "calculated") does NOT trigger listeners by design
- **Lines 101-103**: The "cooling bump" works because user-modified triggers bypass broken calculated-value propagation
- **Lines 94-97**: Single changes trigger 7+ calculation engines causing timing chaos (our whack-a-mole pattern)
- **Lines 948-973**: CTO identified this as "classic directed graph problem" - listener system is the trap

**Why This Matters:**
- S13 cooling calculations work correctly when triggered
- Problem is **when/how they're triggered**, not the calculation logic
- S08 RH% ‚Üí S13 cooling flow likely broken by same StateManager limitation
- Adjusting ventilation "fixes" it by forcing complete recalculation with fresh data

**Strategic Implications:**
- Band-aid fixes (below) are acceptable temporary solutions
- Complete solution requires Orchestrator/dependency graph implementation (SEPT15 document)
- S13 may benefit from Orchestrator more than any other section

### Diagnostic Strategy for Volume Constant Bug üîç

**PRIORITY:** This is a calculation logic bug, not a timing/orchestrator issue. Must diagnose BEFORE implementing band-aids.

**Step 1: Add Diagnostic Logging to calculateVentilationRates() (line 2506)**
```javascript
// After line 2531 (reading volume and ach)
const volume = window.TEUI.parseNumeric(getExternalValue("d_105", isReferenceCalculation)) || 0;
const ach = window.TEUI.parseNumeric(ModeManager.getValue("l_118")) || 0;

// ADD DIAGNOSTIC LOGGING
if (ventMethod === "Volume Constant") {
  console.log(`[S13 Volume Constant Debug] ${isReferenceCalculation ? "REF" : "TARGET"}`);
  console.log(`  ventMethod: "${ventMethod}"`);
  console.log(`  volume (d_105): ${volume}`);
  console.log(`  ach (l_118): ${ach}`);
  console.log(`  formula: (${ach} * ${volume}) / 3.6 = ${(ach * volume) / 3.6}`);
  console.log(`  ventRateLs will be: ${volume > 0 ? (ach * volume) / 3.6 : 0}`);
}
```

**Step 2: Test and Record Values**
- Open browser console
- Set g_118 to "Volume Constant"
- Set d_116 to "Cooling"
- Check console output for BOTH Target and Reference modes
- Record actual values for volume, ach, and calculated ventRateLs

**Expected Behavior:**
- volume (d_105) should be > 0 (e.g., 300 m¬≥ from S12)
- ach (l_118) should be 3.0 (default for Volume Constant per line 2204)
- ventRateLs should be: (3.0 * 300) / 3.6 = 250 L/s

**If volume = 0:**
- Check if S12 is calculating d_105 correctly
- Check if S12 is publishing d_105 to StateManager with/without ref_ prefix
- Verify getExternalValue() is reading correct StateManager key

**If ach = 0:**
- Check if l_118 slider is initialized correctly
- Check if ModeManager.getValue("l_118") returns correct value
- Verify slider value persists when switching to Volume Constant

**If both > 0 but ventRateLs still 0:**
- Check for JavaScript error in calculation
- Verify conditional logic in line 2552-2553 is executing correctly

### Potential Fixes Based on Diagnosis ü©π

**Fix Option A: Missing Volume Publication (if volume = 0)**
```javascript
// In S12 (4012-Section12.js), verify d_105 publication
// Should already be fixed per "Elephant Bug" (commit ae66290), but verify:
setCalculatedValue("d_105", d105_vol, "number-2dp-comma", isReferenceCalculation);
// AND ensure it's in the return statement for Reference engine storage
```

**Fix Option B: ACH Not Initialized for Volume Constant (if ach = 0)**
```javascript
// In handleVentilationMethodChange (line 2200-2208)
// Current code sets l_118 to 3.0 when Volume Constant selected
// But may need to trigger a recalculation after setting:
if (newValue === "Volume Constant") {
  const expectedACH = getFieldDefault("l_118") || "3";
  if (currentACH !== expectedACH) {
    ModeManager.setValue("l_118", expectedACH);
    // POTENTIAL FIX: Force recalculation after ACH change
    setTimeout(() => {
      calculateVentilationRates(ModeManager.currentMode === "reference");
    }, 50);
  }
}
```

**Fix Option C: Conditional Logic Issue (if both > 0 but still fails)**
```javascript
// Replace line 2552-2553 conditional with more explicit logic:
} else if (ventMethod === "Volume Constant") {
  if (volume === 0) {
    console.warn("[S13] Volume Constant selected but d_105 (volume) = 0");
    ventRateLs = 0;
  } else if (ach === 0) {
    console.warn("[S13] Volume Constant selected but l_118 (ACH) = 0");
    ventRateLs = 0;
  } else {
    ventRateLs = (ach * volume) / 3.6;
    console.log(`[S13] Volume Constant: ${ach} ACH * ${volume} m¬≥ / 3.6 = ${ventRateLs} L/s`);
  }
}
```

### BUG #2: Indoor RH% (i_59) Investigation Strategy üîç

**TO BE INVESTIGATED AFTER BUG #1 (Volume Constant) IS FIXED**

**Step 1: Identify where i_59 is used in cooling calculations**
```javascript
// Search for i_59 usage in S13
// Listeners exist (lines 2288-2289) but where is the value consumed?
// Possible locations:
// - calculateCoolingVentilation() (lines 2631-2717)
// - calculateCoolingSystem() (lines 2402-2492)
// - Cooling.js (external module)
```

**Step 2: Check if calculation is mode-aware**
```javascript
// If i_59 is read, verify it uses mode-aware pattern:
const indoorRH_i59 = window.TEUI.parseNumeric(
  getExternalValue("i_59", isReferenceCalculation)
) || 50;

// NOT:
const indoorRH_i59 = window.TEUI.StateManager.getValue("i_59"); // ‚ùå Target-only
```

**Step 3: Add diagnostic logging**
```javascript
// Add to the function that uses i_59
console.log(`[S13 Indoor RH Debug] ${isReferenceCalculation ? "REF" : "TARGET"}`);
console.log(`  i_59 value: ${indoorRH_i59}`);
console.log(`  Affects calculation: [identify which value changes based on i_59]`);
```

**Note:** This is a separate bug from Volume Constant - affects only Reference mode, likely a missing mode-aware read similar to the bugs we fixed in free cooling calculations (Oct 6).

### Next Steps üìã

**IMMEDIATE PRIORITY: Volume Constant Diagnostic (Oct 7, 2025)**

1. **Add diagnostic logging** (Step 1 above) to calculateVentilationRates()
2. **Test with Volume Constant** selected and record console output
3. **Identify which value is missing/zero:**
   - volume (d_105 from S12)
   - ach (l_118 slider)
   - or calculation logic error
4. **Apply appropriate fix** (Option A, B, or C based on diagnosis)
5. **Test in BOTH Target and Reference modes**
6. **Verify cooling loads now generate** with g_118 = "Volume Constant"

**SECONDARY: S08 RH% Investigation**

1. Check if Cooling.js has Reference mode awareness
2. Verify cooling_latentLoadFactor publication with ref_ prefix
3. If missing, calculate latent load factor directly in S13 from S08 RH%

**Long-Term (Post-Orchestrator):**

1. Once Volume Constant bug fixed, reassess if timing issues remain
2. If SEPT15-RACE-MITIGATION.md Orchestrator gets implemented, S13 becomes migration candidate
3. Remove any temporary workarounds once proper dependency graph in place

**DO NOT:**
- Add more listeners without understanding why they're needed
- Remove restrictions without understanding why they existed
- Make multiple changes at once
- Commit broken code
- Treat band-aids as permanent solutions

### Wins Today üéâ

Despite the remaining cooling toggle issue:
- ‚úÖ Free cooling calculations work when triggered properly
- ‚úÖ Number formatting fixed across entire section
- ‚úÖ All mode-aware reads implemented correctly
- ‚úÖ Deep understanding of S13 calculation dependencies gained

The remaining issue is about **timing and ordering**, not about the calculation logic itself.

---

**Last Updated:** October 6, 2025 - End of Day
**Current Status:** Paused for deeper analysis
**Working Baseline:** Commit `8d5b2eb` - Free cooling and formatting work, cooling toggle needs investigation
**Next Session:** Investigation phase - no code changes until root cause understood
