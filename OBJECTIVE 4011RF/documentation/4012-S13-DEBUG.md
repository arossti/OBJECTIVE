# S13 Mechanical Loads - Known Issues & Implementation Plan

**Current Branch:** SON-OF-A-BOSS (as of Oct 6, 2025)
**Parent Branch:** IRONING (commit `a17e46d`)

---

## CRITICAL CONTEXT FOR NEW AGENTS

### Architectural Constraints

**MANDATORY:** All solutions MUST conform to the dual-state architecture documented in:
- **`../README.md`** (root directory) - Core architectural principles
- Pattern A dual-state isolation requirements
- Mode-aware calculation patterns
- State sovereignty principles

**DO NOT:**
- Violate state isolation between Target and Reference modes
- Add calculations to `switchMode()` (UI toggle is display-only)
- Use Target values as fallbacks for Reference calculations
- Break the dual-engine calculation pattern

### The Excel vs JavaScript Synchronicity Problem

**ROOT CAUSE OF REMAINING BUGS:**

Excel is **asynchronous** - calculations can happen in any order and eventually resolve through iterative recalculation. Our JavaScript app is **synchronous** - calculations must execute in the correct order or they fail.

**Example:**
```
Excel: d_117 (cooling load) can calculate BEFORE d_120 (ventilation rate) exists
       because Excel will recalculate d_117 automatically when d_120 becomes available

JavaScript: If d_117 calculation runs before d_120 is published to StateManager,
           d_117 gets 0 and stays 0 until something triggers recalculation
```

**This is why we see "whack-a-mole" behavior** - adjusting a ventilation parameter triggers `calculateAll()`, which re-runs cooling calculations with now-available ventilation values, and suddenly cooling loads appear.

**Solutions must ensure:**
1. Calculation order matches dependency chain
2. All prerequisite values are published BEFORE dependent calculations read them
3. Or calculations must be robust to missing values (store results, re-run when dependencies available)

### Critical Historical Fixes

**October 5-6, 2025 - The Journey to Current State:**

**1. The Elephant Bug (SOLVED ✅)**
- **Problem:** S13 Reference ventilation showed 0.00 for d_120 and everything downstream
- **Root Cause:** S12's `calculateVolumeMetrics()` calculated `d_105` (Conditioned Volume) but NEVER published it with `ref_` prefix
- **Fix (commit `ae66290`):** S12 now calls `setCalculatedValue("d_105", d105_vol, "number-2dp-comma", isReferenceCalculation)` AND includes `d_105` in return statement
- **Result:** Ventilation by volume now has the volume it needs to calculate

**2. Number Formatting (SOLVED ✅)**
- **Fix (commit `df37cb7`):** Implemented field-specific format map (S10 pattern) for 45 calculated fields
- **Result:** Proper commas, percentages, and decimal places in both modes

**3. Free Cooling Calculations (SOLVED ✅)**
- **Fix (commits `c7597d5`, `d55e35d`, `8d5b2eb`):** Added mode-aware reads to `calculateCEDMitigated()` and `calculateFreeCooling()`
- **Result:** d_124, h_124, m_124, m_129 all calculate correctly in Reference mode

**4. Import Sync (SOLVED ✅)**
- **Fix (commit `a17e46d`):** Implemented 3-step Pattern A import sync for 11 S13 user input fields
- **Result:** 90% Excel import parity confirmed

### Current State Summary

**What Works:**
- ✅ S13 Reference ventilation calculations (d_120, d_121, i_121, m_121)
- ✅ S13 Reference free cooling (d_124, h_124, m_124, m_129)
- ✅ Number formatting in both modes
- ✅ Import sync for all Pattern A sections including S13
- ✅ S12 publishes ref_d_105 for volume-based ventilation

**What's Broken:**
- ❌ Reference mode cooling toggle (d_116) doesn't immediately calculate d_117
- ❌ "Volume Constant" ventilation method zeros out cooling load (pre-existing, in gh-pages too)
- ❌ Calculation order fragility - values depend on specific execution sequence
- ❌ S08 RH% (cooling season humidity) doesn't affect Reference model cooling calculations
  - In Target mode: Higher permissible RH% reduces seasonal cooling load
  - In Reference mode: RH% changes have no effect on cooling calculations
  - Need to ensure S08's humidity settings flow to Reference model cooling logic

---

**Original Status (kept for reference):**
✅ Reference mode ventilation calculations WORKING (as of commit `37359d5`)
🐘 S12 now publishes `ref_d_105` (Conditioned Volume) - The elephant is moving!

---

## KNOWN ISSUES

### 1. Number Formatting in Reference Mode

**Symptom:**
- When switching to Reference mode, number formats are lost
- Missing comma thousands separators (e.g., `8000` instead of `8,000`)
- Percentages show as decimals (e.g., `1.7` instead of `170%`)
- Specifically affects: i_122, d_124, and all fields with `number-2dp-comma` format

**Root Cause:**
`ModeManager.updateCalculatedDisplayValues()` (lines 199-301) uses hardcoded formats:
- Only `m_115` gets `percent-0dp`
- Everything else gets `number-2dp` (no comma, no percentage handling)

**Probable Fix:**
Create a field-specific format map matching the `setFieldValue()` calls:
```javascript
const fieldFormats = {
  "i_122": "percent-0dp",        // Latent load factor
  "d_124": "percent-0dp",        // Free cooling %
  "m_115": "percent-0dp",        // AFUE efficiency
  "d_121": "number-2dp-comma",   // Heating vent energy
  "m_121": "number-2dp-comma",   // Net heat loss
  "d_122": "number-2dp-comma",   // Cooling vent energy
  "m_129": "number-2dp-comma",   // CED mitigated
  // ... etc
};
const formatType = fieldFormats[fieldId] || "number-2dp-comma";
```

**Implementation Method:**
1. **Backup first:** Commit current working state
2. **Map formats:** Review all `setFieldValue()` calls in S13 to build complete format map
3. **Update function:** Replace lines 265-277 with format map lookup
4. **Test immediately:** Hard refresh, toggle to Reference mode, verify formats
5. **If broken:** `git reset --hard` to previous commit
6. **If working:** Commit with clear message about formatting only

**Risk Level:** 🟡 MEDIUM - Only affects display, not calculations. Revert is easy.

---

### 2. Free Cooling & CED Calculations in Reference Mode

**Symptom:**
- **d_124** (Free Cooling %) shows `0.00` in Reference mode
- **m_129** (CED Mitigated) shows `0.00` in Reference mode
- Target mode shows proper values (e.g., m_129 = `-20.73` days)

**Root Cause:**
Functions use `getFieldValue()` which doesn't handle `ref_` prefix:

**Problem Functions:**
1. `calculateCEDMitigated()` (line 2728):
   - Reads `d_129`, `h_124`, `d_123` without mode awareness
   - Should read `ref_d_129`, `ref_h_124`, `ref_d_123` when `isReferenceCalculation=true`

2. `calculateFreeCooling()` (line 2747):
   - Reads `h_120` without mode awareness (line 2763)
   - Reads `cooling_h_124` without mode awareness (line 2770)
   - Reads `d_129` without mode awareness (line 2821)
   - Only calculates d_124 and m_124 for Target mode (line 2819 check)

**Probable Fix:**

```javascript
// calculateCEDMitigated - add mode-aware reads
const d129 = window.TEUI.parseNumeric(
  isReferenceCalculation
    ? window.TEUI.StateManager.getValue("ref_d_129")
    : getFieldValue("d_129")
) || 0;
// ... same for h_124, d_123

// calculateFreeCooling - add mode-aware reads
const h_120 = window.TEUI.parseNumeric(
  isReferenceCalculation
    ? window.TEUI.StateManager.getValue("ref_h_120")
    : getFieldValue("h_120")
) || 0;

const h_124_raw = isReferenceCalculation
  ? window.TEUI.StateManager.getValue("ref_cooling_h_124")
  : window.TEUI.StateManager.getValue("cooling_h_124");

// Calculate d_124 and m_124 for BOTH modes, return object
return {
  h_124: finalFreeCoolingLimit,
  d_124: percentFreeCooling,
  m_124: activeCoolingDays,
};

// Update call site in calculateReferenceModel (line 2934)
const freeCoolingResults = calculateFreeCooling(true); // Not wrapped in object
```

**Implementation Method:**
1. **Test first:** Verify current calculations work in Target mode
2. **One function at a time:**
   - Fix `calculateCEDMitigated()` first
   - Commit and test
   - Then fix `calculateFreeCooling()`
   - Commit and test
3. **Each test:** Check d_124, m_129 in BOTH Target and Reference modes
4. **Verify dependencies:** Ensure Cooling.js publishes `ref_cooling_h_124` and `ref_cooling_m_124`

**Risk Level:** 🔴 HIGH - These functions are in the critical calculation chain. Changes could break ventilation/cooling flow.

**Mitigation:**
- Make changes to ONE function per commit
- Test Target mode first (should still work)
- Test Reference mode (should now work)
- If broken, `git reset --hard` immediately

---

## IMPORT FUNCTIONALITY - TODO

**Reference:** See `MAPPER.md` for complete import sync pattern documentation

**Current State:**
- ✅ S02-S12 have import sync via `syncFromGlobalState()` pattern
- ❌ S13 does NOT have import sync yet
- ❌ S15 has partial import (only d_142 field)

**S13 Import Requirements:**

Per previous session analysis, S13 needs to sync **11 user input fields**:

```javascript
// Fields to sync from Excel import:
[
  "d_113",  // Primary Heating System
  "f_113",  // HSPF
  "j_115",  // AFUE
  "d_116",  // Cooling System
  "j_116",  // COPc (cooling efficiency)
  "d_118",  // HRV/ERV SRE %
  "g_118",  // Ventilation Method
  "l_118",  // ACH
  "d_119",  // Rate Per Person
  "l_119",  // Summer Boost
  "k_120",  // Unoccupied Setback %
]
```

**Implementation:** Follow 3-step pattern from MAPPER.md:

**Step 1:** Add `syncFromGlobalState()` to TargetState (S13 lines ~45-65)
```javascript
syncFromGlobalState: function (fieldIds = [/* 11 fields above */]) {
  fieldIds.forEach((fieldId) => {
    const globalValue = window.TEUI.StateManager.getValue(fieldId);
    if (globalValue !== null && globalValue !== undefined) {
      this.setValue(fieldId, globalValue, "imported");
    }
  });
},
```

**Step 2:** Add `syncFromGlobalState()` to ReferenceState (S13 lines ~145-165)
```javascript
syncFromGlobalState: function (fieldIds = [/* 11 fields above */]) {
  fieldIds.forEach((fieldId) => {
    const refFieldId = `ref_${fieldId}`;
    const globalValue = window.TEUI.StateManager.getValue(refFieldId);
    if (globalValue !== null && globalValue !== undefined) {
      this.setValue(fieldId, globalValue, "imported");
    }
  });
},
```

**Step 3:** Add S13 to FileHandler sync array
```javascript
// In 4011-FileHandler.js, add to patternASections array:
{ id: "sect13", name: "S13" },
```

**Step 4:** Expose TargetState and ReferenceState in module return
```javascript
// In S13 return statement (~line 3520):
TargetState: TargetState,
ReferenceState: ReferenceState,
```

**Commit Reference:** See commit `639e119` (currently not on branch, but saved)
- This commit has the complete S13 import sync implementation
- Can cherry-pick after other bugs are fixed

**Risk Level:** 🟢 LOW - Import sync is well-tested pattern, isolated from calculations

---

## TESTING CHECKLIST

After ANY changes to S13:

**Target Mode:**
- [ ] All heating values calculate (d_114, l_113, etc.)
- [ ] All ventilation values calculate (d_120, d_121, m_121, etc.)
- [ ] All cooling values calculate (d_122, d_123, d_124, etc.)
- [ ] Free cooling shows (h_124, d_124, m_124)
- [ ] CED values show (d_129, m_129)
- [ ] Number formats correct (commas, percentages)
- [ ] Sliders update calculations (d_118, l_118, etc.)

**Reference Mode:**
- [ ] Mode switch preserves values (slider thumbs move)
- [ ] All calculations show non-zero values
- [ ] Number formats correct (commas, percentages)
- [ ] Ventilation chain works (d_120 ≠ 0)
- [ ] Free cooling calculates (d_124, m_129 ≠ 0 if applicable)
- [ ] T-cells show correct comparison indicators

**Mode Switching:**
- [ ] Toggle Target → Reference → Target preserves values
- [ ] No console errors
- [ ] Calculations update on slider changes in both modes

---

## COMMIT HISTORY

**Working Baseline:** `37359d5` - Clean up S13 diagnostic logging
- S13 Reference ventilation works
- S12 publishes ref_d_105
- Slider values update on mode switch
- All diagnostic logging removed

**Previous Commits (on IRONING):**
- `ae66290` - CRITICAL: S12 publishes ref_d_105 (THE FIX)
- `286a27d` - Fix S13 slider.value update in refreshUI
- `0fc4ee7` - Safe restore point before S13 work

**Saved but not on branch:**
- `639e119` - S13 import sync complete (can cherry-pick later)
- `7b0a347` - Formatting fixes (BROKE ventilation, reverted)

---

## NOTES

**What Works:**
- S13 Reference ventilation calculations are CORRECT
- Volume-based ventilation (d_120) calculates properly
- Heating season ventilation energy (d_121, i_121, m_121) works
- Cooling season ventilation (d_122, d_123) works
- The calculation chain S13 → S14 → S15 → S04 → S01 is unblocked

**What Needs Polish:**
- Display formatting in Reference mode
- Free cooling calculations in Reference mode
- Import sync functionality (future feature)

**Key Lesson:**
The "Final Boss" victory (commit `8b1bb24`) was premature - it fixed g_118 state isolation but missed:
1. The slider.value update bug (fixed in `286a27d`)
2. The missing ref_d_105 publication (fixed in `ae66290`)

Always test BOTH modes thoroughly after "victory" declarations!

---

## OCTOBER 6, 2025 SESSION SUMMARY

### Fixes Completed Today ✅

**1. Free Cooling Calculations (Commits: c7597d5, d55e35d, 8d5b2eb)**
- ✅ Added mode-aware reads to `calculateCEDMitigated()` for d_129, h_124, d_123
- ✅ Added mode-aware reads to `calculateFreeCooling()` for h_120, cooling_h_124, d_129, cooling_m_124
- ✅ Fixed `setFieldValue()` parameter bug - removed incorrect `isReferenceCalculation` 4th parameter
- ✅ Free cooling values (d_124, h_124, m_124) now calculate correctly in Reference mode
- ✅ CED mitigated (m_129) now calculates correctly in Reference mode

**2. Number Formatting (Commit: df37cb7)**
- ✅ Implemented field-specific format map following S10 pattern
- ✅ 45 calculated fields now have correct formats (percentages, commas, decimals)
- ✅ Formats work correctly in BOTH Target and Reference modes

### Issues Discovered Today 🐛

**Critical: Reference Mode Cooling Toggle Intermittent Failure**

**Symptom:**
- User enters Reference mode → selects "Cooling" at d_116 → **d_117 shows 0.00**
- User then adjusts ANY ventilation parameter (g_118, d_118, l_118, etc.) → **d_117 suddenly appears with correct value** (e.g., 3,136.69)
- Subsequent edits work correctly
- Like a teeter-totter or whack-a-mole - values appear/disappear based on calculation order

**Comparison with Working Version:**
- gh-pages deployment (commit `21fbbe0`) works correctly
- When "Cooling" is selected in Reference mode → d_117 calculates IMMEDIATELY
- No need to adjust ventilation parameters

**Root Cause Hypothesis:**
The issue is NOT in the calculation logic itself (values are correct once they appear), but rather:
1. **Calculation Order/Timing:** Calculations may depend on values that aren't available yet when triggered
2. **Missing Trigger:** The d_116 dropdown change may not be triggering the full calculation chain
3. **State Availability:** Required inputs (volume, ventilation rate, etc.) may not be published when cooling system calculates

**Whack-a-Mole Pattern Observed:**
- If volume unavailable → ventilation fails
- If ventilation unavailable → cooling fails
- Adjusting ventilation re-triggers everything → cooling finally works
- This suggests **calculation dependencies are fragile** - need specific execution order

**What We Tried (Oct 6 afternoon):**
1. ❌ Added ref_ listeners for dropdowns (d_113, d_116, l_119) - didn't help
2. ❌ Removed "Target-only" DOM update restrictions from 5 functions - didn't help
3. Both reverted - too many changes without understanding root cause

**Key Insight from User:**
> "S13 has values that are almost like a teeter-totter, or unwanted game of whackamole... We may need to fine tune the calculation ordering within S13 before we will be able to finish it."

**CRITICAL PATTERN OBSERVED (gh-pages + current commit):**
- Setting g_118 (Ventilation Method) to "Volume Constant" → **d_117 (Cooling Load) becomes 0.00**
- This occurs in BOTH gh-pages deployment AND current commit
- Suggests this is a pre-existing issue, NOT introduced by today's changes
- May indicate ventilation method choice affects cooling calculation availability
- **Mystifying:** Why would ventilation method zero out cooling load?

### Technical Debt Identified 🔧

**1. Calculation Order Dependencies**
- S13 has complex interdependencies: heating → ventilation → cooling → free cooling → CED
- Reference mode calculations may execute in wrong order or with incomplete inputs
- Need to ensure all prerequisite values are available BEFORE dependent calculations run

**2. State Publication Timing**
- Values may be calculated but not yet published to StateManager when next calculation reads them
- Need to verify calculation flow in `calculateReferenceModel()` matches `calculateTargetModel()`
- May need explicit ordering or dependency management

**3. Fragility vs Robustness**
- Target mode appears more robust - tolerates missing values better
- Reference mode calculations appear fragile - fail if ANY dependency missing
- Need to understand WHY Target mode works when Reference mode doesn't

### Next Steps 📋

**Before Making ANY Code Changes:**
1. Compare `calculateReferenceModel()` execution order with `calculateTargetModel()`
2. Add targeted logging to trace exact sequence when d_116 changes in Reference mode
3. Identify which value is missing/unavailable when cooling calculation runs
4. Understand why adjusting ventilation "fixes" it (what does it re-trigger?)
5. **CRITICAL:** Investigate why "Volume Constant" ventilation method zeros out cooling load (d_117)
   - Check if there's conditional logic based on g_118 value
   - Verify if "Volume Constant" triggers different calculation path
   - Understand the connection between ventilation method and cooling calculations

**After Understanding Root Cause:**
1. Apply minimal, surgical fix to calculation order or state publication
2. Test ONLY the cooling toggle scenario
3. Verify no regression in ventilation or other calculations
4. Document exact fix and reasoning

**DO NOT:**
- Add more listeners without understanding why they're needed
- Remove restrictions without understanding why they existed
- Make multiple changes at once
- Commit broken code

### Wins Today 🎉

Despite the remaining cooling toggle issue:
- ✅ Free cooling calculations work when triggered properly
- ✅ Number formatting fixed across entire section
- ✅ All mode-aware reads implemented correctly
- ✅ Deep understanding of S13 calculation dependencies gained

The remaining issue is about **timing and ordering**, not about the calculation logic itself.

---

**Last Updated:** October 6, 2025 - End of Day
**Current Status:** Paused for deeper analysis
**Working Baseline:** Commit `8d5b2eb` - Free cooling and formatting work, cooling toggle needs investigation
**Next Session:** Investigation phase - no code changes until root cause understood
