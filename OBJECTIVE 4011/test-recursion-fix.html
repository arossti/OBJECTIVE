<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEUI 4011 - Recursion Fix Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .test-container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold;
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb;
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb;
        }
        .info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß TEUI 4011 Recursion Fix Test</h1>
        
        <div class="info">
            <strong>Test Purpose:</strong> Verify that the infinite recursion errors have been resolved.
        </div>

        <div id="test-status" class="status info">
            üîÑ Initializing test environment...
        </div>

        <div id="console-log" class="log-container">
            <strong>Console Output:</strong><br>
            <div id="log-content"></div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="test-button" onclick="runBasicTest()">üß™ Run Basic Test</button>
            <button class="test-button" onclick="triggerCalculations()">‚öôÔ∏è Trigger Calculations</button>
            <button class="test-button" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div style="margin-top: 30px;">
            <h3>üéØ Expected Results:</h3>
            <ul>
                <li>‚úÖ No "Maximum call stack size exceeded" errors</li>
                <li>‚úÖ StateManager initializes successfully</li>
                <li>‚úÖ Section modules load without recursion loops</li>
                <li>‚úÖ Calculator.calculateAll() completes without infinite loops</li>
            </ul>
        </div>
    </div>

    <script>
        // Capture console output
        const originalConsoleError = console.error;
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        
        let errorCount = 0;
        let recursionErrors = 0;
        let testStartTime = Date.now();
        
        function logToPage(message, type = 'log') {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logContent.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        console.error = function(...args) {
            errorCount++;
            const message = args.join(' ');
            if (message.includes('Maximum call stack size exceeded')) {
                recursionErrors++;
            }
            logToPage(`‚ùå ERROR: ${message}`, 'error');
            originalConsoleError.apply(console, args);
        };
        
        console.warn = function(...args) {
            logToPage(`‚ö†Ô∏è WARN: ${args.join(' ')}`, 'warn');
            originalConsoleWarn.apply(console, args);
        };
        
        console.log = function(...args) {
            const message = args.join(' ');
            if (!message.includes('[DEBUG]') && !message.includes('‚ú®')) {
                logToPage(`‚ÑπÔ∏è LOG: ${message}`);
            }
            originalConsoleLog.apply(console, args);
        };

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('test-status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        function clearLog() {
            document.getElementById('log-content').innerHTML = '';
            errorCount = 0;
            recursionErrors = 0;
        }

        function runBasicTest() {
            clearLog();
            updateStatus('üß™ Running basic recursion test...', 'info');
            
            logToPage('Starting basic recursion protection test...');
            
            // Test 1: Check if global flag works
            logToPage('Test 1: Checking global recursion flag...');
            if (typeof window.sectionCalculationInProgress !== 'undefined') {
                logToPage('‚úÖ Global recursion flag exists');
            } else {
                logToPage('‚ùå Global recursion flag missing');
            }
            
            // Test 2: Check StateManager
            logToPage('Test 2: Checking StateManager...');
            if (window.TEUI && window.TEUI.StateManager) {
                logToPage('‚úÖ StateManager is available');
                
                // Test basic setValue without triggering calculations
                try {
                    window.TEUI.StateManager.setValue('test_field', '123', 'calculated');
                    logToPage('‚úÖ StateManager.setValue works');
                } catch (e) {
                    logToPage(`‚ùå StateManager.setValue failed: ${e.message}`);
                }
            } else {
                logToPage('‚ùå StateManager not available');
            }
            
            // Test 3: Check Calculator
            logToPage('Test 3: Checking Calculator...');
            if (window.TEUI && window.TEUI.Calculator) {
                logToPage('‚úÖ Calculator is available');
            } else {
                logToPage('‚ùå Calculator not available');
            }
            
            setTimeout(() => {
                if (recursionErrors === 0) {
                    updateStatus('‚úÖ Basic test passed - No recursion errors detected!', 'success');
                } else {
                    updateStatus(`‚ùå Basic test failed - ${recursionErrors} recursion errors found`, 'error');
                }
            }, 1000);
        }

        function triggerCalculations() {
            updateStatus('‚öôÔ∏è Testing calculation triggers...', 'info');
            logToPage('Starting calculation trigger test...');
            
            const beforeErrors = recursionErrors;
            
            try {
                // Test Calculator.calculateAll if available
                if (window.TEUI && window.TEUI.Calculator && window.TEUI.Calculator.calculateAll) {
                    logToPage('Triggering Calculator.calculateAll()...');
                    window.TEUI.Calculator.calculateAll();
                    logToPage('‚úÖ Calculator.calculateAll() completed');
                }
                
                // Test individual section calculations
                if (window.TEUI && window.TEUI.SectionModules) {
                    const sections = ['sect09', 'sect10', 'sect11', 'sect12', 'sect13'];
                    sections.forEach(sectionId => {
                        const section = window.TEUI.SectionModules[sectionId];
                        if (section && section.calculateAll) {
                            logToPage(`Triggering ${sectionId}.calculateAll()...`);
                            section.calculateAll();
                            logToPage(`‚úÖ ${sectionId}.calculateAll() completed`);
                        }
                    });
                }
                
                setTimeout(() => {
                    const newErrors = recursionErrors - beforeErrors;
                    if (newErrors === 0) {
                        updateStatus('‚úÖ Calculation test passed - No new recursion errors!', 'success');
                    } else {
                        updateStatus(`‚ùå Calculation test failed - ${newErrors} new recursion errors`, 'error');
                    }
                }, 2000);
                
            } catch (e) {
                logToPage(`‚ùå Calculation test error: ${e.message}`);
                updateStatus('‚ùå Calculation test failed with exception', 'error');
            }
        }

        // Initialize
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (recursionErrors === 0) {
                    updateStatus('‚úÖ Page loaded successfully - No recursion errors detected!', 'success');
                } else {
                    updateStatus(`‚ùå Page loaded with ${recursionErrors} recursion errors`, 'error');
                }
            }, 3000);
        });
        
        logToPage('Test environment initialized. Running automatic load test...');
    </script>

    <!-- Load the main TEUI application -->
    <script src="4011-init.js"></script>
    <script src="4011-StateManager.js"></script>
    <script src="4011-Calculator.js"></script>
    <script src="4011-FieldManager.js"></script>
    <script src="4011-ReferenceManager.js"></script>
    <script src="4011-ReferenceToggle.js"></script>
    
    <!-- Load critical sections that were involved in recursion -->
    <script src="sections/4011-Section09.js"></script>
    <script src="sections/4011-Section10.js"></script>
    <script src="sections/4011-Section11.js"></script>
    <script src="sections/4011-Section12.js"></script>
    <script src="sections/4011-Section13.js"></script>
</body>
</html> 