<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Section 07 Dual-Engine Water Method Test</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="4011-styles.css" />
    <link rel="stylesheet" href="4011-MobileStyles.css" />
    <style>
      .disabled-input {
        background-color: #f8f9fa !important;
        color: #6c757d !important;
        opacity: 0.6;
      }
      .reference-locked {
        background-color: #fff3cd !important;
        border: 1px solid #ffeaa7 !important;
      }
      .debug-highlight {
        background-color: #d4edda !important;
        border: 1px solid #c3e6cb !important;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <h1>Section 07 Dual-Engine Water Method Test</h1>
          <p>
            This test verifies that the water method dropdown (d_49) and user
            defined field (e_49) work independently in Reference Mode.
          </p>

          <!-- Reference Toggle Button -->
          <div class="mb-3">
            <button id="toggleReferenceBtn" class="btn btn-danger">
              Show Reference
            </button>
            <span id="modeIndicator" class="ms-2 badge bg-primary"
              >Design Mode</span
            >
          </div>

          <!-- Reference Standard Selector -->
          <div class="mb-3">
            <label for="d_13" class="form-label">Reference Standard:</label>
            <select id="d_13" data-field-id="d_13" class="form-select">
              <option value="OBC SB12 3.1.1.2.C4">OBC SB12 3.1.1.2.C4</option>
              <option value="OBC SB12 3.1.1.2.C1">OBC SB12 3.1.1.2.C1</option>
              <option value="NBC T1">NBC T1</option>
              <option value="PH Classic">PH Classic</option>
            </select>
          </div>

          <!-- Test Values Display -->
          <div class="row mb-3">
            <div class="col-md-6">
              <h5>Current Values (Mode-Aware)</h5>
              <div>d_49 (Water Method): <span id="current_d_49">-</span></div>
              <div>e_49 (User Defined): <span id="current_e_49">-</span></div>
              <div>e_50 (By Engineer): <span id="current_e_50">-</span></div>
              <div>d_63 (Occupants): <span id="current_d_63">-</span></div>
            </div>
            <div class="col-md-6">
              <h5>Reference Values (ref_ prefix)</h5>
              <div>ref_d_49: <span id="ref_d_49">-</span></div>
              <div>ref_e_49: <span id="ref_e_49">-</span></div>
              <div>ref_e_50: <span id="ref_e_50">-</span></div>
              <div>ref_j_50: <span id="ref_j_50">-</span></div>
              <div>ref_k_49: <span id="ref_k_49">-</span></div>
            </div>
          </div>

          <!-- Section 07 Water Use Table -->
          <div id="waterUse" class="section-container">
            <h3>Section 07: Water Use</h3>
            <div class="table-responsive">
              <table class="table table-bordered data-table">
                <thead>
                  <tr>
                    <th>A</th>
                    <th>B</th>
                    <th>C</th>
                    <th>D</th>
                    <th>E</th>
                    <th>F</th>
                    <th>G</th>
                    <th>H</th>
                    <th>I</th>
                    <th>J</th>
                    <th>K</th>
                    <th>L</th>
                    <th>M</th>
                    <th>N</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Water Use Method Row -->
                  <tr data-id="W.1.0">
                    <td></td>
                    <td>W.1.0</td>
                    <td>Total Hot+Cold Water Use (Method)</td>
                    <td>
                      <select
                        data-field-id="d_49"
                        data-dropdown-id="dd_d_49"
                        class="form-select user-input"
                      >
                        <option value="User Defined">User Defined</option>
                        <option value="By Engineer">By Engineer</option>
                        <option value="PHPP Method">PHPP Method</option>
                        <option value="NBC Method">NBC Method</option>
                        <option value="OBC Method">OBC Method</option>
                        <option value="Luxury">Luxury</option>
                      </select>
                    </td>
                    <td
                      data-field-id="e_49"
                      class="user-input editable"
                      contenteditable="true"
                    >
                      40.00
                    </td>
                    <td>lpppd (User Defined)</td>
                    <td></td>
                    <td data-field-id="h_49">40.00</td>
                    <td data-field-id="i_49">1,839,600</td>
                    <td>Net Emissions</td>
                    <td data-field-id="k_49">0.00</td>
                    <td>kgCO2e/yr</td>
                    <td>✓</td>
                    <td data-field-id="n_49">15%</td>
                  </tr>
                  <!-- DHW Use Row -->
                  <tr data-id="W.1.2">
                    <td></td>
                    <td>W.1.2</td>
                    <td>DHW Use (40% of W.1.0)</td>
                    <td></td>
                    <td
                      data-field-id="e_50"
                      class="user-input editable"
                      contenteditable="true"
                    >
                      10,000.00
                    </td>
                    <td>kWh/yr (IF By Engineer)</td>
                    <td></td>
                    <td data-field-id="h_50">16.00</td>
                    <td data-field-id="i_50">735,840</td>
                    <td data-field-id="j_50">38,484.43</td>
                    <td></td>
                    <td></td>
                    <td>✓</td>
                    <td data-field-id="n_50">15%</td>
                  </tr>
                  <!-- DHW Energy Source Row -->
                  <tr data-id="W.3.1">
                    <td></td>
                    <td>W.3.1</td>
                    <td>DHW or SHW Energy Source</td>
                    <td>
                      <select
                        data-field-id="d_51"
                        data-dropdown-id="dd_d_51"
                        class="form-select user-input"
                      >
                        <option value="Heatpump">Heatpump</option>
                        <option value="Gas">Gas</option>
                        <option value="Oil">Oil</option>
                        <option value="Electric">Electric</option>
                      </select>
                    </td>
                    <td data-field-id="e_51">0.00</td>
                    <td>Gas m³/yr</td>
                    <td>W.3.2</td>
                    <td>Net Energy Demand</td>
                    <td data-field-id="i_51">-</td>
                    <td data-field-id="j_51">12,828.14</td>
                    <td data-field-id="k_51">12,828.14</td>
                    <td>W.3.3 Net Elect. Demand</td>
                    <td>✓</td>
                    <td data-field-id="n_51">-</td>
                  </tr>
                  <!-- DHW Efficiency Row -->
                  <tr data-id="W.4.1">
                    <td></td>
                    <td>W.4.1</td>
                    <td>DHW or SHW Efficiency Factor (EF)</td>
                    <td>
                      <input
                        type="range"
                        data-field-id="d_52"
                        class="form-range user-input"
                        min="50"
                        max="400"
                        step="2"
                        value="300"
                      />
                      <span data-display-for="d_52">300%</span>
                    </td>
                    <td data-field-id="e_52">3.00</td>
                    <td>COPdhw</td>
                    <td>W.5.2</td>
                    <td>Net Demand-Recovered</td>
                    <td data-field-id="i_52">-</td>
                    <td data-field-id="j_52">12,828.14</td>
                    <td
                      data-field-id="k_52"
                      class="user-input editable"
                      contenteditable="true"
                    >
                      0.90
                    </td>
                    <td>W.4.2 AFUE</td>
                    <td>✓</td>
                    <td data-field-id="n_52">100%</td>
                  </tr>
                  <!-- DWHR Efficiency Row -->
                  <tr data-id="W.5.1">
                    <td></td>
                    <td>W.5.1</td>
                    <td>Drain Water Heat Recovery Efficiency</td>
                    <td>
                      <input
                        type="range"
                        data-field-id="d_53"
                        class="form-range user-input"
                        min="0"
                        max="70"
                        step="1"
                        value="0"
                      />
                      <span data-display-for="d_53">0%</span>
                    </td>
                    <td data-field-id="e_53">0.00</td>
                    <td>kWh/yr</td>
                    <td>W.5.3</td>
                    <td>(W.2.W) SHW Wasted</td>
                    <td data-field-id="i_53">-</td>
                    <td data-field-id="j_53">12,828.14</td>
                    <td data-field-id="k_54">0.00</td>
                    <td>Oil Demand Ltrs</td>
                    <td>!</td>
                    <td data-field-id="n_53">0%</td>
                  </tr>
                  <!-- System Losses / Exhaust Row -->
                  <tr data-id="W.6.1">
                    <td></td>
                    <td>W.6.1</td>
                    <td>System Losses / Exhaust</td>
                    <td data-field-id="d_54">0.00</td>
                    <td>-</td>
                    <td>System Losses kWh/yr</td>
                    <td>W.X</td>
                    <td>Exhaust (if Gas or Oil)</td>
                    <td data-field-id="i_54">-</td>
                    <td data-field-id="j_54">0.00</td>
                    <td data-field-id="k_55">-</td>
                    <td>-</td>
                    <td>-</td>
                    <td data-field-id="n_54">-</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Test Controls -->
          <div class="mt-4">
            <h5>Test Controls</h5>
            <div class="row">
              <div class="col-md-3">
                <button id="testBtn1" class="btn btn-primary">
                  Test: PHPP Method (E49 ghosted)
                </button>
              </div>
              <div class="col-md-3">
                <button id="testBtn2" class="btn btn-secondary">
                  Test: User Defined 50 (E49 editable)
                </button>
              </div>
              <div class="col-md-3">
                <button id="testBtn3" class="btn btn-info">
                  Test: By Engineer (E50 editable)
                </button>
              </div>
              <div class="col-md-3">
                <button id="testBtn4" class="btn btn-warning">
                  Test: By Engineer 15000 kWh
                </button>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-md-3">
                <button id="testBtn5" class="btn btn-success">
                  Test: Gas System (K52 editable)
                </button>
              </div>
              <div class="col-md-3">
                <button id="testBtn6" class="btn btn-dark">
                  Test: Electric System (D52 limited)
                </button>
              </div>
              <div class="col-md-3">
                <button id="testBtn7" class="btn btn-outline-primary">
                  Test: DWHR 42%
                </button>
              </div>
              <div class="col-md-3">
                <button id="testBtn8" class="btn btn-outline-secondary">
                  Test: High COP 4.0
                </button>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-12">
                <small class="text-muted">
                  <strong>Field Behavior:</strong>
                  User Defined = E49 editable, E50 ghosted | By Engineer = E50
                  editable, E49 ghosted (shows calculated lpppd) | Other methods
                  = Both ghosted (show calculated values)<br />
                  <strong>Equipment:</strong>
                  Heatpump/Electric = D52 editable (COP %), K52 ghosted |
                  Gas/Oil = D52 ghosted, K52 editable (AFUE) | D53 (DWHR) always
                  editable in Reference Mode
                </small>
              </div>
              <div class="col-12 mt-1">
                <small class="text-muted"
                  >Note: Using static 126 occupants for testing (normally from
                  Section 09)</small
                >
              </div>
            </div>
          </div>

          <!-- Debug Console -->
          <div class="mt-4">
            <h5>Debug Console</h5>
            <div
              id="debugConsole"
              class="border p-3"
              style="height: 200px; overflow-y: auto; background-color: #f8f9fa"
            >
              <div>Debug messages will appear here...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="4011-init.js"></script>
    <script src="4011-StateManager.js"></script>
    <script src="4011-ReferenceValues.js"></script>
    <script src="4011-AppendixE.js"></script>
    <script src="4011-ReferenceToggle.js"></script>
    <script src="sections/4011-Section07.js"></script>

    <script>
      // Test script with dual-engine logic
      let debugConsole = document.getElementById("debugConsole");
      let isReferenceMode = false;

      // Mock state storage
      let applicationState = {
        d_49: "User Defined",
        e_49: "40",
        e_50: "10000",
        d_51: "Heatpump",
        d_52: "300",
        k_52: "0.90",
        d_53: "0",
        d_63: "126",
        d_13: "OBC SB12 3.1.1.2.C4",
      };

      // Reference standards data (simplified from ReferenceValues.js)
      const referenceStandards = {
        "OBC SB12 3.1.1.2.C4": {
          d_52: "90", // DWH System Efficiency when Electric
          k_52: "90", // DWH AFUE when Gas or Oil
          d_53: "42", // DWHR Efficiency if OBC
        },
        "OBC SB12 3.1.1.2.C1": {
          d_52: "90",
          k_52: "90",
          d_53: "42",
        },
        "NBC T1": {
          d_52: "92",
          k_52: "92",
          d_53: "42",
        },
        "PH Classic": {
          d_52: "100",
          k_52: "92",
          d_53: "42",
        },
      };

      let referenceState = {
        d_49: "PHPP Method", // Different from application
        e_49: "62.5", // PHPP default
        e_50: "10000",
        d_51: "Gas", // Different from application
        d_52: "90", // Gas system default
        k_52: "0.92", // Higher AFUE for reference
        d_53: "42", // DWHR for reference
      };

      function addDebugMessage(message) {
        const timestamp = new Date().toLocaleTimeString();
        debugConsole.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        debugConsole.scrollTop = debugConsole.scrollHeight;
      }

      function getCurrentValue(fieldId) {
        if (isReferenceMode) {
          return referenceState[fieldId] || applicationState[fieldId] || "-";
        } else {
          return applicationState[fieldId] || "-";
        }
      }

      function saveCurrentModeFromDOM() {
        // Save current DOM values to the appropriate state
        const currentMode = isReferenceMode ? "reference" : "application";
        const targetState = isReferenceMode ? referenceState : applicationState;

        // Save user input fields from DOM
        const userInputFields = [
          "d_49",
          "e_49",
          "e_50",
          "d_51",
          "d_52",
          "k_52",
          "d_53",
        ];
        userInputFields.forEach((fieldId) => {
          const element = document.querySelector(`[data-field-id="${fieldId}"]`);
          if (element) {
            let value;
            if (element.tagName === "SELECT") {
              value = element.value;
            } else if (element.tagName === "INPUT") {
              value = element.value;
            } else if (element.hasAttribute("contenteditable")) {
              value = element.textContent.trim();
            }
            if (value !== undefined) {
              targetState[fieldId] = value;
              addDebugMessage(`Saved ${currentMode}: ${fieldId} = ${value}`);
            }
          }
        });
      }

      function loadCurrentModeToDOM() {
        // Load current mode's values into DOM
        const currentMode = isReferenceMode ? "reference" : "application";
        const sourceState = isReferenceMode ? referenceState : applicationState;

        // Load user input fields to DOM
        const userInputFields = [
          "d_49",
          "e_49",
          "e_50",
          "d_51",
          "d_52",
          "k_52",
          "d_53",
        ];
        userInputFields.forEach((fieldId) => {
          const element = document.querySelector(`[data-field-id="${fieldId}"]`);
          const value = sourceState[fieldId];
          if (element && value !== undefined) {
            if (element.tagName === "SELECT") {
              element.value = value;
            } else if (element.tagName === "INPUT") {
              element.value = value;
              // Update slider display if it exists
              const display = document.querySelector(
                `[data-display-for="${fieldId}"]`,
              );
              if (display) {
                display.textContent = value + "%";
              }
            } else if (element.hasAttribute("contenteditable")) {
              element.textContent = value;
            }
            addDebugMessage(`Loaded ${currentMode}: ${fieldId} = ${value}`);
          }
        });
      }

      function setValue(fieldId, value, mode = null) {
        const targetMode = mode || (isReferenceMode ? "reference" : "application");

        if (targetMode === "reference") {
          referenceState[fieldId] = value;
          addDebugMessage(`Set Reference: ${fieldId} = ${value}`);
          // Store reference values with ref_ prefix for downstream consumption
          applicationState[`ref_${fieldId}`] = value;
        } else {
          applicationState[fieldId] = value;
          addDebugMessage(`Set Application: ${fieldId} = ${value}`);
        }
      }

      function calculateWaterUse(mode) {
        const method =
          mode === "reference" ? referenceState["d_49"] : applicationState["d_49"];
        const userDefined =
          parseFloat(
            mode === "reference" ? referenceState["e_49"] : applicationState["e_49"],
          ) || 40;
        const byEngineer =
          parseFloat(
            mode === "reference" ? referenceState["e_50"] : applicationState["e_50"],
          ) || 10000;
        const systemType =
          mode === "reference" ? referenceState["d_51"] : applicationState["d_51"];
        const efficiencyPercent =
          parseFloat(
            mode === "reference" ? referenceState["d_52"] : applicationState["d_52"],
          ) || 300;
        const afue =
          parseFloat(
            mode === "reference" ? referenceState["k_52"] : applicationState["k_52"],
          ) || 0.9;
        const dwhrPercent =
          parseFloat(
            mode === "reference" ? referenceState["d_53"] : applicationState["d_53"],
          ) || 0;
        const occupants = 126; // Static for testing - normally from d_63/Section 09

        let litersPerPersonDay = 0;
        let hotWaterEnergyDemand = 0;

        switch (method) {
          case "User Defined":
            litersPerPersonDay = userDefined;
            hotWaterEnergyDemand =
              litersPerPersonDay * 0.4 * occupants * 0.0523 * 365;
            break;
          case "By Engineer":
            hotWaterEnergyDemand = byEngineer;
            const waterHeatFactor = 0.0524;
            litersPerPersonDay =
              occupants > 0 && waterHeatFactor > 0
                ? byEngineer / 365 / waterHeatFactor / occupants / 0.4
                : 0;
            break;
          case "PHPP Method":
            litersPerPersonDay = 62.5;
            hotWaterEnergyDemand =
              litersPerPersonDay * 0.4 * occupants * 0.0523 * 365;
            break;
          case "NBC Method":
            litersPerPersonDay = 220;
            hotWaterEnergyDemand =
              litersPerPersonDay * 0.4 * occupants * 0.0523 * 365;
            break;
          case "OBC Method":
            litersPerPersonDay = 275;
            hotWaterEnergyDemand =
              litersPerPersonDay * 0.4 * occupants * 0.0523 * 365;
            break;
          case "Luxury":
            litersPerPersonDay = 400;
            hotWaterEnergyDemand =
              litersPerPersonDay * 0.4 * occupants * 0.0523 * 365;
            break;
          default:
            litersPerPersonDay = 40;
            hotWaterEnergyDemand =
              litersPerPersonDay * 0.4 * occupants * 0.0523 * 365;
        }

        // Calculate heating system parameters
        const efficiency = efficiencyPercent / 100; // Convert percentage to decimal

        // Calculate j_51 (Net Thermal Demand) using Excel logic
        let netThermalDemand_j51 = 0;
        if (systemType === "Heatpump" || systemType === "Electric") {
          netThermalDemand_j51 =
            efficiency !== 0 ? hotWaterEnergyDemand / efficiency : 0;
        } else {
          netThermalDemand_j51 = afue !== 0 ? hotWaterEnergyDemand / afue : 0;
        }

        // Calculate DWHR recovery
        const dwhrRecoveryPercent = dwhrPercent / 100;
        const energyRecovered_e53 = netThermalDemand_j51 * dwhrRecoveryPercent;
        const netDemandAfterRecovery_j52 = netThermalDemand_j51 - energyRecovered_e53;

        // Calculate J53: Energy going down the drain = J51 - E53
        const energyDownDrain_j53 = netThermalDemand_j51 - energyRecovered_e53;

        // Calculate J54: Exhaust losses using Section 07 logic: =IF(D51="Gas", (J52-(J52*D52)), IF(D51="Oil", (J52-(J52*D52)), 0))
        // Note: Section 07 uses efficiency factor (e_52), not AFUE (k_52) for exhaust calculation
        let exhaustLosses_j54 = 0;
        if (systemType === "Gas" || systemType === "Oil") {
          // J52 * (1 - EfficiencyFactor) = J52 - (J52 * E52)
          exhaustLosses_j54 = netDemandAfterRecovery_j52 * (1 - efficiency);
        }

        // Calculate fuel consumption
        let gasVolume = 0,
          oilVolume = 0,
          electricalDemand = 0;

        switch (systemType) {
          case "Gas":
            // Section 07 formula: ((J52*(1-D53))/0.0373/277.7778/K52)
            // But Section 07 code uses: conversionFactor = 0.0373 * 277.7778 (multiplication!)
            const conversionFactor = 0.0373 * 277.7778;
            const adjustedDemand =
              netDemandAfterRecovery_j52 * (1 - dwhrRecoveryPercent);
            gasVolume = adjustedDemand / conversionFactor / afue;
            break;
          case "Oil":
            // Section 07 formula: ((J52*(1-D53))/(36.72*0.2777778)/K52)
            // Section 07 code uses: conversionFactor = 36.72 * 0.2777778 (multiplication!)
            const conversionFactorOil = 36.72 * 0.2777778;
            const adjustedDemandOil =
              netDemandAfterRecovery_j52 * (1 - dwhrRecoveryPercent);
            oilVolume = adjustedDemandOil / conversionFactorOil / afue;
            break;
          case "Heatpump":
          case "Electric":
            electricalDemand =
              efficiency !== 0
                ? netDemandAfterRecovery_j52 / efficiency
                : netDemandAfterRecovery_j52;
            break;
        }

        // Calculate emissions using Excel formula: =IF(D51="Oil", K54*L30/1000, IF(D51="Gas", E51*L28/1000, 0))
        const gasEmissionsFactor = 1921; // L28: gCO2e/m³
        const oilEmissionsFactor = 2753; // L30: gCO2e/litre
        let emissions_kg = 0;

        if (systemType === "Gas") {
          // E51 * L28 / 1000 (convert grams to kg)
          emissions_kg = (gasVolume * gasEmissionsFactor) / 1000;
        } else if (systemType === "Oil") {
          // K54 * L30 / 1000 (convert grams to kg)
          emissions_kg = (oilVolume * oilEmissionsFactor) / 1000;
        }

        const annualWaterUse = litersPerPersonDay * occupants * 365;
        const hotWaterLitersPerDay = litersPerPersonDay * 0.4;
        const hotWaterAnnualLiters = hotWaterLitersPerDay * occupants * 365;

        const results = {
          litersPerPersonDay: litersPerPersonDay,
          annualWaterUse: annualWaterUse,
          hotWaterLitersPerDay: hotWaterLitersPerDay,
          hotWaterAnnualLiters: hotWaterAnnualLiters,
          hotWaterEnergyDemand: hotWaterEnergyDemand,
          netThermalDemand: netThermalDemand_j51,
          energyRecovered: energyRecovered_e53,
          netDemandAfterRecovery: netDemandAfterRecovery_j52,
          efficiency: efficiency,
          gasVolume: gasVolume,
          oilVolume: oilVolume,
          electricalDemand: electricalDemand,
          emissions: emissions_kg,
        };

        // Calculate M/N column values - compliance against reference standard
        const currentStandard = applicationState["d_13"] || "OBC SB12 3.1.1.2.C4";
        const standardValues =
          referenceStandards[currentStandard] ||
          referenceStandards["OBC SB12 3.1.1.2.C4"];

        // Water use references (fixed baselines from Section 07)
        const waterUseReference = 275; // OBC Method baseline
        const waterUsePercentRaw =
          waterUseReference !== 0 ? litersPerPersonDay / waterUseReference : 0;
        const dhwUseReference = 110; // DHW baseline
        const dhwUsePercentRaw =
          dhwUseReference !== 0 ? hotWaterLitersPerDay / dhwUseReference : 0;

        // Compliance against selected reference standard
        const standardDWHR = parseFloat(standardValues["d_53"]) || 42; // Required DWHR %
        const standardCOP = parseFloat(standardValues["d_52"]) / 100 || 0.9; // Required COP as decimal
        const standardAFUE = parseFloat(standardValues["k_52"]) / 100 || 0.9; // Required AFUE as decimal

        // Calculate compliance percentages
        const dwhrCompliancePercent =
          standardDWHR !== 0 ? dwhrPercent / standardDWHR : 0;
        let efficiencyCompliancePercent = 0;
        if (systemType === "Gas" || systemType === "Oil") {
          // For fossil fuels, compare AFUE against standard AFUE
          efficiencyCompliancePercent = standardAFUE !== 0 ? afue / standardAFUE : 0;
        } else {
          // For electric/heatpump, compare COP against standard COP
          efficiencyCompliancePercent =
            standardCOP !== 0 ? efficiency / standardCOP : 0;
        }

        // Store calculated values
        if (mode === "reference") {
          setValue("h_49", litersPerPersonDay.toFixed(2), "reference");
          setValue("i_49", annualWaterUse.toFixed(0), "reference");
          setValue("h_50", hotWaterLitersPerDay.toFixed(2), "reference");
          setValue("i_50", hotWaterAnnualLiters.toFixed(0), "reference");
          setValue("j_50", hotWaterEnergyDemand.toFixed(2), "reference");
          setValue("e_52", efficiency.toFixed(2), "reference");
          setValue("j_51", netThermalDemand_j51.toFixed(2), "reference");
          setValue("e_53", energyRecovered_e53.toFixed(2), "reference");
          setValue("j_52", netDemandAfterRecovery_j52.toFixed(2), "reference");
          setValue("j_53", energyDownDrain_j53.toFixed(2), "reference");
          setValue("j_54", exhaustLosses_j54.toFixed(2), "reference");
          setValue("e_51", gasVolume.toFixed(2), "reference");
          setValue("k_51", electricalDemand.toFixed(2), "reference");
          setValue("k_54", oilVolume.toFixed(2), "reference");
          setValue("k_49", emissions_kg.toFixed(2), "reference");
          // M/N columns - compliance percentages
          setValue("n_49", (waterUsePercentRaw * 100).toFixed(0) + "%", "reference");
          setValue("n_50", (dhwUsePercentRaw * 100).toFixed(0) + "%", "reference");
          setValue(
            "n_52",
            (efficiencyCompliancePercent * 100).toFixed(0) + "%",
            "reference",
          );
          setValue(
            "n_53",
            (dwhrCompliancePercent * 100).toFixed(0) + "%",
            "reference",
          );
        } else {
          setValue("h_49", litersPerPersonDay.toFixed(2), "application");
          setValue("i_49", annualWaterUse.toFixed(0), "application");
          setValue("h_50", hotWaterLitersPerDay.toFixed(2), "application");
          setValue("i_50", hotWaterAnnualLiters.toFixed(0), "application");
          setValue("j_50", hotWaterEnergyDemand.toFixed(2), "application");
          setValue("e_52", efficiency.toFixed(2), "application");
          setValue("j_51", netThermalDemand_j51.toFixed(2), "application");
          setValue("e_53", energyRecovered_e53.toFixed(2), "application");
          setValue("j_52", netDemandAfterRecovery_j52.toFixed(2), "application");
          setValue("j_53", energyDownDrain_j53.toFixed(2), "application");
          setValue("j_54", exhaustLosses_j54.toFixed(2), "application");
          setValue("e_51", gasVolume.toFixed(2), "application");
          setValue("k_51", electricalDemand.toFixed(2), "application");
          setValue("k_54", oilVolume.toFixed(2), "application");
          setValue("k_49", emissions_kg.toFixed(2), "application");
          // M/N columns - compliance percentages
          setValue(
            "n_49",
            (waterUsePercentRaw * 100).toFixed(0) + "%",
            "application",
          );
          setValue("n_50", (dhwUsePercentRaw * 100).toFixed(0) + "%", "application");
          setValue(
            "n_52",
            (efficiencyCompliancePercent * 100).toFixed(0) + "%",
            "application",
          );
          setValue(
            "n_53",
            (dwhrCompliancePercent * 100).toFixed(0) + "%",
            "application",
          );
        }

        addDebugMessage(
          `${mode} calculation: method=${method}, system=${systemType}, lpppd=${litersPerPersonDay.toFixed(2)}, energy=${hotWaterEnergyDemand.toFixed(2)}, emissions=${emissions_kg.toFixed(2)}`,
        );

        return results;
      }

      function updateFieldVisibility() {
        const currentMethod = getCurrentValue("d_49");
        const currentSystemType = getCurrentValue("d_51");

        // E49 (User Defined lpppd) - only editable when method is "User Defined"
        const e49Field = document.querySelector('[data-field-id="e_49"]');
        const isUserDefined = currentMethod === "User Defined";

        if (e49Field) {
          if (isUserDefined) {
            e49Field.classList.remove("disabled-input");
            e49Field.setAttribute("contenteditable", "true");
          } else {
            e49Field.classList.add("disabled-input");
            e49Field.setAttribute("contenteditable", "false");
            // For "By Engineer" and other methods, show calculated value
            e49Field.textContent = getCurrentValue("h_49") || "0.00";
          }
        }

        // E50 (By Engineer kWh) - only editable when method is "By Engineer"
        const e50Field = document.querySelector('[data-field-id="e_50"]');
        const isByEngineer = currentMethod === "By Engineer";

        if (e50Field) {
          if (isByEngineer) {
            e50Field.classList.remove("disabled-input");
            e50Field.setAttribute("contenteditable", "true");
          } else {
            e50Field.classList.add("disabled-input");
            e50Field.setAttribute("contenteditable", "false");
            // For non-"By Engineer" methods, show calculated energy value
            e50Field.textContent = getCurrentValue("j_50") || "0.00";
          }
        }

        // Heating system field visibility based on equipment type
        const isFossilFuel =
          currentSystemType === "Gas" || currentSystemType === "Oil";
        const isGas = currentSystemType === "Gas";

        // D52 slider (COP/Efficiency %) - ghosted for fossil fuels
        const d52Slider = document.querySelector('[data-field-id="d_52"]');
        if (d52Slider) {
          if (isFossilFuel) {
            d52Slider.classList.add("disabled-input");
            d52Slider.disabled = true;
          } else {
            d52Slider.classList.remove("disabled-input");
            d52Slider.disabled = false;
            // Update slider range based on system type
            if (currentSystemType === "Electric") {
              d52Slider.min = 90;
              d52Slider.max = 100;
              d52Slider.step = 1;
            } else {
              // Heatpump
              d52Slider.min = 100;
              d52Slider.max = 450;
              d52Slider.step = 10;
            }
          }
        }

        // K52 field (AFUE) - only editable for fossil fuels
        const k52Field = document.querySelector('[data-field-id="k_52"]');
        if (k52Field) {
          if (isFossilFuel) {
            k52Field.classList.remove("disabled-input");
            k52Field.setAttribute("contenteditable", "true");
          } else {
            k52Field.classList.add("disabled-input");
            k52Field.setAttribute("contenteditable", "false");
          }
        }

        // E51 field (Gas volume) - only shows values for Gas
        const e51Field = document.querySelector('[data-field-id="e_51"]');
        if (e51Field) {
          if (isGas) {
            e51Field.classList.remove("disabled-input");
          } else {
            e51Field.classList.add("disabled-input");
          }
        }

        // Reference Mode field locking
        if (isReferenceMode) {
          // In Reference Mode, only d_49, d_51, and appropriate input fields should be editable
          const d49Field = document.querySelector('[data-field-id="d_49"]');
          const d51Field = document.querySelector('[data-field-id="d_51"]');
          const d53Slider = document.querySelector('[data-field-id="d_53"]');

          if (d49Field) {
            d49Field.classList.remove("reference-locked");
            d49Field.disabled = false;
          }
          if (d51Field) {
            d51Field.classList.remove("reference-locked");
            d51Field.disabled = false;
          }
          if (d53Slider) {
            d53Slider.classList.remove("reference-locked");
            d53Slider.disabled = false;
          }

          // e_49, e_50, d_52, k_52 editability already handled above based on method/system
        } else {
          // In Design Mode, remove all reference locks
          document.querySelectorAll(".reference-locked").forEach((el) => {
            el.classList.remove("reference-locked");
            if (el.tagName === "SELECT" || el.tagName === "INPUT") {
              el.disabled = false;
            }
          });
        }

        addDebugMessage(
          `Field visibility updated: method=${currentMethod}, system=${currentSystemType}, e49_editable=${isUserDefined}, e50_editable=${isByEngineer}, d52_editable=${!isFossilFuel}, k52_editable=${isFossilFuel}`,
        );
      }

      function updateDisplayValues() {
        // Update current values display (mode-aware)
        document.getElementById("current_d_49").textContent = getCurrentValue("d_49");
        document.getElementById("current_e_49").textContent = getCurrentValue("e_49");
        document.getElementById("current_e_50").textContent = getCurrentValue("e_50");
        document.getElementById("current_d_63").textContent = "126 (static for test)";

        // Update reference values display
        document.getElementById("ref_d_49").textContent =
          referenceState["d_49"] || "-";
        document.getElementById("ref_e_49").textContent =
          referenceState["e_49"] || "-";
        document.getElementById("ref_e_50").textContent =
          referenceState["e_50"] || "-";
        document.getElementById("ref_j_50").textContent =
          applicationState["ref_j_50"] || "-";
        document.getElementById("ref_k_49").textContent =
          applicationState["ref_k_49"] || "-";

        // Update visible field values in the table
        const fieldsToUpdate = [
          "h_49",
          "i_49",
          "h_50",
          "i_50",
          "j_50",
          "k_49",
          "e_52",
          "j_51",
          "e_53",
          "j_52",
          "j_53",
          "j_54",
          "e_51",
          "k_51",
          "k_54",
          "n_49",
          "n_50",
          "n_52",
          "n_53",
        ];
        fieldsToUpdate.forEach((fieldId) => {
          const field = document.querySelector(`[data-field-id="${fieldId}"]`);
          if (field) {
            field.textContent = getCurrentValue(fieldId) || "0.00";
          }
        });

        // Update slider displays
        const d52Display = document.querySelector('[data-display-for="d_52"]');
        if (d52Display) {
          d52Display.textContent = getCurrentValue("d_52") + "%";
        }

        const d53Display = document.querySelector('[data-display-for="d_53"]');
        if (d53Display) {
          d53Display.textContent = getCurrentValue("d_53") + "%";
        }

        // Update E49 and E50 input fields with calculated values when appropriate
        const currentMethod = getCurrentValue("d_49");
        const e49Field = document.querySelector('[data-field-id="e_49"]');
        const e50Field = document.querySelector('[data-field-id="e_50"]');

        // E49: Show calculated lpppd when not "User Defined"
        if (e49Field && currentMethod !== "User Defined") {
          e49Field.textContent = getCurrentValue("h_49") || "0.00";
        }

        // E50: Show calculated energy when not "By Engineer"
        if (e50Field && currentMethod !== "By Engineer") {
          e50Field.textContent = getCurrentValue("j_50") || "0.00";
        }
      }

      function updateModeIndicator() {
        const modeIndicator = document.getElementById("modeIndicator");
        const toggleBtn = document.getElementById("toggleReferenceBtn");

        if (isReferenceMode) {
          modeIndicator.textContent = "Reference Mode";
          modeIndicator.className = "ms-2 badge bg-warning";
          toggleBtn.textContent = "Show Design";
          toggleBtn.className = "btn btn-primary";
        } else {
          modeIndicator.textContent = "Design Mode";
          modeIndicator.className = "ms-2 badge bg-primary";
          toggleBtn.textContent = "Show Reference";
          toggleBtn.className = "btn btn-danger";
        }
      }

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", function () {
        addDebugMessage("Initializing Section 07 Dual-Engine Test...");

        // Initial calculations
        calculateWaterUse("application");
        calculateWaterUse("reference");
        updateFieldVisibility();
        updateDisplayValues();
        updateModeIndicator();

        // Water method dropdown handler
        const d49Dropdown = document.querySelector('[data-field-id="d_49"]');
        if (d49Dropdown) {
          d49Dropdown.addEventListener("change", function (e) {
            const method = e.target.value;
            setValue("d_49", method); // This will save to current mode
            calculateWaterUse(isReferenceMode ? "reference" : "application");
            updateDisplayValues();
            updateFieldVisibility();
          });
        }

        // E49 field handler with Enter key fix
        const e49Field = document.querySelector('[data-field-id="e_49"]');
        if (e49Field) {
          e49Field.addEventListener("blur", function (e) {
            const value = e.target.textContent.trim();
            setValue("e_49", value);
            calculateWaterUse(isReferenceMode ? "reference" : "application");
            updateDisplayValues();
          });

          // Fix Enter key behavior
          e49Field.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              this.blur();
            }
          });
        }

        // E50 field handler with Enter key fix
        const e50Field = document.querySelector('[data-field-id="e_50"]');
        if (e50Field) {
          e50Field.addEventListener("blur", function (e) {
            const value = e.target.textContent.trim();
            setValue("e_50", value);
            calculateWaterUse(isReferenceMode ? "reference" : "application");
            updateDisplayValues();
          });

          // Fix Enter key behavior
          e50Field.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              this.blur();
            }
          });
        }

        // Mode toggle handler
        const toggleBtn = document.getElementById("toggleReferenceBtn");
        toggleBtn.addEventListener("click", function () {
          // Save current mode's state before switching
          saveCurrentModeFromDOM();

          // Switch mode
          isReferenceMode = !isReferenceMode;

          // Load new mode's state to DOM
          loadCurrentModeToDOM();

          // Update UI for new mode
          updateModeIndicator();
          updateFieldVisibility();
          updateDisplayValues();

          addDebugMessage(
            `Mode switched to: ${isReferenceMode ? "Reference" : "Design"}`,
          );
        });

        // DHW Energy Source dropdown handler (d_51)
        const d51Dropdown = document.querySelector('[data-field-id="d_51"]');
        if (d51Dropdown) {
          d51Dropdown.addEventListener("change", function (e) {
            const systemType = e.target.value;
            setValue("d_51", systemType); // Save to current mode

            // Update d_52 slider range and default value based on system type
            const d52Slider = document.querySelector('[data-field-id="d_52"]');
            let newValue = 300;

            if (systemType === "Gas" || systemType === "Oil") {
              newValue = 90; // Set to typical AFUE range
            } else if (systemType === "Electric") {
              newValue = 100;
              if (d52Slider) {
                d52Slider.min = 90;
                d52Slider.max = 100;
                d52Slider.step = 1;
              }
            } else {
              // Heatpump
              newValue = 300;
              if (d52Slider) {
                d52Slider.min = 100;
                d52Slider.max = 450;
                d52Slider.step = 10;
              }
            }

            setValue("d_52", newValue.toString()); // Save to current mode
            if (d52Slider) d52Slider.value = newValue;

            calculateWaterUse(isReferenceMode ? "reference" : "application");
            updateDisplayValues();
            updateFieldVisibility();
          });
        }

        // D52 slider handler (COP/Efficiency %)
        const d52Slider = document.querySelector('[data-field-id="d_52"]');
        if (d52Slider) {
          d52Slider.addEventListener("input", function (e) {
            const value = e.target.value;
            setValue("d_52", value);
            // Immediately update the display span
            const d52Display = document.querySelector('[data-display-for="d_52"]');
            if (d52Display) {
              d52Display.textContent = value + "%";
            }
            updateDisplayValues();
          });

          d52Slider.addEventListener("change", function (e) {
            calculateWaterUse(isReferenceMode ? "reference" : "application");
            updateDisplayValues();
          });
        }

        // D53 slider handler (DWHR Efficiency %)
        const d53Slider = document.querySelector('[data-field-id="d_53"]');
        if (d53Slider) {
          d53Slider.addEventListener("input", function (e) {
            const value = e.target.value;
            setValue("d_53", value);
            // Immediately update the display span
            const d53Display = document.querySelector('[data-display-for="d_53"]');
            if (d53Display) {
              d53Display.textContent = value + "%";
            }
            updateDisplayValues();
          });

          d53Slider.addEventListener("change", function (e) {
            calculateWaterUse(isReferenceMode ? "reference" : "application");
            updateDisplayValues();
          });
        }

        // K52 field handler (AFUE) with Enter key fix
        const k52Field = document.querySelector('[data-field-id="k_52"]');
        if (k52Field) {
          k52Field.addEventListener("blur", function (e) {
            const value = e.target.textContent.trim();
            setValue("k_52", value);
            calculateWaterUse(isReferenceMode ? "reference" : "application");
            updateDisplayValues();
          });

          // Fix Enter key behavior
          k52Field.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              this.blur();
            }
          });
        }

        // Test button handlers
        document.getElementById("testBtn1").addEventListener("click", function () {
          const dropdown = document.querySelector('[data-field-id="d_49"]');
          dropdown.value = "PHPP Method";
          dropdown.dispatchEvent(new Event("change"));
          addDebugMessage("Test: Changed water method to PHPP Method");
        });

        document.getElementById("testBtn2").addEventListener("click", function () {
          const field = document.querySelector('[data-field-id="e_49"]');
          field.textContent = "50.00";
          field.dispatchEvent(new Event("blur"));
          addDebugMessage("Test: Changed user defined water use to 50.00");
        });

        document.getElementById("testBtn3").addEventListener("click", function () {
          const dropdown = document.querySelector('[data-field-id="d_49"]');
          dropdown.value = "By Engineer";
          dropdown.dispatchEvent(new Event("change"));
          addDebugMessage("Test: Changed water method to By Engineer");
        });

        document.getElementById("testBtn4").addEventListener("click", function () {
          const field = document.querySelector('[data-field-id="e_50"]');
          field.textContent = "15000.00";
          field.dispatchEvent(new Event("blur"));
          addDebugMessage("Test: Changed by engineer water use to 15000 kWh");
        });

        document.getElementById("testBtn5").addEventListener("click", function () {
          const dropdown = document.querySelector('[data-field-id="d_51"]');
          dropdown.value = "Gas";
          dropdown.dispatchEvent(new Event("change"));
          addDebugMessage("Test: Changed energy source to Gas");
        });

        document.getElementById("testBtn6").addEventListener("click", function () {
          const dropdown = document.querySelector('[data-field-id="d_51"]');
          dropdown.value = "Heatpump";
          dropdown.dispatchEvent(new Event("change"));
          addDebugMessage("Test: Changed energy source to Heatpump");
        });

        document.getElementById("testBtn7").addEventListener("click", function () {
          const slider = document.querySelector('[data-field-id="d_53"]');
          slider.value = "42";
          setValue("d_53", "42");
          calculateWaterUse(isReferenceMode ? "reference" : "application");
          updateDisplayValues();
          addDebugMessage("Test: Changed DWHR efficiency to 42%");
        });

        document.getElementById("testBtn8").addEventListener("click", function () {
          const slider = document.querySelector('[data-field-id="d_52"]');
          slider.value = "400";
          setValue("d_52", "400");
          calculateWaterUse(isReferenceMode ? "reference" : "application");
          updateDisplayValues();
          addDebugMessage("Test: Changed COP to 4.0 (400%)");
        });

        addDebugMessage("Initialization complete");
      });
    </script>
  </body>
</html>
