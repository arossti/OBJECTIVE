<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEUI 4.011 Calculator</title>
    <meta name="description" content="Calculate Total Energy Use Intensity & Thermal Energy Demand Intensity for buildings">
    
    <!-- CSS Resources -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Direct style override for select elements -->
    <style>
        select, option, .form-select, select.form-select {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 
                        "Helvetica Neue", Arial, sans-serif !important;
            /* Force sans-serif as fallback */
            font-family: sans-serif !important;
        }
    </style>
    
    <link href="4011-styles.css" rel="stylesheet">
    
    <!-- Core Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Calculator module that depends on everything else - soon to be removed as all calcs except cooling occur in sections files -->
    <script src="4011-Calculator.js"></script>
    
    <!-- Initialize everything -->
    <script src="4011-init.js"></script>
    
    <!-- Section modules (from Index-Includes.js) -->
    <!-- Section 01: Key Values -->
    <script src="sections/4011-Section01.js"></script>
    <!-- Section 02: Building Information -->
    <script src="sections/4011-Section02.js"></script>
    <!-- Section 03: Climate Calculations -->
    <script src="sections/4011-Section03.js"></script>
    <!-- Section 04: Actual vs. Target Energy & Carbon -->
    <script src="sections/4011-Section04.js"></script>
    <!-- Section 05: CO2e Emissions -->
    <script src="sections/4011-Section05.js"></script>
    <!-- Section 06: Renewable Energy -->
    <script src="sections/4011-Section06.js"></script>
    <!-- Section 07: Water Use -->
    <script src="sections/4011-Section07.js"></script>
    <!-- Section 08: Indoor Air Quality -->
    <script src="sections/4011-Section08.js"></script>
    <!-- Section 09: Occupant + Internal Gains -->
    <script src="sections/4011-Section09.js"></script>
    <!-- Section 10: Radiant Gains -->
    <script src="sections/4011-Section10.js"></script>
    <!-- Section 11: Transmission Losses -->
    <script src="sections/4011-Section11.js"></script>
    <!-- Section 12: Volume and Surface Metrics -->
    <script src="sections/4011-Section12.js"></script>
    <!-- Section 13: Mechanical Loads -->
    <script src="sections/4011-Section13.js"></script>
    <!-- Section 14: TEDI & TELI -->
    <script src="sections/4011-Section14.js"></script>
    <!-- Section 15: TEUI -->
    <script src="sections/4011-Section15.js"></script>
    <!-- Section 16: Sankey Diagram -->
    <script src="sections/4011-Section16.js"></script>
    <!-- Section 17: Dependency Graph -->
    <script src="sections/4011-Section17.js"></script>
    <!-- Section 18: Notes -->
    <script src="sections/4011-Section18.js"></script>
    
    <!-- Core data definitions first -->
    <script src="4011-FieldManager.js"></script>
    <!-- State management -->
    <script src="4011-StateManager.js"></script>
    <script src="4011-SectionIntegrator.js"></script>
    
    <!-- UI components that depend on definitions and state -->
    <script src="4011-ComponentBridge.js"></script>
    <script src="4011-ExcelLocationHandler.js"></script>
    <script src="4011-FileHandler.js"></script>
    <script src="4011-Dependency.js"></script>
</head>
<body>
    <!-- Main container -->
    <div class="col-lg-12 mx-auto p-4 py-md-5">
        <!-- Header -->
        <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
            <a href="https://openbuilding.ca" class="text-dark text-decoration-none">
                <img src="assets/image041.png" class="logo" title="OBJECTIVE Logo" alt="OBJECTIVE 4.011 TEUI Calculator"/>
            </a>
            <div class="ms-auto text-end">
                <h1 class="mb-0 fs-4">Simple Energy and Carbon Modelling <br> TEUI v.4.011 | for Canadian Projects</h1>
            </div>
        </header>

        <!-- Action buttons row -->
        <div class="row button-row mb-2">
            <div class="col-md-7">
                <p class="fs-5 mb-0">The early-stage modelling & validation tool with code-based references.</p>
            </div>
            <div class="col-md-5 text-end">
                <button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#disclaimerModal">
                    <i class="bi bi-info-circle"></i> Disclaimer
                </button>
                <div class="btn-group d-inline-block">
                    <!-- Main button (remains Download Report) -->
                    <button id="downloadReport" class="btn btn-primary">
                        <i class="bi bi-download"></i> Download Report (PDF)
                    </button>
                    <!-- Dropdown Toggle -->
                    <button class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Toggle Dropdown</span>
                    </button>
                    <!-- Dropdown Menu -->
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="import-data-btn"><i class="bi bi-upload me-2"></i>Import Data (Excel/CSV)</a></li>
                        <li><a class="dropdown-item" href="#" id="export-data-btn"><i class="bi bi-save me-2"></i>Export User Data (CSV)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="downloadReport">Download Report (PDF)</a></li>
                        <li><a class="dropdown-item" href="#" id="teui-factsheet">TEUI Factsheet (PDF)</a></li>
                        <li><a class="dropdown-item" href="#" id="tedi-factsheet">TEDI Factsheet (PDF)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="export-excel"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Export All Data (Excel)</a></li>
                    </ul>
                </div>
                <!-- Hidden File Input for Import -->
                <input type="file" id="excel-file-input" accept=".xlsx, .xls, .csv" style="display: none;">
            </div>
        </div>

        <!-- App wrapper - this is the new wrapper div -->
        <div id="app-wrapper">
            <!-- Calculator container -->
            <div id="calculator-container">
                <!-- The HTML for the Key Values section should be: -->
                <div id="keyValues" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-key-fill"></i></span>
                        SECTION 1. Key Values
                        <div class="ms-auto d-flex align-items-center">
                            <button id="expand-collapse-all" class="btn btn-sm btn-link text-white me-2">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                            <button class="layout-toggle-btn">
                                <i class="bi bi-arrow-right-circle"></i>
                            </button>
                        </div>
                    </div>
                    <div class="section-content">
                        <!-- Key Values content will be generated by FieldManager using Section01.js -->
                        <div data-render-section="keyValues"></div>
                    </div>
                </div>
                
                <!-- Spacer to maintain consistent gap - this prevents scrolling under Key Values -->
                <div class="tab-spacer"></div>
                
                <!-- Tab container for horizontal layout - positioned immediately after keyValues -->
                <div class="tab-container">
                    <!-- Tabs will be generated by JavaScript -->
                </div>
                
                <!-- Section spacer to maintain proper distance between Key Values and active section -->
                <div id="section-spacer" class="section-spacer"></div>

                <!-- Section 2: Building Information -->
                <div id="buildingInfo" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-info-circle"></i></span>
                        SECTION 2. Building Information
                    </div>
                    <div class="section-content">
                        <div data-render-section="buildingInfo"></div>
                    </div>
                </div>

                <!-- Section 3: Climate Calculations -->
                <div id="climateCalculations" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-thermometer-half"></i></span>
                        SECTION 3. Climate Calculations
                        <div class="section-controls">
                            <!-- Add Excel loader controls -->
                            <div class="excel-loader">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="selectExcelBtn">
                                    <i class="bi bi-file-earmark-excel"></i> Load Locations
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm d-none" id="applyExcelBtn">
                                    <i class="bi bi-check-lg"></i> Apply Data
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" id="debugExcelBtn">
                                    <i class="bi bi-bug"></i> Debug
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" id="showWeatherDataBtn" data-bs-toggle="modal" data-bs-target="#weatherDataModal">
                                    <i class="bi bi-cloud-sun"></i> More Weather Data
                                </button>
                                <span id="feedback-area" style="color: #0dcaf0; font-size: 0.9rem; margin-left: 10px;"></span>
                            </div>
                        </div>
                    </div>
                    <div class="section-content">
                        <!-- Rendered section content will be inserted here -->
                        <div data-render-section="climateCalculations"></div>
                    </div>
                </div>

                <!-- Section 4: Actual vs. Target Energy & Carbon -->
                <div id="actualTargetEnergy" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-bullseye"></i></span>
                        SECTION 4. Actual vs. Target Energy & Carbon
                    </div>
                    <div class="section-content">
                        <div data-render-section="actualTargetEnergy"></div>
                    </div>
                </div>

                <!-- Section 5: CO2e Emissions -->
                <div id="emissions" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-cloud-upload"></i></span>
                        SECTION 5. CO2e Emissions
                    </div>
                    <div class="section-content">
                        <div data-render-section="emissions"></div>
                    </div>
                </div>

                <!-- Section 6: Renewable Energy -->
                <div id="onSiteEnergy" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-sun"></i></span>
                        SECTION 6. Renewable Energy
                    </div>
                    <div class="section-content">
                        <div data-render-section="onSiteEnergy"></div>
                    </div>
                </div>

                <!-- Section 7: Water Use -->
                <div id="waterUse" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-droplet"></i></span>
                        SECTION 7. Water Use
                    </div>
                    <div class="section-content">
                        <div data-render-section="waterUse"></div>
                    </div>
                </div>

                <!-- Section 8: Indoor Air Quality -->
                <div id="indoorAirQuality" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-lungs"></i></span>
                        SECTION 8. Indoor Air Quality
                    </div>
                    <div class="section-content">
                        <div data-render-section="indoorAirQuality"></div>
                    </div>
                </div>

                <!-- Section 9: Occupant + Internal Gains -->
                <div id="occupantInternalGains" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-cup-hot"></i></span>
                        SECTION 9. Occupant + Internal Gains
                    </div>
                    <div class="section-content">
                        <div data-render-section="occupantInternalGains"></div>
                    </div>
                </div>

                <!-- Section 10: Radiant Gains -->
                <div id="envelopeRadiantGains" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-box-arrow-in-down-right"></i></span>
                        SECTION 10. Radiant Gains
                    </div>
                    <div class="section-content">
                        <div data-render-section="envelopeRadiantGains"></div>
                    </div>
                </div>

                <!-- Section 11: Transmission Losses -->
                <div id="envelopeTransmissionLosses" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-box-arrow-up-right"></i></span>
                        SECTION 11. Transmission Losses
                    </div>
                    <div class="section-content">
                        <div data-render-section="envelopeTransmissionLosses"></div>
                    </div>
                </div>

                <!-- Section 12: Volume and Surface Metrics -->
                <div id="volumeSurfaceMetrics" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-box"></i></span>
                        SECTION 12. Volume and Surface Metrics
                    </div>
                    <div class="section-content">
                        <div data-render-section="volumeSurfaceMetrics"></div>
                    </div>
                </div>

                <!-- Section 13: Mechanical Loads -->
                <div id="mechanicalLoads" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-house-gear"></i></span>
                        SECTION 13. Mechanical Loads
                    </div>
                    <div class="section-content">
                        <div data-render-section="mechanicalLoads"></div>
                    </div>
                </div>

                <!-- Section 14: TEDI & TELI -->
                <div id="tediSummary" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-fire"></i></span>
                        SECTION 14. TEDI & TELI
                    </div>
                    <div class="section-content">
                        <div data-render-section="tediSummary"></div>
                    </div>
                </div>

                <!-- Section 15: TEUI -->
                <div id="teuiSummary" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-outlet"></i></span>
                        SECTION 15. TEUI
                    </div>
                    <div class="section-content">
                        <div data-render-section="teuiSummary"></div>
                    </div>
                </div>

                <!-- Section 16: Sankey Diagram -->
                <div id="sankeyDiagram" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-sliders2"></i></span>
                        SECTION 16. Sankey Diagram
                    </div>
                    <div class="section-content">
                        <div data-render-section="sankeyDiagram"></div>
                    </div>
                </div>

                <!-- Section 17: Dependency Graph -->
                <div id="dependencyDiagram" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-link-45deg"></i></span>
                        SECTION 17. Dependency Graph
                    </div>
                    <div class="section-content">
                        <!-- Containers for Dependency Graph Components -->
                        <div class="dependency-graph-controls-wrapper mb-3"></div> <!-- Wrapper for filters/controls -->
                        <div class="dependency-graph-info-wrapper mb-3"></div>    <!-- Wrapper for info panel -->
                        <div class="dependency-graph-container" style="height: 600px; width: 100%; border: 1px solid #eee;">
                            <!-- SVG will be injected here by 4011-Dependency.js -->
                        </div>
                    </div>
                </div>

                <!-- Section 18: Notes -->
                <div id="notes" class="section">
                    <div class="section-header">
                        <span class="section-icon"><i class="bi bi-info-square"></i></span>
                        SECTION 18. Notes
                    </div>
                    <div class="section-content">
                        <div data-render-section="notes"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="pt-5 mt-5 text-muted border-top">
            <div class="row">
                <div class="col-md-6">
                    <p>Based on the framework by <a href="https://OpenBuilding.ca">OpenBuilding.ca</a> - Version 4.011</p>
                </div>
                <div class="col-md-6 text-end">
                    <p>TEUI 4.011 Calculator</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal for disclaimer -->
    <div class="modal fade" id="disclaimerModal" tabindex="-1" aria-labelledby="disclaimerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning bg-opacity-25">
                    <h5 class="modal-title" id="disclaimerModalLabel">Using this calculator</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This tool helps you calculate the Total Energy Use Intensity (TEUI) & Thermal Energy Demand Intensity (TEDI) of a building or home.</p>
                    <p>Simply enter your information (Blue inputs). Press the tab key on your keyboard to jump to the next input field and enter values for your building or project.</p>
                    <p>Default values exist to speed up the process, but you must over-write them with relevant values from your own project. Results will be calculated automatically (Black text).</p>
                    <hr>
                    <p><strong>Disclaimer:</strong> Our team has made every effort to have OBJECTIVE's Targeted Energy Use match real-world values by reviewing a wide range of building types and utility bills, but no energy model can accurately predict energy use due to hundreds of influences beyond our ability to model, from exact weather in a given year, to user behaviours, to actual commissioned equipment efficiencies. This static modelling tool aims to set Targets in a consistent way to compare against Reference cases, but our experience has shown that with correct use, we can arrive at values very close to real-world, utility-bill values for total energy use.</p>
                    <p>Click the download button to generate a complete OBJECTIVE TEUIv.4.011 Report. Only for Canadian projects.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather Data Modal -->
    <div class="modal fade" id="weatherDataModal" tabindex="-1" aria-labelledby="weatherDataModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="weatherDataModalLabel">Weather Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="weatherDataContent" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;">Select a province and city to view weather data.</pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global modal fix script -->
    <script>
        // Simplified fix for lingering modal backdrops
        document.addEventListener('DOMContentLoaded', function() {
            // This single event listener handles all modals, but only cleans up when needed
            document.body.addEventListener('hidden.bs.modal', function() {
                // Use a short timeout to ensure Bootstrap has completed its operations
                setTimeout(function() {
                    // Only clean up if there are backdrops but no visible modals
                    if (document.querySelectorAll('.modal-backdrop').length > 0 && 
                        !document.querySelector('.modal.show')) {
                        
                        console.log('Cleaning up lingering modal backdrops');
                        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }
                }, 150);
            });
        });
    </script>

    <!-- JavaScript resources -->
    <!-- Bootstrap already loaded in head -->
    
    <!-- Initialize components on page load -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize state manager
            if (TEUI.StateManager) {
                TEUI.StateManager.initialize();
                TEUI.StateManager.loadState();
            }
            
            // Initialize FieldManager to generate content for all sections
            if (TEUI.FieldManager) {
                TEUI.FieldManager.renderAllSections();
            }
            
            // Initialize Component Bridge
            if (TEUI.ComponentBridge) {
                TEUI.ComponentBridge.initAll();
            }
            
            // Initialize Calculator
            if (TEUI.Calculator) {
                TEUI.Calculator.initialize();
                
                // Calculate all values after initialization
                setTimeout(function() {
                    TEUI.Calculator.calculateAll();
                }, 500);
            }
            
            console.log('TEUI Calculator 4.011 initialization complete');
        });
    </script>
</body>
</html>
